import{O as e,a as t,V as s,W as o,P as i,S as n,A as r,b as a,C as l,F as c,c as h,H as u,D as d,R as p,d as m,M as g,e as y,f,g as v,h as b,L as k,i as w,N as M,j as x,G as S,B as C,k as D,I,l as B,m as E,n as R,o as L,p as T,q as P,r as z,s as A,t as H,u as O,T as F,v as Y,w as V}from"./three-D4D5j67r.js";import{g as _}from"./rapier-DeOqvUG4.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const $={blockTypes:{AIR:0,BEDROCK:1,DIRT:2,STONE:3,IRON_ORE:4,GOLD_ORE:5,DIAMOND_ORE:6},blockProperties:{0:{hp:0,density:0,hardness:0,adhesion:!1,color:0,lootType:null,lootValue:0,lootMin:0,lootMax:0,lootExtraChance:0,lootChance:0,gripForce:0},1:{hp:1/0,density:10,hardness:1/0,adhesion:!0,color:1710618,lootType:null,lootValue:0,lootMin:0,lootMax:0,lootExtraChance:0,lootChance:0,gripForce:1},2:{hp:20,density:1,hardness:.5,adhesion:!0,color:9127187,lootType:"gold",lootValue:1,lootMin:0,lootMax:1,lootExtraChance:.1,lootChance:.01,gripForce:.5},3:{hp:50,density:2,hardness:1.5,adhesion:!0,color:8421504,lootType:"gold",lootValue:2,lootMin:1,lootMax:2,lootExtraChance:.3,lootChance:.01,gripForce:1},4:{hp:75,density:3,hardness:2,adhesion:!0,color:13935988,lootType:"gold",lootValue:5,lootMin:2,lootMax:4,lootExtraChance:.5,lootChance:.01,gripForce:1},5:{hp:60,density:4,hardness:1.8,adhesion:!0,color:16766720,lootType:"gold",lootValue:10,lootMin:5,lootMax:5,lootExtraChance:0,lootChance:.01,gripForce:1},6:{hp:100,density:3.5,hardness:3,adhesion:!0,color:65535,lootType:"gem",lootValue:25,lootMin:10,lootMax:10,lootExtraChance:0,lootChance:.01,gripForce:1}}},N={pickaxe:{baseDamage:15,stoneMultiplier:1.5,dirtMultiplier:.5,inputMode:"tap",fuelCost:1,multiTouchAllowed:!0},shovel:{baseDamage:15,stoneMultiplier:.5,dirtMultiplier:1.5,inputMode:"tap",fuelCost:1,multiTouchAllowed:!0},drill:{baseDamage:5,stoneMultiplier:1,dirtMultiplier:1,inputMode:"hold",tickRate:100,fuelCost:.5,multiTouchAllowed:!1}},G={damage:{baseCost:50,costMultiplier:1.5,damageMultiplier:1.25},drone:{cost:100},turboFuel:{cost:30}},X={gravity:-20},W={initialHeight:20,chunkHeight:6,minX:-1.5,maxX:1.5,minZ:-1.5,maxZ:1.5},j={fallSpeed:5,bounceDuration:.6,bounceHeight:.1,impactDamageMultiplier:5},U={wobblePerDamage:.5,wobbleDecayRate:.5,shockwaveReach:1,shockwaveDecay:.5},Q={camera:{frustumSize:8,portraitFitMargin:.3,near:.1,far:1e3,rotationSnap:Math.PI/2},renderer:{antialias:!0,powerPreference:"high-performance",alpha:!1,maxPixelRatio:2,shadowMapEnabled:!0,toneMappingExposure:1,bloomExposure:1.5},lighting:{backgroundColor:1315618,fogDensity:.04,hemispheric:{skyColor:11657727,groundColor:0,intensity:1.1},sun:{color:16773597,intensity:1.25,position:{x:50,y:100,z:50},shadowMapSize:2048,shadowBias:-25e-5,shadowNormalBias:.02,shadowCamera:{near:1,far:260,left:-25,right:25,top:25,bottom:-25}},rim:{color:8956671,intensity:.35,position:{x:-40,y:35,z:-60}}},blockRendering:{geometrySize:1,roundedBoxRadius:.03},toonShader:{enabled:!1,toonSteps:3}},Z={swipeHorizontal:{threshold:240,maxVerticalRatio:.5,minVelocity:.3,maxDuration:400},swipeVertical:{maxHorizontalRatio:.5,sensitivity:.005},trackpadSwipe:{enabled:!0,threshold:50,sensitivity:1,resetTime:30},gestureDetection:{decisionDistance:20,decisionTime:150},hold:{threshold:200},tap:{maxDistance:15}},q={gold:0,gems:0,depth:0,maxDepth:0,fuel:100,maxFuel:100,damageLevel:0,toolDamageMultiplier:1,hasDrone:!1,turboFuel:100,maxTurboFuel:100,turboActive:!1,debugVisuals:!1,currentTool:"pickaxe"},K={pool:{initialSize:50,maxPoolSize:200,expandAmount:20},geometry:{boxSize:.1},debris:{gravity:-15,velocityRange:4,velocityYMin:2,velocityYMax:6,scaleMin:.5,scaleMax:1,lifeMin:.5,lifeMax:1},hit:{velocityRange:2,velocityYMin:1,velocityYMax:4,scaleMin:.3,scaleMax:.6,lifeMin:.3,lifeMax:.6},collect:{count:3,velocity:3,velocityY:4,life:.6},rotationSpeeds:{x:10,y:10}},J={damageNumbers:{normalSize:24,critSize:36,normalColor:"#ffffff",critColor:"#ffff00",duration:1.5,floatSpeed:80},hpBars:{width:60,height:8,borderRadius:4,cornerRadius:2,showDuration:2,hideDuration:.5,thresholdHigh:.7,thresholdMedium:.3,colorHigh:"#00ff00",colorMedium:"#ffff00",colorLow:"#ff0000"},sparkles:{count:6,gravity:-5,velocityRange:3,velocityYMin:2,velocityYMax:5,life:.7,lifeVariation:.3,scaleMin:.05,scaleMax:.15,rotationSpeedX:5,rotationSpeedZ:5}},ee={hitRadius:.5,resourceHitRadius:.5},te={airWireframeWindow:50},se={maxDepthRange:6};function oe(e){return{hp:e.hp,density:e.density,hardness:e.hardness,adhesion:e.adhesion,color:e.color,lootType:e.lootType,lootValue:e.lootValue,lootMin:e.lootMin,lootMax:e.lootMax,lootExtraChance:e.lootExtraChance,lootChance:e.lootChance,gripForce:e.gripForce}}const ie=$.blockTypes,ne={};for(const[Ms,xs]of Object.entries($.blockProperties))ne[parseInt(Ms)]=oe(xs);const re=N,ae=G,le=X,ce=W,he=U,ue=Q.camera,de=Q.renderer,pe=Q.lighting,me=Q.blockRendering,ge=Q.toonShader,ye=Z,fe=q,ve=K,be=J,ke=ee,we=te,Me=se;class xe{camera;pivot;targetYaw=Math.PI/4;currentYaw=Math.PI/4;isRotating=!1;pivotY=0;targetPivotY=0;baseFrustumSize=ue.frustumSize;frustumSize=ue.frustumSize;targetScrollY=0;currentScrollY=0;isScrolling=!1;maxScrollDepth=2;rotationVelocity=0;ROTATION_SPRING=220;ROTATION_DAMPING=.65;constructor(s){this.frustumSize=this.computeFrustumSize(s);const o=this.frustumSize*s/2,i=this.frustumSize/2;this.camera=new e(-o,o,i,-i,ue.near,ue.far),this.pivot=new t,this.pivot.add(this.camera);const n=Math.PI/5;this.camera.position.set(0,20*Math.sin(n),20*Math.cos(n)),this.camera.lookAt(0,0,0),this.pivot.rotation.y=this.currentYaw}computeFrustumSize(e){if(e>=1)return this.baseFrustumSize;const t=(ce.maxX-ce.minX+1)*me.geometrySize*(1+2*ue.portraitFitMargin)/Math.max(e,1e-4);return Math.max(this.baseFrustumSize,t)}get pivotObject(){return this.pivot}rotateStep(e){const t=ue.rotationSnap;this.targetYaw+=e*t,this.isRotating=!0}rotate(e){this.targetYaw-=2*e,this.isRotating=!0}snapToGrid(){const e=ue.rotationSnap,t=Math.PI/4;this.targetYaw=t+Math.round((this.targetYaw-t)/e)*e,this.isRotating=!0}setRotation(e){this.targetYaw=e,this.isRotating=!0}setDepth(e,t){this.targetPivotY=-e,void 0!==t&&(this.maxScrollDepth=t);const s=this.targetPivotY+this.targetScrollY,o=Math.max(-this.maxScrollDepth,Math.min(0,s));this.targetScrollY=o-this.targetPivotY,this.isScrolling=!0}scrollDepth(e){this.targetScrollY+=e;const t=this.targetPivotY+this.targetScrollY,s=Math.max(-this.maxScrollDepth,Math.min(0,t));this.targetScrollY=s-this.targetPivotY,this.isScrolling=!0}getDepth(){return-this.pivotY}handleFloatingOrigin(){if(Math.abs(this.pivotY)>500){const e=this.pivotY;return this.pivotY=0,this.targetPivotY=0,this.pivot.position.y=0,{offset:e,needsReset:!0}}return{offset:0,needsReset:!1}}update(e=1/60){if(this.isRotating){const t=this.targetYaw-this.currentYaw,s=t*this.ROTATION_SPRING;this.rotationVelocity+=s*e,this.rotationVelocity*=Math.pow(this.ROTATION_DAMPING,60*e),this.currentYaw+=this.rotationVelocity*e,Math.abs(t)<.01&&Math.abs(this.rotationVelocity)<.01&&(this.currentYaw=this.targetYaw,this.rotationVelocity=0,this.isRotating=!1),this.pivot.rotation.y=this.currentYaw}if(this.isScrolling){const e=this.targetScrollY-this.currentScrollY,t=this.targetPivotY-this.pivotY;let s=!1;Math.abs(t)<.01?this.pivotY=this.targetPivotY:(this.pivotY+=.1*t,s=!0),Math.abs(e)<.01?this.currentScrollY=this.targetScrollY:(this.currentScrollY+=.15*e,s=!0),this.pivot.position.y=this.pivotY+this.currentScrollY,s||(this.isScrolling=!1)}}resize(e){this.frustumSize=this.computeFrustumSize(e);const t=this.frustumSize*e/2,s=this.frustumSize/2;this.camera.left=-t,this.camera.right=t,this.camera.top=s,this.camera.bottom=-s,this.camera.updateProjectionMatrix()}getCurrentYaw(){return this.currentYaw}getWorldPosition(){const e=new s;return this.camera.getWorldPosition(e),e}getWorldDirection(){const e=new s;return this.camera.getWorldDirection(e),e}}class Se{renderer;scene;cameraController;canvas;clock;animationId=0;updateCallback=null;fps=0;frameCount=0;lastFpsUpdate=0;hemiLight;sunLight;rimLight;constructor(){if(this.canvas=document.getElementById("game-canvas"),!this.canvas)throw new Error("Canvas element not found");this.renderer=new o({canvas:this.canvas,antialias:de.antialias,powerPreference:de.powerPreference,alpha:de.alpha}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,de.maxPixelRatio)),this.renderer.shadowMap.enabled=de.shadowMapEnabled,this.renderer.shadowMap.type=i,this.renderer.outputColorSpace=n,this.renderer.toneMapping=r,this.renderer.toneMappingExposure=de.toneMappingExposure,this.scene=new a,this.scene.background=new l(pe.backgroundColor);const e=window.innerWidth/window.innerHeight;this.cameraController=new xe(e),this.scene.add(this.cameraController.pivotObject),this.setupLighting(),this.scene.fog=new c(pe.backgroundColor,pe.fogDensity),this.clock=new h,window.addEventListener("resize",this.onResize.bind(this))}setupLighting(){this.hemiLight=new u(pe.hemispheric.skyColor,pe.hemispheric.groundColor,pe.hemispheric.intensity),this.scene.add(this.hemiLight),this.sunLight=new d(pe.sun.color,pe.sun.intensity),this.sunLight.position.set(pe.sun.position.x,pe.sun.position.y,pe.sun.position.z),this.sunLight.castShadow=!0,this.sunLight.shadow.mapSize.set(pe.sun.shadowMapSize,pe.sun.shadowMapSize),this.sunLight.shadow.bias=pe.sun.shadowBias,this.sunLight.shadow.normalBias=pe.sun.shadowNormalBias,this.sunLight.shadow.camera.near=pe.sun.shadowCamera.near,this.sunLight.shadow.camera.far=pe.sun.shadowCamera.far,this.sunLight.shadow.camera.left=pe.sun.shadowCamera.left,this.sunLight.shadow.camera.right=pe.sun.shadowCamera.right,this.sunLight.shadow.camera.top=pe.sun.shadowCamera.top,this.sunLight.shadow.camera.bottom=pe.sun.shadowCamera.bottom,this.scene.add(this.sunLight),this.rimLight=new d(pe.rim.color,pe.rim.intensity),this.rimLight.position.set(pe.rim.position.x,pe.rim.position.y,pe.rim.position.z),this.scene.add(this.rimLight)}setUpdateCallback(e){this.updateCallback=e}start(){this.animationId||(this.clock.start(),this.animate(0))}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=0)}animate=e=>{this.animationId=requestAnimationFrame(this.animate);const t=this.clock.getDelta();this.frameCount++,e>=this.lastFpsUpdate+1e3&&(this.fps=1e3*this.frameCount/(e-this.lastFpsUpdate),this.lastFpsUpdate=e,this.frameCount=0),this.cameraController.update(),this.updateCallback&&this.updateCallback(t),this.renderer.render(this.scene,this.cameraController.camera)};onResize(){const e=window.innerWidth,t=window.innerHeight;this.renderer.setSize(e,t),this.cameraController.resize(e/t)}add(e){this.scene.add(e)}remove(e){this.scene.remove(e)}raycast(e,t,s){const o=new p,i=new m(e/window.innerWidth*2-1,-t/window.innerHeight*2+1);return o.setFromCamera(i,this.cameraController.camera),o.intersectObjects(s,!0)}enableBloom(){this.renderer.toneMappingExposure=de.bloomExposure}disableBloom(){this.renderer.toneMappingExposure=de.toneMappingExposure}getLightParams(){return{hemiIntensity:this.hemiLight.intensity,hemiSkyColor:this.hemiLight.color.getHex(),sunIntensity:this.sunLight.intensity,sunColor:this.sunLight.color.getHex(),rimIntensity:this.rimLight.intensity,rimColor:this.rimLight.color.getHex(),exposure:this.renderer.toneMappingExposure}}setLightParams(e){void 0!==e.hemiIntensity&&(this.hemiLight.intensity=e.hemiIntensity),void 0!==e.hemiSkyColor&&this.hemiLight.color.setHex(e.hemiSkyColor),void 0!==e.sunIntensity&&(this.sunLight.intensity=e.sunIntensity),void 0!==e.sunColor&&this.sunLight.color.setHex(e.sunColor),void 0!==e.rimIntensity&&(this.rimLight.intensity=e.rimIntensity),void 0!==e.rimColor&&this.rimLight.color.setHex(e.rimColor),void 0!==e.exposure&&(this.renderer.toneMappingExposure=e.exposure)}getMetrics(){return{fps:this.fps,meshes:this.renderer.info.render.calls,triangles:this.renderer.info.render.triangles,memory:window.performance.memory?window.performance.memory.usedJSHeapSize/1048576:0}}dispose(){this.stop(),this.renderer.dispose(),window.removeEventListener("resize",this.onResize.bind(this))}}class Ce{pointers=new Map;callbacks;canvas;holdTimers=new Map;swipeRotationFired=!1;trackpadDeltaXAccum=0;lastTrackpadWheelTime=0;trackpadRotationFired=!1;boundHandlers;constructor(e,t){this.canvas=e,this.callbacks=t,this.boundHandlers={touchStart:this.onTouchStart.bind(this),touchMove:this.onTouchMove.bind(this),touchEnd:this.onTouchEnd.bind(this),mouseDown:this.onMouseDown.bind(this),mouseMove:this.onMouseMove.bind(this),mouseUp:this.onMouseUp.bind(this)},this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("wheel",this.onWheel.bind(this),{passive:!1}),this.canvas.addEventListener("touchstart",this.boundHandlers.touchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.boundHandlers.touchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.boundHandlers.touchEnd,{passive:!1}),this.canvas.addEventListener("touchcancel",this.boundHandlers.touchEnd,{passive:!1}),this.canvas.addEventListener("mousedown",this.boundHandlers.mouseDown),this.canvas.addEventListener("mousemove",this.boundHandlers.mouseMove),this.canvas.addEventListener("mouseup",this.boundHandlers.mouseUp),this.canvas.addEventListener("mouseleave",this.boundHandlers.mouseUp)}onTouchStart(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.handlePointerStart(s.identifier,s.clientX,s.clientY)}}onTouchMove(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.handlePointerMove(s.identifier,s.clientX,s.clientY)}}onTouchEnd(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const s=e.changedTouches[t];this.handlePointerEnd(s.identifier,s.clientX,s.clientY)}}mousePointerId=-1;isMouseDown=!1;onMouseDown(e){this.isMouseDown=!0,this.handlePointerStart(this.mousePointerId,e.clientX,e.clientY)}onMouseMove(e){this.isMouseDown?this.handlePointerMove(this.mousePointerId,e.clientX,e.clientY):this.callbacks.onPointerMove(this.mousePointerId,e.clientX,e.clientY)}onMouseUp(e){this.isMouseDown&&(this.isMouseDown=!1,this.handlePointerEnd(this.mousePointerId,e.clientX,e.clientY))}onWheel(e){if(e.preventDefault(),e.stopPropagation(),0!==e.deltaY&&this.callbacks.onVerticalScroll(-e.deltaY*ye.swipeVertical.sensitivity),0!==e.deltaX&&ye.trackpadSwipe.enabled){const t=Date.now();t-this.lastTrackpadWheelTime>ye.trackpadSwipe.resetTime&&(this.trackpadDeltaXAccum=0,this.trackpadRotationFired=!1),this.trackpadDeltaXAccum+=e.deltaX*ye.trackpadSwipe.sensitivity,this.lastTrackpadWheelTime=t;const s=Math.abs(this.trackpadDeltaXAccum);if(!this.trackpadRotationFired&&s>=ye.trackpadSwipe.threshold){const e=this.trackpadDeltaXAccum>0?1:-1;this.callbacks.onRotateStep(e),this.trackpadRotationFired=!0}}}handlePointerStart(e,t,s){const o=Date.now(),i={id:e,startX:t,startY:s,currentX:t,currentY:s,prevX:t,prevY:s,startTime:o,lastMoveTime:o,state:"pending",velocityX:0,velocityY:0,totalDeltaX:0,totalDeltaY:0,holdTriggered:!1};this.pointers.set(e,i),this.callbacks.onPointerDown(e,t,s),this.startHoldTimer(e,t,s)}handlePointerMove(e,t,s){const o=this.pointers.get(e);if(!o)return;const i=Date.now(),n=Math.max(1,i-o.lastMoveTime),r=t-o.prevX,a=s-o.prevY,l=.3;switch(o.velocityX=l*(r/n)+.7*o.velocityX,o.velocityY=l*(a/n)+.7*o.velocityY,o.totalDeltaX+=r,o.totalDeltaY+=a,o.prevX=o.currentX,o.prevY=o.currentY,o.currentX=t,o.currentY=s,o.lastMoveTime=i,o.state){case"pending":this.processGestureDecision(o);break;case"interact":this.callbacks.onPointerMove(e,t,s);break;case"swipe_h":this.processHorizontalSwipe(o);break;case"swipe_v":this.processVerticalSwipe(o,a)}}handlePointerEnd(e,t,s){const o=this.pointers.get(e);o&&(this.cancelHoldTimer(e),o.holdTriggered&&this.callbacks.onHoldEnd(e),this.callbacks.onPointerUp(e,t,s),this.pointers.delete(e),0===this.pointers.size&&(this.swipeRotationFired=!1))}processGestureDecision(e){const t=Date.now()-e.startTime,s=Math.abs(e.totalDeltaX),o=Math.abs(e.totalDeltaY);if(Math.sqrt(s*s+o*o)<ye.gestureDetection.decisionDistance&&t<ye.gestureDetection.decisionTime)return void this.callbacks.onPointerMove(e.id,e.currentX,e.currentY);const i=Math.sqrt(e.velocityX*e.velocityX+e.velocityY*e.velocityY),n=s>o,r=o>0?s/o:1/0;return n&&(s>0?o/s:1/0)<ye.swipeHorizontal.maxVerticalRatio&&i>ye.swipeHorizontal.minVelocity&&t<ye.swipeHorizontal.maxDuration?(e.state="swipe_h",void this.cancelHoldTimer(e.id)):!n&&r<ye.swipeVertical.maxHorizontalRatio&&o>=ye.gestureDetection.decisionDistance?(e.state="swipe_v",void this.cancelHoldTimer(e.id)):(e.state="interact",void this.callbacks.onPointerMove(e.id,e.currentX,e.currentY))}processHorizontalSwipe(e){const t=Math.abs(e.totalDeltaX),s=Math.abs(e.totalDeltaY),o=Date.now()-e.startTime;if((t>0?s/t:1/0)>1.5*ye.swipeHorizontal.maxVerticalRatio)return e.state="interact",void(this.swipeRotationFired=!1);if(Math.abs(e.velocityX)<.5*ye.swipeHorizontal.minVelocity&&t>2*ye.gestureDetection.decisionDistance)return e.state="interact",void(this.swipeRotationFired=!1);if(o>ye.swipeHorizontal.maxDuration)return e.state="interact",void(this.swipeRotationFired=!1);if(!this.swipeRotationFired&&t>=ye.swipeHorizontal.threshold){const t=e.totalDeltaX>0?-1:1;this.callbacks.onRotateStep(t),this.swipeRotationFired=!0}}processVerticalSwipe(e,t){const s=Math.abs(e.totalDeltaX),o=Math.abs(e.totalDeltaY);(o>0?s/o:1/0)>1.5*ye.swipeVertical.maxHorizontalRatio?e.state="interact":Math.abs(t)>0&&this.callbacks.onVerticalScroll(t*ye.swipeVertical.sensitivity)}startHoldTimer(e,t,s){this.cancelHoldTimer(e);const o=window.setTimeout(()=>{const t=this.pointers.get(e);if(!t)return;const s=Math.sqrt(Math.pow(t.currentX-t.startX,2)+Math.pow(t.currentY-t.startY,2));("pending"===t.state||"interact"===t.state)&&s<2*ye.tap.maxDistance&&(t.holdTriggered=!0,t.state="interact",this.callbacks.onHoldStart(e,t.currentX,t.currentY))},ye.hold.threshold);this.holdTimers.set(e,o)}cancelHoldTimer(e){const t=this.holdTimers.get(e);void 0!==t&&(clearTimeout(t),this.holdTimers.delete(e))}getActivePointers(){return Array.from(this.pointers.values())}getPointerState(e){return this.pointers.get(e)}reset(){for(const e of this.holdTimers.values())clearTimeout(e);this.holdTimers.clear();for(const[e,t]of this.pointers.entries())t.holdTriggered&&this.callbacks.onHoldEnd(e);this.pointers.clear(),this.swipeRotationFired=!1,this.trackpadRotationFired=!1,this.trackpadDeltaXAccum=0}dispose(){this.canvas.removeEventListener("touchstart",this.boundHandlers.touchStart),this.canvas.removeEventListener("touchmove",this.boundHandlers.touchMove),this.canvas.removeEventListener("touchend",this.boundHandlers.touchEnd),this.canvas.removeEventListener("touchcancel",this.boundHandlers.touchEnd),this.canvas.removeEventListener("mousedown",this.boundHandlers.mouseDown),this.canvas.removeEventListener("mousemove",this.boundHandlers.mouseMove),this.canvas.removeEventListener("mouseup",this.boundHandlers.mouseUp),this.canvas.removeEventListener("mouseleave",this.boundHandlers.mouseUp);for(const e of this.holdTimers.values())clearTimeout(e);this.holdTimers.clear(),this.pointers.clear()}}const De="game:block:destroyed",Ie="game:block:damaged",Be="game:loot:spawned",Ee="game:loot:collected",Re="game:resource:settled",Le="game:stability:check";var Te,Pe=((Te=Pe||{})[Te.AIR=ie.AIR]="AIR",Te[Te.BEDROCK=ie.BEDROCK]="BEDROCK",Te[Te.DIRT=ie.DIRT]="DIRT",Te[Te.STONE=ie.STONE]="STONE",Te[Te.IRON_ORE=ie.IRON_ORE]="IRON_ORE",Te[Te.GOLD_ORE=ie.GOLD_ORE]="GOLD_ORE",Te[Te.DIAMOND_ORE=ie.DIAMOND_ORE]="DIAMOND_ORE",Te),ze=(e=>(e.GOLD="gold",e.GEM="gem",e))(ze||{}),Ae=(e=>(e.PICKAXE="pickaxe",e.SHOVEL="shovel",e.DRILL="drill",e))(Ae||{});function He(e,t){window.dispatchEvent(new CustomEvent(e,{detail:t}))}function Oe(e,t){const s=e=>{t(e.detail)};return window.addEventListener(e,s),()=>window.removeEventListener(e,s)}let Fe=null;function Ye(){return Fe||(Fe=function(e=256,t=.05){const s=new Uint8Array(e*e*4);for(let i=0;i<e;i++)for(let o=0;o<e;o++){const n=4*(i*e+o),r=o/e,a=i/e,l=Math.min(r,1-r),c=Math.min(a,1-a),h=Math.sqrt(Math.min(r,1-r)**2+Math.min(a,1-a)**2),u=Math.min(l,c);let d=0,p=0,m=1;if(h<t){const e=h/t,s=Math.atan2(a-.5,r-.5);d=Math.cos(s)*(1-e),p=Math.sin(s)*(1-e),m=e}else if(u<t){const e=u/t;l<c?(d=(r<.5?-1:1)*(1-e),p=0):(d=0,p=(a<.5?-1:1)*(1-e)),m=e}const g=Math.sqrt(d*d+p*p+m*m);g>0&&(d/=g,p/=g,m/=g),s[n]=Math.floor(255*(.5*d+.5)),s[n+1]=Math.floor(255*(.5*p+.5)),s[n+2]=Math.floor(255*(.5*m+.5)),s[n+3]=255}const o=new f(s,e,e,v);return o.needsUpdate=!0,o.wrapS=b,o.wrapT=b,o.magFilter=k,o.minFilter=w,o.generateMipmaps=!0,o}(256,me.roundedBoxRadius)),Fe}function Ve(e,t=3){const s=function(e){const t=Math.max(2,Math.min(4,e)),s=new Uint8Array(4*t);for(let i=0;i<t;i++){const e=Math.round(i/(t-1)*255);s[4*i]=e,s[4*i+1]=e,s[4*i+2]=e,s[4*i+3]=255}const o=new f(s,t,1,v);return o.needsUpdate=!0,o.minFilter=M,o.magFilter=M,o}(t);return new y({color:e,gradientMap:s,normalMap:Ye(),normalScale:new m(1,1)})}function _e(e,t=!0,s=3){if(t){const t=Ve(e,s);return t.transparent=!0,t.onBeforeCompile=e=>{e.vertexShader=`\n        attribute float instanceAlpha;\n        varying float vInstanceAlpha;\n        ${e.vertexShader}\n      `.replace("#include <begin_vertex>","#include <begin_vertex>\n         vInstanceAlpha = instanceAlpha;"),e.fragmentShader=`\n        varying float vInstanceAlpha;\n        ${e.fragmentShader}\n      `.replace("#include <alphatest_fragment>","#include <alphatest_fragment>\n         gl_FragColor.a *= vInstanceAlpha;")},t}{const t=new g({color:e,roughness:.5,metalness:.1,flatShading:!0,transparent:!0,normalMap:Ye(),normalScale:new m(1,1)});return t.onBeforeCompile=e=>{e.vertexShader=`\n        attribute float instanceAlpha;\n        varying float vInstanceAlpha;\n        ${e.vertexShader}\n      `.replace("#include <begin_vertex>","#include <begin_vertex>\n         vInstanceAlpha = instanceAlpha;"),e.fragmentShader=`\n        varying float vInstanceAlpha;\n        ${e.fragmentShader}\n      `.replace("#include <alphatest_fragment>","#include <alphatest_fragment>\n         gl_FragColor.a *= vInstanceAlpha;")},t}}const $e={},Ne=e=>{let t;const s=new Set,o=(e,o)=>{const i="function"==typeof e?e(t):e;if(!Object.is(i,t)){const e=t;t=(null!=o?o:"object"!=typeof i||null===i)?i:Object.assign({},t,i),s.forEach(s=>s(t,e))}},i=()=>t,n={setState:o,getState:i,getInitialState:()=>r,subscribe:e=>(s.add(e),()=>s.delete(e)),destroy:()=>{"production"!==($e?"production":void 0)&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},r=t=e(o,i,n);return n};function Ge(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Xe={exports:{}},We={},je=Symbol.for("react.transitional.element"),Ue=Symbol.for("react.portal"),Qe=Symbol.for("react.fragment"),Ze=Symbol.for("react.strict_mode"),qe=Symbol.for("react.profiler"),Ke=Symbol.for("react.consumer"),Je=Symbol.for("react.context"),et=Symbol.for("react.forward_ref"),tt=Symbol.for("react.suspense"),st=Symbol.for("react.memo"),ot=Symbol.for("react.lazy"),it=Symbol.for("react.activity"),nt=Symbol.iterator;var rt={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},at=Object.assign,lt={};function ct(e,t,s){this.props=e,this.context=t,this.refs=lt,this.updater=s||rt}function ht(){}function ut(e,t,s){this.props=e,this.context=t,this.refs=lt,this.updater=s||rt}ct.prototype.isReactComponent={},ct.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},ct.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},ht.prototype=ct.prototype;var dt=ut.prototype=new ht;dt.constructor=ut,at(dt,ct.prototype),dt.isPureReactComponent=!0;var pt=Array.isArray;function mt(){}var gt={H:null,A:null,T:null,S:null},yt=Object.prototype.hasOwnProperty;function ft(e,t,s){var o=s.ref;return{$$typeof:je,type:e,key:t,ref:void 0!==o?o:null,props:s}}function vt(e){return"object"==typeof e&&null!==e&&e.$$typeof===je}var bt=/\/+/g;function kt(e,t){return"object"==typeof e&&null!==e&&null!=e.key?(s=""+e.key,o={"=":"=0",":":"=2"},"$"+s.replace(/[=:]/g,function(e){return o[e]})):t.toString(36);var s,o}function wt(e,t,s,o,i){var n=typeof e;"undefined"!==n&&"boolean"!==n||(e=null);var r,a,l=!1;if(null===e)l=!0;else switch(n){case"bigint":case"string":case"number":l=!0;break;case"object":switch(e.$$typeof){case je:case Ue:l=!0;break;case ot:return wt((l=e._init)(e._payload),t,s,o,i)}}if(l)return i=i(e),l=""===o?"."+kt(e,0):o,pt(i)?(s="",null!=l&&(s=l.replace(bt,"$&/")+"/"),wt(i,t,s,"",function(e){return e})):null!=i&&(vt(i)&&(r=i,a=s+(null==i.key||e&&e.key===i.key?"":(""+i.key).replace(bt,"$&/")+"/")+l,i=ft(r.type,a,r.props)),t.push(i)),1;l=0;var c,h=""===o?".":o+":";if(pt(e))for(var u=0;u<e.length;u++)l+=wt(o=e[u],t,s,n=h+kt(o,u),i);else if("function"==typeof(u=null===(c=e)||"object"!=typeof c?null:"function"==typeof(c=nt&&c[nt]||c["@@iterator"])?c:null))for(e=u.call(e),u=0;!(o=e.next()).done;)l+=wt(o=o.value,t,s,n=h+kt(o,u++),i);else if("object"===n){if("function"==typeof e.then)return wt(function(e){switch(e.status){case"fulfilled":return e.value;case"rejected":throw e.reason;default:switch("string"==typeof e.status?e.then(mt,mt):(e.status="pending",e.then(function(t){"pending"===e.status&&(e.status="fulfilled",e.value=t)},function(t){"pending"===e.status&&(e.status="rejected",e.reason=t)})),e.status){case"fulfilled":return e.value;case"rejected":throw e.reason}}throw e}(e),t,s,o,i);throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.")}return l}function Mt(e,t,s){if(null==e)return e;var o=[],i=0;return wt(e,o,"","",function(e){return t.call(s,e,i++)}),o}function xt(e){if(-1===e._status){var t=e._result;(t=t()).then(function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)},function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)}),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var St="function"==typeof reportError?reportError:function(e){if("object"==typeof window&&"function"==typeof window.ErrorEvent){var t=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:"object"==typeof e&&null!==e&&"string"==typeof e.message?String(e.message):String(e),error:e});if(!window.dispatchEvent(t))return}else if("object"==typeof process&&"function"==typeof process.emit)return void process.emit("uncaughtException",e);console.error(e)},Ct={map:Mt,forEach:function(e,t,s){Mt(e,function(){t.apply(this,arguments)},s)},count:function(e){var t=0;return Mt(e,function(){t++}),t},toArray:function(e){return Mt(e,function(e){return e})||[]},only:function(e){if(!vt(e))throw Error("React.Children.only expected to receive a single React element child.");return e}};We.Activity=it,We.Children=Ct,We.Component=ct,We.Fragment=Qe,We.Profiler=qe,We.PureComponent=ut,We.StrictMode=Ze,We.Suspense=tt,We.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=gt,We.__COMPILER_RUNTIME={__proto__:null,c:function(e){return gt.H.useMemoCache(e)}},We.cache=function(e){return function(){return e.apply(null,arguments)}},We.cacheSignal=function(){return null},We.cloneElement=function(e,t,s){if(null==e)throw Error("The argument must be a React element, but you passed "+e+".");var o=at({},e.props),i=e.key;if(null!=t)for(n in void 0!==t.key&&(i=""+t.key),t)!yt.call(t,n)||"key"===n||"__self"===n||"__source"===n||"ref"===n&&void 0===t.ref||(o[n]=t[n]);var n=arguments.length-2;if(1===n)o.children=s;else if(1<n){for(var r=Array(n),a=0;a<n;a++)r[a]=arguments[a+2];o.children=r}return ft(e.type,i,o)},We.createContext=function(e){return(e={$$typeof:Je,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider=e,e.Consumer={$$typeof:Ke,_context:e},e},We.createElement=function(e,t,s){var o,i={},n=null;if(null!=t)for(o in void 0!==t.key&&(n=""+t.key),t)yt.call(t,o)&&"key"!==o&&"__self"!==o&&"__source"!==o&&(i[o]=t[o]);var r=arguments.length-2;if(1===r)i.children=s;else if(1<r){for(var a=Array(r),l=0;l<r;l++)a[l]=arguments[l+2];i.children=a}if(e&&e.defaultProps)for(o in r=e.defaultProps)void 0===i[o]&&(i[o]=r[o]);return ft(e,n,i)},We.createRef=function(){return{current:null}},We.forwardRef=function(e){return{$$typeof:et,render:e}},We.isValidElement=vt,We.lazy=function(e){return{$$typeof:ot,_payload:{_status:-1,_result:e},_init:xt}},We.memo=function(e,t){return{$$typeof:st,type:e,compare:void 0===t?null:t}},We.startTransition=function(e){var t=gt.T,s={};gt.T=s;try{var o=e(),i=gt.S;null!==i&&i(s,o),"object"==typeof o&&null!==o&&"function"==typeof o.then&&o.then(mt,St)}catch(n){St(n)}finally{null!==t&&null!==s.types&&(t.types=s.types),gt.T=t}},We.unstable_useCacheRefresh=function(){return gt.H.useCacheRefresh()},We.use=function(e){return gt.H.use(e)},We.useActionState=function(e,t,s){return gt.H.useActionState(e,t,s)},We.useCallback=function(e,t){return gt.H.useCallback(e,t)},We.useContext=function(e){return gt.H.useContext(e)},We.useDebugValue=function(){},We.useDeferredValue=function(e,t){return gt.H.useDeferredValue(e,t)},We.useEffect=function(e,t){return gt.H.useEffect(e,t)},We.useEffectEvent=function(e){return gt.H.useEffectEvent(e)},We.useId=function(){return gt.H.useId()},We.useImperativeHandle=function(e,t,s){return gt.H.useImperativeHandle(e,t,s)},We.useInsertionEffect=function(e,t){return gt.H.useInsertionEffect(e,t)},We.useLayoutEffect=function(e,t){return gt.H.useLayoutEffect(e,t)},We.useMemo=function(e,t){return gt.H.useMemo(e,t)},We.useOptimistic=function(e,t){return gt.H.useOptimistic(e,t)},We.useReducer=function(e,t,s){return gt.H.useReducer(e,t,s)},We.useRef=function(e){return gt.H.useRef(e)},We.useState=function(e){return gt.H.useState(e)},We.useSyncExternalStore=function(e,t,s){return gt.H.useSyncExternalStore(e,t,s)},We.useTransition=function(){return gt.H.useTransition()},We.version="19.2.3",Xe.exports=We;var Dt=Xe.exports;const It=Ge(Dt);var Bt={exports:{}},Et={},Rt={exports:{}},Lt={},Tt=Dt;var Pt="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},zt=Tt.useState,At=Tt.useEffect,Ht=Tt.useLayoutEffect,Ot=Tt.useDebugValue;function Ft(e){var t=e.getSnapshot;e=e.value;try{var s=t();return!Pt(e,s)}catch(o){return!0}}var Yt="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var s=t(),o=zt({inst:{value:s,getSnapshot:t}}),i=o[0].inst,n=o[1];return Ht(function(){i.value=s,i.getSnapshot=t,Ft(i)&&n({inst:i})},[e,s,t]),At(function(){return Ft(i)&&n({inst:i}),e(function(){Ft(i)&&n({inst:i})})},[e]),Ot(s),s};Lt.useSyncExternalStore=void 0!==Tt.useSyncExternalStore?Tt.useSyncExternalStore:Yt,Rt.exports=Lt;var Vt=Dt,_t=Rt.exports;
/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var $t="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},Nt=_t.useSyncExternalStore,Gt=Vt.useRef,Xt=Vt.useEffect,Wt=Vt.useMemo,jt=Vt.useDebugValue;Et.useSyncExternalStoreWithSelector=function(e,t,s,o,i){var n=Gt(null);if(null===n.current){var r={hasValue:!1,value:null};n.current=r}else r=n.current;n=Wt(function(){function e(e){if(!l){if(l=!0,n=e,e=o(e),void 0!==i&&r.hasValue){var t=r.value;if(i(t,e))return a=t}return a=e}if(t=a,$t(n,e))return t;var s=o(e);return void 0!==i&&i(t,s)?(n=e,t):(n=e,a=s)}var n,a,l=!1,c=void 0===s?null:s;return[function(){return e(t())},null===c?void 0:function(){return e(c())}]},[t,s,o,i]);var a=Nt(e,n[0],n[1]);return Xt(function(){r.hasValue=!0,r.value=a},[a]),jt(a),a},Bt.exports=Et;const Ut=Ge(Bt.exports),Qt={},{useDebugValue:Zt}=It,{useSyncExternalStoreWithSelector:qt}=Ut;let Kt=!1;const Jt=e=>e;const es=e=>{"production"!==(Qt?"production":void 0)&&"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?Ne(e):Ne)(e):e,s=(e,s)=>function(e,t=Jt,s){"production"!==(Qt?"production":void 0)&&s&&!Kt&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Kt=!0);const o=qt(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,s);return Zt(o),o}(t,e,s);return Object.assign(s,t),s},ts=(ss=(e,t)=>({gold:fe.gold,gems:fe.gems,depth:fe.depth,maxDepth:fe.maxDepth,fuel:fe.fuel,maxFuel:fe.maxFuel,currentTool:fe.currentTool,toolDamageMultiplier:fe.toolDamageMultiplier,damageLevel:fe.damageLevel,hasDrone:fe.hasDrone,turboActive:fe.turboActive,turboFuel:fe.turboFuel,maxTurboFuel:fe.maxTurboFuel,debugVisuals:fe.debugVisuals,debugMode:!1,addGold:t=>e(e=>({gold:e.gold+t})),addGems:t=>e(e=>({gems:e.gems+t})),setDepth:t=>e(e=>({depth:t,maxDepth:Math.max(e.maxDepth,t)})),setFuel:t=>e(e=>({fuel:Math.max(0,Math.min(t,e.maxFuel))})),consumeFuel:s=>{const o=t();return o.fuel>=s&&(e({fuel:o.fuel-s}),!0)},setCurrentTool:t=>e({currentTool:t}),upgradeDamage:()=>{const s=t(),o=ae.damage.baseCost*Math.pow(ae.damage.costMultiplier,s.damageLevel);return s.gold>=o&&(e({gold:s.gold-o,damageLevel:s.damageLevel+1,toolDamageMultiplier:s.toolDamageMultiplier*ae.damage.damageMultiplier}),!0)},buyDrone:()=>{const s=t();return s.gold>=ae.drone.cost&&!s.hasDrone&&(e({gold:s.gold-ae.drone.cost,hasDrone:!0}),!0)},buyTurboFuel:()=>{const s=t();return s.gold>=ae.turboFuel.cost&&(e({gold:s.gold-ae.turboFuel.cost,turboFuel:s.maxTurboFuel}),!0)},activateTurbo:()=>{t().turboFuel>0&&e({turboActive:!0})},deactivateTurbo:()=>e({turboActive:!1}),consumeTurboFuel:s=>{const o=t(),i=Math.max(0,o.turboFuel-s);e({turboFuel:i}),i<=0&&e({turboActive:!1})},toggleDebugVisuals:()=>{const s=t();e({debugVisuals:!s.debugVisuals})},toggleDebugMode:()=>{const s=t();e({debugMode:!s.debugMode})}}))?es(ss):es;var ss;const os={DRONE:ae.drone.cost,TURBO_FUEL:ae.turboFuel.cost};class is{chunks=new Map;blockGroup;blockDataMap=new Map;lowestY=0;highestY=0;chunkHeight;frustum;geometry;bedrockMaterial;constructor(){this.chunkHeight=ce.chunkHeight,this.frustum=new x,this.blockGroup=new S,this.bedrockMaterial=function(){const e=new g({color:1710618,roughness:.9,metalness:.1,transparent:!0,normalMap:Ye(),normalScale:new m(1,1)});return e.onBeforeCompile=e=>{e.vertexShader=`\n      attribute float instanceAlpha;\n      varying float vInstanceAlpha;\n      ${e.vertexShader}\n    `.replace("#include <begin_vertex>","#include <begin_vertex>\n       vInstanceAlpha = instanceAlpha;"),e.fragmentShader=`\n      varying float vInstanceAlpha;\n      ${e.fragmentShader}\n    `.replace("#include <alphatest_fragment>","#include <alphatest_fragment>\n       gl_FragColor.a *= vInstanceAlpha;")},e}(),this.geometry=this.createBlockGeometry()}createBlockGeometry(){return new C(me.geometrySize,me.geometrySize,me.geometrySize,1,1,1)}getChunkId(e){return Math.floor(e/this.chunkHeight)}getChunkBounds(e){const t=e*this.chunkHeight;return{minY:t,maxY:t+this.chunkHeight-1}}getOrCreateChunk(e){if(!this.chunks.has(e)){const t=this.createChunk(e);this.chunks.set(e,t),this.blockGroup.add(t.group)}return this.chunks.get(e)}createChunk(e){const t=new S;t.userData={chunkId:e};const s={group:t,instancedMeshes:new Map,instanceMatrices:new Map,instanceLockedFlags:new Map,dirty:!1},o=[Pe.DIRT,Pe.STONE,Pe.IRON_ORE,Pe.GOLD_ORE,Pe.DIAMOND_ORE,Pe.BEDROCK,Pe.AIR],i=this.chunkHeight*(ce.maxX-ce.minX+1)*(ce.maxZ-ce.minZ+1);for(const n of o){let e,o,r,a=!1;n===Pe.BEDROCK?(e=this.bedrockMaterial,o=500,r=this.geometry):n===Pe.AIR?(e=new D({color:65535,wireframe:!0,transparent:!0,opacity:.3}),o=i,r=new C(me.geometrySize,me.geometrySize,me.geometrySize)):(e=_e(ne[n].color,ge.enabled,ge.toonSteps),o=i,r=this.geometry);const l=new I(r,e,o);if(n===Pe.BEDROCK){const e=new Float32Array(o).fill(1);l.geometry.setAttribute("instanceAlpha",new B(e,1)),l.castShadow=!0,l.receiveShadow=!0}else if(n===Pe.AIR)l.castShadow=!1,l.receiveShadow=!1;else{const e=new Float32Array(o).fill(1);l.geometry.setAttribute("instanceAlpha",new B(e,1)),l.castShadow=!0,l.receiveShadow=!0}l.count=0,l.frustumCulled=a,s.instancedMeshes.set(n,l),s.instanceMatrices.set(n,[]),s.instanceLockedFlags.set(n,[]),t.add(l)}return s}updateChunkMeshes(e){const t=new l(1,1,1),s=new l(.5,.5,.5);for(const[o,i]of e.instancedMeshes.entries()){const n=e.instanceMatrices.get(o)||[],r=e.instanceLockedFlags.get(o)||[];i.count=n.length;for(let e=0;e<n.length;e++)i.setMatrixAt(e,n[e]),o!==Pe.BEDROCK&&o!==Pe.AIR&&i.setColorAt(e,r[e]?s:t);i.instanceMatrix.needsUpdate=!0,i.instanceColor&&(i.instanceColor.needsUpdate=!0)}}updateChunkVisibility(e){const t=(new E).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse);this.frustum.setFromProjectionMatrix(t);for(const[s,o]of this.chunks.entries()){const{minY:e,maxY:t}=this.getChunkBounds(s),i=new R;i.min.set(ce.minX,e,ce.minZ),i.max.set(ce.maxX,t,ce.maxZ);const n=this.frustum.intersectsBox(i);o.group.visible=n}}get group(){return this.blockGroup}get highestYValue(){return this.highestY}generateInitialColumn(){for(let t=0;t>-20;t--)this.generateLayer(t);this.lowestY=-20,this.highestY=0;const e=Array.from(this.blockDataMap.values());for(const t of e)this.calculateBlockNeighbors(t);this.updateInstancedMeshes()}generateLayer(e){for(let t=ce.minX;t<=ce.maxX;t++)for(let s=ce.minZ;s<=ce.maxZ;s++){const o=this.getBlockTypeForPosition(t,e,s);o!==Pe.AIR&&this.setBlock(t,e,s,o)}}getBlockTypeForPosition(e,t,s){const o=-t,i=Math.random();return o<5?i<.85?Pe.DIRT:Pe.STONE:o<15?i<.35?Pe.DIRT:i<.92?Pe.STONE:Pe.IRON_ORE:o<30?i<.15?Pe.DIRT:i<.7?Pe.STONE:i<.88?Pe.IRON_ORE:Pe.GOLD_ORE:i<.08?Pe.DIRT:i<.45?Pe.STONE:i<.68?Pe.IRON_ORE:i<.88?Pe.GOLD_ORE:Pe.DIAMOND_ORE}calculateInitialResourceQuantity(e){const t=ne[e];if(!t.lootType)return 0;let s=t.lootMin;const o=t.lootMax-t.lootMin;return o>0&&Math.random()<t.lootExtraChance&&(s+=o),s}setBlock(e,t,s,o){const i=`${e},${t},${s}`,n=this.getChunkId(t),r=this.getOrCreateChunk(n),a=ne[o],l=this.calculateInitialResourceQuantity(o),c=null!==a.lootType&&Math.random()<a.lootChance,h={type:o,initialHp:a.hp,hp:a.hp,initialResourceQuantity:l,resourceQuantity:l,hasLoot:c,x:e,y:t,z:s,instanceId:-1,isStatic:!0,isLocked:!1,chunkId:n,sideNeighborCount:0,hasSideNeighbors:!1,hasBottomNeighbor:!1,clusterId:0,gripForce:a.gripForce,wobble:0};this.blockDataMap.set(i,h),r.dirty=!0,this.calculateBlockNeighbors(h);const u=[[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]];for(const[d,p,m]of u){const o=this.getBlock(e+d,t+p,s+m);o&&this.calculateBlockNeighbors(o)}}getBlock(e,t,s){const o=this.blockDataMap.get(`${e},${t},${s}`);if(!o||!o.isDying)return o}removeBlock(e,t,s){const o=`${e},${t},${s}`,i=this.blockDataMap.get(o);if(i){const n=i.chunkId||this.getChunkId(t),r=this.chunks.get(n),a=[[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]],l=[];for(const[o,i,c]of a){const n=this.getBlock(e+o,t+i,s+c);n&&l.push(n)}this.blockDataMap.delete(o),r&&(r.dirty=!0);for(const e of l)this.updateBlockStats(e);this.recalculateCluster(),this.checkChunkEmpty(n),t===this.highestY&&this.pruneEmptyLayers()}return i}extractClusterBlocks(e){const t=[];for(const s of e)t.push({type:s.type,hp:s.hp,initialHp:s.initialHp,initialResourceQuantity:s.initialResourceQuantity,resourceQuantity:s.resourceQuantity,hasLoot:s.hasLoot,gridX:s.x,gridY:s.y,gridZ:s.z,localX:0,localY:0,localZ:0}),this.removeBlock(s.x,s.y,s.z);return t}setBlockFromData(e){const t=`${e.x},${e.y},${e.z}`,s=this.getChunkId(e.y),o=this.getOrCreateChunk(s),i={type:e.type,hp:e.hp,initialHp:e.initialHp,initialResourceQuantity:e.initialResourceQuantity,resourceQuantity:e.resourceQuantity,hasLoot:e.hasLoot,x:e.x,y:e.y,z:e.z,isStatic:e.isStatic,instanceId:-1,isLocked:!1,chunkId:s,sideNeighborCount:0,hasSideNeighbors:!1,hasBottomNeighbor:!1,clusterId:0,gripForce:ne[e.type].gripForce,wobble:0};this.blockDataMap.set(t,i),o.dirty=!0,this.highestY=Math.max(this.highestY,e.y),this.lowestY=Math.min(this.lowestY,e.y),this.updateBlockStats(i);const n=[[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]];for(const[r,a,l]of n){const t=this.getBlock(e.x+r,e.y+a,e.z+l);t&&this.updateBlockStats(t)}}damageBlock(e,t,s,o){const i=this.getBlock(e,t,s);if(!i||i.type===Pe.BEDROCK)return{destroyed:!1,remaining:1/0,droppedQuantity:0};i.hp-=o;let n=0;if(i.initialResourceQuantity>0){const e=i.initialHp/i.initialResourceQuantity,t=Math.max(0,i.initialResourceQuantity-1),s=Math.floor((i.initialHp-i.hp)/e),o=Math.min(s,t),r=i.initialResourceQuantity-i.resourceQuantity,a=Math.max(0,o-r);a>0&&(n=a,i.resourceQuantity-=a)}return i.hp<=0?(i.resourceQuantity>0&&(n+=i.resourceQuantity,i.resourceQuantity=0),i.isDying=!0,this.shakeBlock(e,t,s,.1,0),{destroyed:!0,remaining:0,droppedQuantity:n}):{destroyed:!1,remaining:i.hp,droppedQuantity:n}}isLayerEmpty(e){for(let t=ce.minX;t<=ce.maxX;t++)for(let s=ce.minZ;s<=ce.maxZ;s++){const o=this.getBlock(t,e,s);if(o&&o.type!==Pe.AIR)return!1}return!0}pruneEmptyLayers(){const e=this.highestY;for(;this.highestY>this.lowestY&&this.isLayerEmpty(this.highestY);)this.highestY--;if(this.highestY!==e)for(let t=e;t>this.highestY;t--){const e=this.getChunkId(t),s=this.chunks.get(e);s&&(s.dirty=!0)}}checkChunkEmpty(e){const{minY:t,maxY:s}=this.getChunkBounds(e);let o=!1;for(const i of this.blockDataMap.values())if(i.y>=t&&i.y<=s&&i.type!==Pe.AIR){o=!0;break}if(!o){const t=this.chunks.get(e);if(t){this.blockGroup.remove(t.group);for(const e of t.instancedMeshes.values())e.geometry!==this.geometry&&e.geometry.dispose(),e.material instanceof L&&e.material.dispose();this.chunks.delete(e)}}}isBlockInteractable(e,t,s){const o=this.getBlock(e,t,s);return!!o&&(o.type!==Pe.AIR&&o.type!==Pe.BEDROCK&&!this.isBlockLocked(e,t,s))}isBlockLocked(e,t,s){const o=this.getBlock(e,t,s);if(!o)return!0;if(o.type===Pe.AIR)return!0;if(o.type===Pe.BEDROCK)return!0;if(t<this.highestY-Me.maxDepthRange)return!0;const i=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];for(const[n,r,a]of i){const o=e+n,i=t+r,l=s+a;if(o<ce.minX||o>ce.maxX||l<ce.minZ||l>ce.maxZ)continue;const c=this.getBlock(o,i,l);if(!c||c.type===Pe.AIR)return!1}return!0}updateInstancedMeshes(){const e=ts.getState().debugVisuals;for(const[t,s]of this.chunks.entries()){if(!s.dirty)continue;for(const e of s.instanceMatrices.values())e.length=0;for(const e of s.instanceLockedFlags.values())e.length=0;const{minY:o,maxY:i}=this.getChunkBounds(t),n=s.instancedMeshes.get(Pe.AIR);n&&(n.visible=e);const r=new E;for(const e of this.blockDataMap.values()){if(e.y<o||e.y>i)continue;if(e.type===Pe.AIR)continue;r.makeTranslation(e.x,e.y,e.z);const t=s.instanceMatrices.get(e.type),n=s.instanceLockedFlags.get(e.type);if(t){const s=this.isBlockLocked(e.x,e.y,e.z);e.isLocked=s,e.instanceId=t.length,t.push(r.clone()),n&&n.push(s)}}if(e){const e=s.instanceMatrices.get(Pe.AIR);if(e){const t=this.highestY,s=Math.max(this.lowestY,this.highestY-we.airWireframeWindow);if(i>=s&&o<=t){const n=Math.max(o,s);for(let s=Math.min(i,t);s>=n;s--)if(!this.isLayerEmpty(s))for(let t=ce.minX;t<=ce.maxX;t++)for(let o=ce.minZ;o<=ce.maxZ;o++){const i=this.getBlock(t,s,o);i&&i.type!==Pe.AIR||(r.makeTranslation(t,s,o),e.push(r.clone()))}}}}this.updateChunkMeshes(s),s.dirty=!1}}updateAirMeshVisibility(e){for(const t of this.chunks.values()){const s=t.instancedMeshes.get(Pe.AIR);s&&(s.visible=e&&t.group.visible)}}extendColumn(e){const t=-Math.abs(e);for(;this.lowestY>t;)this.lowestY--,this.generateLayer(this.lowestY);this.updateInstancedMeshes()}getBlocksInRange(e,t){const s=[];for(const o of this.blockDataMap.values())o.y>=e&&o.y<=t&&o.type!==Pe.BEDROCK&&s.push(o);return s}getRaycastTargets(){const e=[];for(const t of this.chunks.values())if(t.group.visible)for(const[s,o]of t.instancedMeshes.entries())s!==Pe.BEDROCK&&s!==Pe.AIR&&o.count>0&&e.push(o);return e}getBlockFromIntersection(e){if(void 0!==e.instanceId)for(const t of this.chunks.values())if(Array.from(t.instancedMeshes.values()).includes(e.object))for(const s of this.blockDataMap.values())if(!s.isDying&&s.instanceId===e.instanceId){const t=s.chunkId||this.getChunkId(s.y),o=this.chunks.get(t);if(o&&o.instancedMeshes.get(s.type)===e.object)return s}}getNeighbors(e,t,s){const o=[],i=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]];for(const[n,r,a]of i){const i=this.getBlock(e+n,t+r,s+a);i&&o.push(i)}return o}calculateBlockNeighbors(e,t){const{x:s,y:o,z:i}=e;let n=0,r=!1,a=!1;const l=[[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]];for(const[h,u,d]of l){const e=s+h,a=i+d,l=`${e},${o},${a}`;if(t&&t.has(l))continue;const c=this.getBlock(e,o,a);c&&c.type!==Pe.AIR&&(n++,r=!0)}const c=`${s},${o-1},${i}`;if(!t||!t.has(c)){const e=this.getBlock(s,o-1,i);a=void 0!==e&&e.type!==Pe.AIR}e.sideNeighborCount=n,e.hasSideNeighbors=r,e.hasBottomNeighbor=a}calculateStabilityScore(e){if(e.type===Pe.BEDROCK)return 1/0;if(e.hasBottomNeighbor)return 1/0;const{isAnchored:t}=this.getConnectedCluster(e);return t?1/0:0}getConnectedCluster(e){const t=[],s=[e],o=new Set;if(o.add(`${e.x},${e.y},${e.z}`),t.push(e),e.type===Pe.BEDROCK||this.isBottomLayer(e.y))return{blocks:[],isAnchored:!0};let i=0;for(;i<s.length;){const e=s[i++],n=this.getNeighbors(e.x,e.y,e.z);for(const i of n){if(i.type===Pe.AIR||i.isDying||!i.isStatic)continue;if(i.type===Pe.BEDROCK||this.isBottomLayer(i.y))return{blocks:[],isAnchored:!0};const e=`${i.x},${i.y},${i.z}`;o.has(e)||(o.add(e),t.push(i),s.push(i))}}return{blocks:t,isAnchored:!1}}isBottomLayer(e){return e<=this.lowestY+1}calculateClusterMass(e){const t=new Set,s=[e];t.add(`${e.x},${e.y},${e.z}`);let o=0;for(;s.length>0;){const e=s.shift(),i=ne[e.type];i&&(o+=i.density);const n=this.getNeighbors(e.x,e.y,e.z);for(const o of n)if(o.type!==Pe.AIR&&!o.isDying){const e=`${o.x},${o.y},${o.z}`;t.has(e)||(t.add(e),s.push(o))}}return o}recalculateCluster(e,t,s){const o=Array.from(this.blockDataMap.values());for(const a of o)a.clusterId=-1;const i=[],n=new Set;for(const a of o)a.type===Pe.AIR||a.isDying||(a.type===Pe.BEDROCK||this.isPerimeter(a.x,a.z)||a.hasBottomNeighbor)&&(i.push(a),n.add(`${a.x},${a.y},${a.z}`),a.clusterId=0);for(;i.length>0;){const e=i.shift(),t=this.getNeighbors(e.x,e.y,e.z);for(const s of t){if(s.type===Pe.AIR||s.isDying)continue;const e=`${s.x},${s.y},${s.z}`;n.has(e)||(n.add(e),s.clusterId=0,i.push(s))}}let r=1;for(const a of o){if(a.type===Pe.AIR||a.isDying||0===a.clusterId)continue;if(-1!==a.clusterId)continue;const e=[a];a.clusterId=r;const t=new Set([`${a.x},${a.y},${a.z}`]);for(;e.length>0;){const s=e.shift(),o=this.getNeighbors(s.x,s.y,s.z);for(const i of o){if(i.type===Pe.AIR||i.isDying||-1!==i.clusterId)continue;const s=`${i.x},${i.y},${i.z}`;t.has(s)||(t.add(s),i.clusterId=r,e.push(i))}}r++}}updateBlockStats(e,t){this.calculateBlockNeighbors(e,t)}isPerimeter(e,t){return e===ce.minX||e===ce.maxX||t===ce.minZ||t===ce.maxZ}getAllBlocks(){return Array.from(this.blockDataMap.values()).filter(e=>!e.isDying)}shakingBlocks=new Map;shakeBlock(e,t,s,o=.15,i=0){const n=`${e},${t},${s}`;this.shakingBlocks.set(n,{shakeTime:o,initialDuration:o,growSpeed:i})}updateShaking(e){const t=[];for(const[o,i]of this.shakingBlocks.entries()){if(i.shakeTime-=e,i.shakeTime<=0){t.push(o);continue}const[n,r,a]=o.split(",").map(Number),l=this.blockDataMap.get(o);if(!l||-1===l.instanceId)continue;const c=l.chunkId||this.getChunkId(r),h=this.chunks.get(c);if(!h)continue;const u=h.instancedMeshes.get(l.type);if(!u)continue;const d=i.shakeTime/i.initialDuration,p=i.growSpeed,m=p+(1-p)*d,g=l.isDying?d:1,y=new E;y.makeTranslation(n,r,a),y.scale(new s(m,m,m)),u.setMatrixAt(l.instanceId,y),u.instanceMatrix.needsUpdate=!0;const f=u.geometry.getAttribute("instanceAlpha");f&&(f.setX(l.instanceId,g),f.needsUpdate=!0)}for(const s of t){this.shakingBlocks.delete(s);const[e,t,o]=s.split(",").map(Number),i=this.blockDataMap.get(s);if(i&&-1!==i.instanceId)if(i.isDying)this.removeBlock(e,t,o);else{const s=i.chunkId||this.getChunkId(t),n=this.chunks.get(s);if(n){const s=n.instancedMeshes.get(i.type);if(s){const n=new E;n.makeTranslation(e,t,o),s.setMatrixAt(i.instanceId,n),s.instanceMatrix.needsUpdate=!0;const r=s.geometry.getAttribute("instanceAlpha");r&&(r.setX(i.instanceId,1),r.needsUpdate=!0)}}}}}dispose(){for(const e of this.chunks.values())for(const t of e.instancedMeshes.values())t.geometry!==this.geometry&&t.geometry.dispose(),t.material instanceof L&&t.material.dispose();this.geometry.dispose(),this.bedrockMaterial.dispose(),this.blockDataMap.clear(),this.chunks.clear(),this.shakingBlocks.clear()}setBlockColor(e,t,s,o,i,n){const r=`${e},${t},${s}`,a=this.blockDataMap.get(r);if(!a||-1===a.instanceId)return;const c=a.chunkId||this.getChunkId(t),h=this.chunks.get(c);if(!h)return;const u=h.instancedMeshes.get(a.type);u&&u.instanceColor&&(u.setColorAt(a.instanceId,new l(o,i,n)),u.instanceColor.needsUpdate=!0)}rebuildChunks(){for(const e of this.chunks.values()){this.blockGroup.remove(e.group);for(const t of e.instancedMeshes.values())t.geometry!==this.geometry&&t.geometry.dispose(),t.material instanceof L&&t.material.dispose()}this.chunks.clear();for(const e of this.blockDataMap.values()){const t=this.getChunkId(e.y);this.getOrCreateChunk(t).dirty=!0}this.updateInstancedMeshes()}applyFloatingOriginOffset(e){const t=new Map;for(const[s,o]of this.blockDataMap){o.y-=e;const s=`${o.x},${o.y},${o.z}`;o.chunkId=this.getChunkId(o.y),t.set(s,o)}this.blockDataMap=t,this.lowestY-=e,this.highestY-=e,this.rebuildChunks()}}class ns{world;bodies=new Map;pendingRemovals=[];initialized=!1;wallConfigs=[];wallHelpers=null;scene=null;onBlockImpact=null;async init(e){await _.init();const t={x:0,y:le.gravity,z:0};this.world=new _.World(t),this.scene=e,this.calculateWallConfigs(),this.createInvisibleWalls(),this.initialized=!0}isInitialized(){return this.initialized}calculateWallConfigs(){const e=2e4,t=.5,s=ce.minX-t-0,o=ce.maxX+t+0,i=ce.minZ-t-0,n=ce.maxZ+t+0,r=o-s,a=n-i,l=2.5;this.wallConfigs=[{name:"left",position:{x:s-l,y:0,z:(i+n)/2},size:{width:5,height:e,depth:a+10}},{name:"right",position:{x:o+l,y:0,z:(i+n)/2},size:{width:5,height:e,depth:a+10}},{name:"front",position:{x:(s+o)/2,y:0,z:i-l},size:{width:r,height:e,depth:5}},{name:"back",position:{x:(s+o)/2,y:0,z:n+l},size:{width:r,height:e,depth:5}}]}createInvisibleWalls(){if(0!==this.wallConfigs.length)for(const e of this.wallConfigs){const t=_.RigidBodyDesc.fixed().setTranslation(e.position.x,e.position.y,e.position.z),s=this.world.createRigidBody(t),o=_.ColliderDesc.cuboid(e.size.width/2,e.size.height/2,e.size.depth/2).setRestitution(0).setFriction(.5);this.world.createCollider(o,s)}}createStaticBlock(e,t,s,o){const i=_.RigidBodyDesc.fixed().setTranslation(e,t,s),n=this.world.createRigidBody(i),r=_.ColliderDesc.cuboid(.5,.5,.5).setRestitution(.1).setFriction(.8),a={rigidBody:n,collider:this.world.createCollider(r,n),blockData:o,type:"block"};return this.bodies.set(n.handle,a),a}convertToDynamic(e){const t=e.rigidBody.translation();this.removeBody(e);const s=_.RigidBodyDesc.dynamic().setTranslation(t.x,t.y,t.z).setLinearDamping(1.5).setAngularDamping(1.5),o=this.world.createRigidBody(s),i=e.blockData?ne[e.blockData.type].density:1,n=_.ColliderDesc.cuboid(.5,.5,.5).setRestitution(0).setFriction(2).setDensity(i).setActiveEvents(_.ActiveEvents.COLLISION_EVENTS),r={rigidBody:o,collider:this.world.createCollider(n,o),blockData:e.blockData,mesh:e.mesh,type:"block"};this.bodies.set(o.handle,r)}calculateEjectionImpulse(e,t,s,o){const i=[{x:0,y:1,z:0},{x:0,y:-1,z:0},{x:1,y:0,z:0},{x:-1,y:0,z:0},{x:0,y:0,z:1},{x:0,y:0,z:-1}];let n=[];for(const l of i)this.findBlockAt(e+l.x,t+l.y,s+l.z)||n.push(l);if(0===n.length)return{x:(Math.random()-.5)*o,y:o,z:(Math.random()-.5)*o};let r={x:0,y:0,z:0};for(const l of n)r.x+=l.x,r.y+=l.y,r.z+=l.z;const a=Math.sqrt(r.x**2+r.y**2+r.z**2);return a>.001?(r.x=r.x/a*o,r.y=r.y/a*o,r.z=r.z/a*o):r.y=o,r.x+=(Math.random()-.5)*(.5*o),r.y+=.5*Math.random(),r.z+=(Math.random()-.5)*(.5*o),r}createLoot(e,t,s,o){const i=this.calculateEjectionImpulse(e,t,s,.5),n=Math.sqrt(i.x**2+i.y**2+i.z**2);let r=0,a=0,l=0;if(n>.001){const e=.8;r=i.x/n*e,a=i.y/n*e,l=i.z/n*e}else a=.8;const c=_.RigidBodyDesc.dynamic().setTranslation(e+r,t+a,s+l).setLinearDamping(2).setAngularDamping(2),h=this.world.createRigidBody(c),u=_.ColliderDesc.ball(.15).setRestitution(.2).setFriction(1.5).setDensity(.5),d=this.world.createCollider(u,h);h.applyImpulse(i,!0);const p={rigidBody:h,collider:d,mesh:o,type:"loot"};return this.bodies.set(h.handle,p),p}createResource(e,t,s){const o=this.calculateEjectionImpulse(e,t,s,.5),i=Math.sqrt(o.x**2+o.y**2+o.z**2);let n=0,r=0,a=0;if(i>.001){const e=1;n=o.x/i*e,r=o.y/i*e,a=o.z/i*e}else r=1;const l=_.RigidBodyDesc.dynamic().setTranslation(e+n,t+r,s+a).setLinearDamping(2).setAngularDamping(2).setCcdEnabled(!0),c=this.world.createRigidBody(l),h=_.ColliderDesc.ball(.3).setRestitution(.1).setFriction(1.5).setDensity(.5),u=this.world.createCollider(h,c);c.applyImpulse(o,!0);const d={rigidBody:c,collider:u,type:"loot"};return this.bodies.set(c.handle,d),d}removeBody(e){this.bodies.delete(e.rigidBody.handle),this.world.removeRigidBody(e.rigidBody)}getBody(e){return this.bodies.get(e)}findBlockAt(e,t,s){for(const o of this.bodies.values())if("block"===o.type&&o.blockData){const i=o.rigidBody.translation();if(Math.abs(i.x-e)<.1&&Math.abs(i.y-t)<.1&&Math.abs(i.z-s)<.1)return o}}step(e){if(this.initialized&&0!==e){this.world.step();for(const e of this.bodies.values())if(e.mesh&&e.rigidBody.isDynamic()){const t=e.rigidBody.translation(),s=e.rigidBody.rotation();e.mesh.position.set(t.x,t.y,t.z),e.mesh.quaternion.set(s.x,s.y,s.z,s.w);const o=e.rigidBody.linvel();Math.sqrt(o.x**2+o.y**2+o.z**2);e.type}for(const e of this.pendingRemovals){const t=this.bodies.get(e);t&&this.removeBody(t)}this.pendingRemovals=[]}}getDynamicBodies(){const e=[];for(const t of this.bodies.values())t.rigidBody.isDynamic()&&e.push(t);return e}getLootBodies(){const e=[];for(const t of this.bodies.values())"loot"===t.type&&e.push(t);return e}scheduleRemoval(e){this.pendingRemovals.push(e.rigidBody.handle)}applyFloatingOriginOffset(e){for(const t of this.bodies.values()){const s=t.rigidBody.translation();t.rigidBody.setTranslation({x:s.x,y:s.y-e,z:s.z},!0)}}clear(){for(const e of this.bodies.values())this.world.removeRigidBody(e.rigidBody);this.bodies.clear()}createWallVisualization(){if(this.wallHelpers)return this.wallHelpers;this.wallHelpers=new S,this.wallHelpers.name="debug-walls";const e=new D({color:65280,wireframe:!0,transparent:!0,opacity:.3});for(const t of this.wallConfigs){const s=new C(t.size.width,t.size.height,t.size.depth),o=new T(s,e);o.position.set(t.position.x,t.position.y,t.position.z),this.wallHelpers.add(o)}return this.scene&&this.scene.add(this.wallHelpers),this.wallHelpers}removeWallVisualization(){this.wallHelpers&&this.scene&&(this.scene.remove(this.wallHelpers),this.wallHelpers.traverse(e=>{e instanceof T&&(e.geometry.dispose(),e.material.dispose())}),this.wallHelpers=null)}dispose(){this.clear()}}class rs{voxelColumn;pendingCheck=new Set;constructor(e){this.voxelColumn=e}queueCheck(e,t,s){this.pendingCheck.add(`${e},${t},${s}`)}checkStability(){const e=[],t=new Set;if(0===this.pendingCheck.size)return[];const s=Array.from(this.pendingCheck);this.pendingCheck.clear();for(const o of s){const[s,i,n]=o.split(",").map(Number),r=this.voxelColumn.getBlock(s,i,n),a=r?[r,...this.voxelColumn.getNeighbors(s,i,n)]:this.voxelColumn.getNeighbors(s,i,n);for(const o of a){if(!o||!o.isStatic||o.type===Pe.AIR||o.isDying)continue;const s=`${o.x},${o.y},${o.z}`;if(t.has(s))continue;const{blocks:i,isAnchored:n}=this.voxelColumn.getConnectedCluster(o);for(const e of i)t.add(`${e.x},${e.y},${e.z}`);if(!n)for(const t of i)e.push({block:t,reason:"unstable"})}}return e}getUnstableClusters(){const e=this.checkStability();if(0===e.length)return[];const t=[],s=new Set;for(const o of e){const e=`${o.block.x},${o.block.y},${o.block.z}`;if(s.has(e))continue;const{blocks:i}=this.voxelColumn.getConnectedCluster(o.block);for(const t of i)s.add(`${t.x},${t.y},${t.z}`);t.push(i)}return t}clearPending(){this.pendingCheck.clear()}}class as{voxelColumn;drillInterval=null;currentDrillTarget=null;onBlockDestroyed=null;onBlockDamaged=null;constructor(e){this.voxelColumn=e}calculateDamage(e,t){const s=re[e],o=ne[t];let i=s.baseDamage;return t===Pe.STONE||t===Pe.IRON_ORE||t===Pe.GOLD_ORE||t===Pe.DIAMOND_ORE?i*=s.stoneMultiplier:t===Pe.DIRT&&(i*=s.dirtMultiplier),i/=o.hardness||1,i*=function(){const e=ts.getState();return e.toolDamageMultiplier*(e.turboActive?2:1)}(),Math.max(1,Math.ceil(i))}useTapTool(e,t,s,o){const i=ts.getState(),n=re[i.currentTool];return"tap"===n.inputMode&&(i.turboActive&&i.consumeTurboFuel(.5*n.fuelCost),this.damageBlockAt(e,t,s,i.currentTool,o))}startDrill(e,t,s,o){if(ts.getState().currentTool!==Ae.DRILL)return;this.stopDrill();const i=re[Ae.DRILL];this.currentDrillTarget={x:e,y:t,z:s,hitPoint:o},this.drillInterval=window.setInterval(()=>{if(this.currentDrillTarget){const e=ts.getState();e.turboActive&&e.consumeTurboFuel(.5*i.fuelCost);this.damageBlockAt(this.currentDrillTarget.x,this.currentDrillTarget.y,this.currentDrillTarget.z,Ae.DRILL,this.currentDrillTarget.hitPoint)&&this.stopDrill()}},i.tickRate)}stopDrill(){null!==this.drillInterval&&(clearInterval(this.drillInterval),this.drillInterval=null),this.currentDrillTarget=null}updateDrillTarget(e,t,s,o){null!==this.drillInterval&&(this.currentDrillTarget={x:e,y:t,z:s})}damageBlockAt(e,t,s,o,i){const n=this.voxelColumn.getBlock(e,t,s);if(!n||n.type===Pe.BEDROCK||n.type===Pe.AIR)return!1;if(!this.voxelColumn.isBlockInteractable(e,t,s))return!1;const r=this.calculateDamage(o,n.type),a=this.voxelColumn.damageBlock(e,t,s,r);return a.destroyed?(He(De,{x:e,y:t,z:s,blockType:n.type,droppedQuantity:a.droppedQuantity,hasLoot:n.hasLoot}),this.onBlockDestroyed&&this.onBlockDestroyed(n),!0):(He(Ie,{x:e,y:t,z:s,damage:r,remainingHp:a.remaining,hitPoint:i}),this.onBlockDamaged&&this.onBlockDamaged(n,r,i),!1)}applyImpactDamage(e,t,s,o,i){const n=this.voxelColumn.getBlock(t,s,o);if(!n||n.type===Pe.BEDROCK)return!1;const r=ne[e.type].density,a=Math.floor(i*r*10);if(a<5)return!1;const l=this.voxelColumn.damageBlock(t,s,o,a);return!!l.destroyed&&(He(De,{x:t,y:s,z:o,blockType:n.type,droppedQuantity:l.droppedQuantity,hasLoot:n.hasLoot}),this.onBlockDestroyed&&this.onBlockDestroyed(n),!0)}propagateShockwave(e,t,s,o,i=!1){const{shockwaveReach:n,shockwaveDecay:r}=he;for(let a=-n;a<=n;a++)for(let l=-n;l<=n;l++){if(0===a&&0===l)continue;const n=this.voxelColumn.getBlock(e+a,t,s+l);n&&!n.hasBottomNeighbor&&(n.wobble=i?Math.max(.2,n.wobble):Math.min(1,n.wobble+o*he.wobblePerDamage*r))}{const n=this.voxelColumn.getBlock(e,t+1,s);n&&!n.hasBottomNeighbor&&(n.wobble=i?Math.max(.2,n.wobble):Math.min(1,n.wobble+o*he.wobblePerDamage*r))}{const n=this.voxelColumn.getBlock(e,t-1,s);n&&!n.hasBottomNeighbor&&(n.wobble=i?Math.max(.2,n.wobble):Math.min(1,n.wobble+o*he.wobblePerDamage*r))}}propagateShockwaveFromDestruction(e,t,s,o){this.propagateShockwave(e,t,s,o,!0)}onBlockDamage(e,t){e.hasBottomNeighbor||(e.wobble=Math.min(1,e.wobble+t*he.wobblePerDamage)),this.propagateShockwave(e.x,e.y,e.z,t)}dispose(){this.stopDrill()}}class ls{scene;particles=[];particlePool=[];geometry;materials=new Map;constructor(e){this.scene=e,this.geometry=new C(ve.geometry.boxSize,ve.geometry.boxSize,ve.geometry.boxSize),this.expandPool(ve.pool.initialSize)}expandPool(e){for(let t=0;t<e;t++){const e=new D({color:16777215}),t=new T(this.geometry,e);t.visible=!1,this.scene.add(t),this.particlePool.push(t)}}getFromPool(){const e=this.particlePool.pop();return!e&&this.particlePool.length<ve.pool.maxPoolSize?(this.expandPool(ve.pool.expandAmount),this.particlePool.pop()||null):e||null}returnToPool(e){e.visible=!1,this.particlePool.push(e)}getMaterial(e){let t=this.materials.get(e);return t||(t=new D({color:e}),this.materials.set(e,t)),t}spawnDebris(e,t,o,i,n=8){for(let r=0;r<n;r++){const n=this.getFromPool();if(!n)break;n.material=this.getMaterial(i),n.position.set(e+.5*(Math.random()-.5),t+.5*(Math.random()-.5),o+.5*(Math.random()-.5)),n.scale.setScalar(ve.debris.scaleMin+Math.random()*(ve.debris.scaleMax-ve.debris.scaleMin)),n.visible=!0;const r=new s((Math.random()-.5)*ve.debris.velocityRange,Math.random()*(ve.debris.velocityYMax-ve.debris.velocityYMin)+ve.debris.velocityYMin,(Math.random()-.5)*ve.debris.velocityRange);this.particles.push({mesh:n,velocity:r,life:1,maxLife:ve.debris.lifeMin+Math.random()*(ve.debris.lifeMax-ve.debris.lifeMin)})}}spawnHitParticles(e,t,o,i,n=4){for(let r=0;r<n;r++){const n=this.getFromPool();if(!n)break;n.material=this.getMaterial(i),n.position.set(e,t,o),n.scale.setScalar(ve.hit.scaleMin+Math.random()*(ve.hit.scaleMax-ve.hit.scaleMin)),n.visible=!0;const r=new s((Math.random()-.5)*ve.hit.velocityRange,Math.random()*(ve.hit.velocityYMax-ve.hit.velocityYMin)+ve.hit.velocityYMin,(Math.random()-.5)*ve.hit.velocityRange);this.particles.push({mesh:n,velocity:r,life:1,maxLife:ve.hit.lifeMin+Math.random()*(ve.hit.lifeMax-ve.hit.lifeMin)})}}spawnHitParticlesAtPoint(e,t,o,i,n=4){for(let r=0;r<n;r++){const n=this.getFromPool();if(!n)break;n.material=this.getMaterial(i),n.position.set(e,t,o),n.scale.setScalar(ve.hit.scaleMin+Math.random()*(ve.hit.scaleMax-ve.hit.scaleMin)),n.visible=!0;const r=new s((Math.random()-.5)*ve.hit.velocityRange*1.25,Math.random()*(ve.hit.velocityYMax-ve.hit.velocityYMin)+ve.hit.velocityYMin-.5,(Math.random()-.5)*ve.hit.velocityRange*1.25);this.particles.push({mesh:n,velocity:r,life:1,maxLife:ve.hit.lifeMin+Math.random()*(ve.hit.lifeMax-ve.hit.lifeMin)-.05})}}spawnCollectSparkle(e,t,o){for(let i=0;i<ve.collect.count;i++){const n=this.getFromPool();if(!n)break;n.material=this.getMaterial(16766720),n.position.set(e,t,o),n.scale.setScalar(.15),n.visible=!0;const r=i/ve.collect.count*Math.PI*2,a=new s(Math.cos(r)*ve.collect.velocity,ve.collect.velocityY,Math.sin(r)*ve.collect.velocity);this.particles.push({mesh:n,velocity:a,life:1,maxLife:ve.collect.life})}}update(e){for(let t=this.particles.length-1;t>=0;t--){const s=this.particles[t];if(s.life-=e/s.maxLife,s.life<=0){this.returnToPool(s.mesh),this.particles.splice(t,1);continue}s.velocity.y+=ve.debris.gravity*e,s.mesh.position.add(s.velocity.clone().multiplyScalar(e));const o=.5*s.life;s.mesh.scale.setScalar(Math.max(.1,o)),s.mesh.rotation.x+=e*ve.rotationSpeeds.x,s.mesh.rotation.y+=e*ve.rotationSpeeds.y}}clear(){for(const e of this.particles)this.returnToPool(e.mesh);this.particles=[]}dispose(){this.clear(),this.geometry.dispose();for(const e of this.materials.values())e.dispose();for(const e of this.particlePool)this.scene.remove(e)}}class cs{scene;physicsWorld;lootItems=[];goldGeometry;gemGeometry;hitGeometry;goldMaterial;gemMaterial;debugHitMaterial;hoveredLoot=null;BASE_GOLD_EMISSIVE=.2;BASE_GEM_EMISSIVE=.3;HOVER_MULTIPLIER=3;debugVisuals=!1;drone=null;droneTarget=new s;DRONE_SPEED=8;DRONE_COLLECT_RADIUS=2;constructor(e,t){this.scene=e,this.physicsWorld=t,this.goldGeometry=new P(.12,0),this.gemGeometry=new z(.15,0),this.hitGeometry=new A(ke.hitRadius,8,8),this.goldMaterial=new g({color:16766720,metalness:.8,roughness:.2,emissive:16753920,emissiveIntensity:.2}),this.gemMaterial=new g({color:65535,metalness:.9,roughness:.1,emissive:43775,emissiveIntensity:.3,transparent:!0,opacity:.9}),this.debugHitMaterial=new D({color:65280,wireframe:!0,transparent:!0,opacity:.3,depthWrite:!1}),this.debugVisuals=ts.getState().debugVisuals,Oe(De,e=>{this.handleBlockDestruction(e)})}handleBlockDestruction(e){const t=ne[e.blockType];t.lootType&&e.hasLoot&&this.spawnLoot(e.x,e.y,e.z,t.lootType,t.lootValue)}spawnFromBlock(e,t,s,o){const i=ne[o];!i.lootType||Math.random()>.5||this.spawnLoot(e,t,s,i.lootType,i.lootValue)}spawnLoot(e,t,s,o,i){const n=o===ze.GOLD?this.goldGeometry:this.gemGeometry,r=o===ze.GOLD?this.goldMaterial:this.gemMaterial,a=new T(n,r);a.position.set(e,t,s),a.castShadow=!0,this.scene.add(a);const l=new T(this.hitGeometry,this.debugHitMaterial);l.position.set(e,t,s),l.visible=this.debugVisuals,this.scene.add(l);const c={mesh:a,hitMesh:l,physicsBody:this.physicsWorld.createLoot(e,t,s,a),type:o,value:i,collected:!1};this.lootItems.push(c),He(Be,{x:e,y:t,z:s,lootType:o,value:i})}collectAtScreen(e,t,s){const o=new p,i=new m(e/window.innerWidth*2-1,-t/window.innerHeight*2+1);o.setFromCamera(i,s);const n=this.lootItems.filter(e=>!e.collected).map(e=>e.hitMesh),r=o.intersectObjects(n);if(r.length>0){const e=r[0].object,t=this.lootItems.find(t=>t.hitMesh===e);if(t)return this.collectLoot(t),t}return null}collectLoot(e){if(e.collected)return;this.hoveredLoot===e&&(this.hoveredLoot=null),e.collected=!0;const t=ts.getState();e.type===ze.GOLD?t.addGold(e.value):e.type===ze.GEM&&t.addGems(e.value),He(Ee,{lootType:e.type,value:e.value})}checkHover(e,t,s){const o=new p,i=new m(e/window.innerWidth*2-1,-t/window.innerHeight*2+1);o.setFromCamera(i,s);const n=this.lootItems.filter(e=>!e.collected).map(e=>e.hitMesh),r=o.intersectObjects(n);let a=null;if(r.length>0){const e=r[0].object;a=this.lootItems.find(t=>t.hitMesh===e)||null}this.hoveredLoot&&this.hoveredLoot!==a&&this.setLootEmissive(this.hoveredLoot,!1),a&&a!==this.hoveredLoot&&this.setLootEmissive(a,!0),this.hoveredLoot=a}setLootEmissive(e,t){const s=e.mesh.material,o=e.type===ze.GOLD?this.BASE_GOLD_EMISSIVE:this.BASE_GEM_EMISSIVE,i=t?o*this.HOVER_MULTIPLIER:o;s.emissiveIntensity=i}setHoveredLoot(e){this.hoveredLoot&&this.hoveredLoot!==e&&this.setLootEmissive(this.hoveredLoot,!1),e&&this.hoveredLoot!==e&&this.setLootEmissive(e,!0),this.hoveredLoot=e}setHoveredLootMesh(e){const t=e&&this.lootItems.find(t=>(t.mesh===e||t.hitMesh===e)&&!t.collected)||null;this.setHoveredLoot(t)}clearHover(){this.setHoveredLoot(null)}enableDrone(e){if(this.drone)return;const t=new A(.3,8,6),o=new g({color:5164484,metalness:.6,roughness:.3,emissive:2792847,emissiveIntensity:.3});this.drone=new T(t,o),this.drone.position.copy(e).add(new s(2,1,0)),this.drone.castShadow=!0,this.scene.add(this.drone),this.droneTarget.copy(this.drone.position)}disableDrone(){this.drone&&(this.scene.remove(this.drone),this.drone.geometry.dispose(),this.drone.material.dispose(),this.drone=null)}update(e,t){const s=ts.getState().debugVisuals;if(this.debugVisuals!==s){this.debugVisuals=s;for(const e of this.lootItems)e.hitMesh.visible=this.debugVisuals}this.drone&&this.updateDrone(e,t);for(let o=this.lootItems.length-1;o>=0;o--){const t=this.lootItems[o];t.collected?(t.mesh.position.y+=5*e,t.mesh.scale.multiplyScalar(.9),t.hitMesh.position.copy(t.mesh.position),t.hitMesh.scale.copy(t.mesh.scale),t.mesh.scale.x<.01&&(this.removeLoot(t),this.lootItems.splice(o,1))):(t.mesh.rotation.y+=2*e,t.mesh.rotation.x+=.5*e,t.hitMesh.position.copy(t.mesh.position),t.mesh.position.y<-100&&(this.removeLoot(t),this.lootItems.splice(o,1)))}}updateDrone(e,t){if(!this.drone)return;let s=null,o=1/0;for(const r of this.lootItems){if(r.collected)continue;const e=this.drone.position.distanceTo(r.mesh.position);e<o&&(o=e,s=r)}s&&o<10?this.droneTarget.copy(s.mesh.position):this.droneTarget.set(t.x+2,t.y+1,t.z);const i=this.droneTarget.clone().sub(this.drone.position),n=i.length();n>.1&&(i.normalize(),this.drone.position.add(i.multiplyScalar(Math.min(this.DRONE_SPEED*e,n))));for(const r of this.lootItems){if(r.collected)continue;this.drone.position.distanceTo(r.mesh.position)<this.DRONE_COLLECT_RADIUS&&this.collectLoot(r)}this.drone.position.y+=.002*Math.sin(.003*Date.now()),this.drone.rotation.y+=e}removeLoot(e){this.scene.remove(e.mesh),this.scene.remove(e.hitMesh),this.physicsWorld.scheduleRemoval(e.physicsBody)}getLootMeshes(){return this.lootItems.filter(e=>!e.collected).map(e=>e.hitMesh)}getHoveredLoot(){return this.hoveredLoot}applyFloatingOriginOffset(e){for(const t of this.lootItems)t.mesh.position.y-=e,t.hitMesh.position.y-=e;this.drone&&(this.drone.position.y-=e,this.droneTarget.y-=e)}dispose(){for(const e of this.lootItems)this.scene.remove(e.mesh),this.scene.remove(e.hitMesh);this.lootItems=[],this.goldGeometry.dispose(),this.gemGeometry.dispose(),this.hitGeometry.dispose(),this.goldMaterial.dispose(),this.gemMaterial.dispose(),this.debugHitMaterial.dispose(),this.disableDrone()}}class hs{scene;camera;damageNumbers=[];hpBars=new Map;sparkles=[];uiContainer;sparkleGeometry;sparkleMaterial;constructor(e,t){this.scene=e,this.camera=t,this.uiContainer=document.createElement("div"),this.uiContainer.id="feedback-container",this.uiContainer.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      overflow: hidden;\n      z-index: 150;\n    ",document.getElementById("app")?.appendChild(this.uiContainer),this.sparkleGeometry=new H(.15,.15),this.sparkleMaterial=new D({color:16777130,transparent:!0,opacity:1,side:O})}showDamageNumber(e,t,s,o,i=!1){const n=document.createElement("div");n.className="damage-number",n.textContent=`-${Math.round(o)}`,n.style.cssText=`\n      position: absolute;\n      font-family: 'Arial Black', sans-serif;\n      font-size: ${i?`${be.damageNumbers.critSize}px`:`${be.damageNumbers.normalSize}px`};\n      font-weight: bold;\n      color: ${i?be.damageNumbers.critColor:be.damageNumbers.normalColor};\n      text-shadow: 2px 2px 4px rgba(0,0,0,0.8), -1px -1px 2px rgba(0,0,0,0.5);\n      pointer-events: none;\n      transform: translate(-50%, -50%);\n      z-index: 160;\n      ${i?"animation: critPop 0.3s ease-out;":""}\n    `,this.uiContainer.appendChild(n);const r=this.worldToScreen(e,t+.5,s);this.damageNumbers.push({element:n,startTime:Date.now(),startY:r.y,x:r.x,y:r.y})}showHPBar(e,t,s,o,i){const n=`${e},${t},${s}`;let r=this.hpBars.get(n);if(!r){const a=document.createElement("div");a.className="hp-bar-container",a.style.cssText=`\n        position: absolute;\n        width: ${be.hpBars.width}px;\n        height: ${be.hpBars.height}px;\n        background: rgba(0, 0, 0, 0.7);\n        border-radius: ${be.hpBars.borderRadius}px;\n        transform: translate(-50%, -50%);\n        overflow: hidden;\n        border: 1px solid rgba(255,255,255,0.3);\n        opacity: 0;\n        transition: opacity ${be.hpBars.hideDuration}s ease-out;\n        z-index: 155;\n      `;const l=document.createElement("div");l.className="hp-bar-fill",l.style.cssText=`\n        width: 100%;\n        height: 100%;\n        background: ${be.hpBars.colorHigh};\n        transition: width 0.15s ease-out;\n        border-radius: ${be.hpBars.cornerRadius}px;\n      `,a.appendChild(l),this.uiContainer.appendChild(a),r={container:a,fill:l,blockKey:n,x:e,y:t,z:s,startTime:Date.now(),maxHp:i,currentHp:o},this.hpBars.set(n,r)}r.currentHp=o,r.startTime=Date.now();const a=Math.max(0,o/i*100);r.fill.style.width=`${a}%`,a<be.hpBars.thresholdMedium?r.fill.style.background=be.hpBars.colorLow:a<be.hpBars.thresholdHigh?r.fill.style.background=be.hpBars.colorMedium:r.fill.style.background=be.hpBars.colorHigh}removeHPBar(e,t,s){const o=`${e},${t},${s}`,i=this.hpBars.get(o);i&&(i.container.remove(),this.hpBars.delete(o))}spawnSparkles(e,t,o,i=16777130){const n=be.sparkles.count+Math.floor(4*Math.random());for(let r=0;r<n;r++){const n=new D({color:i,transparent:!0,opacity:1,side:O}),r=new T(this.sparkleGeometry.clone(),n);r.position.set(e+.3*(Math.random()-.5),t+.3*(Math.random()-.5),o+.3*(Math.random()-.5)),r.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),this.scene.add(r);const a=new s((Math.random()-.5)*be.sparkles.velocityRange,Math.random()*(be.sparkles.velocityYMax-be.sparkles.velocityYMin)+be.sparkles.velocityYMin,(Math.random()-.5)*be.sparkles.velocityRange);this.sparkles.push({mesh:r,velocity:a,life:be.sparkles.life+Math.random()*be.sparkles.lifeVariation})}}worldToScreen(e,t,o){const i=new s(e,t,o);return i.project(this.camera),{x:(i.x+1)/2*window.innerWidth,y:(1-i.y)/2*window.innerHeight}}updateCamera(e){this.camera=e}update(e){const t=Date.now();for(let s=this.damageNumbers.length-1;s>=0;s--){const e=this.damageNumbers[s],o=(t-e.startTime)/1e3;if(o>be.damageNumbers.duration){e.element.remove(),this.damageNumbers.splice(s,1);continue}const i=o*be.damageNumbers.floatSpeed,n=1-o/be.damageNumbers.duration;e.element.style.left=`${e.x}px`,e.element.style.top=e.startY-i+"px",e.element.style.opacity=`${n}`}for(const[s,o]of this.hpBars){const e=(t-o.startTime)/1e3;if(e>be.hpBars.showDuration)o.container.style.opacity="0",e>be.hpBars.showDuration+be.hpBars.hideDuration&&(o.container.remove(),this.hpBars.delete(s));else{o.container.style.opacity="1";const e=this.worldToScreen(o.x,o.y+.7,o.z);o.container.style.left=`${e.x}px`,o.container.style.top=`${e.y}px`}}for(let s=this.sparkles.length-1;s>=0;s--){const t=this.sparkles[s];if(t.life-=e,t.life<=0){this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.sparkles.splice(s,1);continue}t.velocity.y+=be.sparkles.gravity*e,t.mesh.position.add(t.velocity.clone().multiplyScalar(e)),t.mesh.rotation.x+=e*be.sparkles.rotationSpeedX,t.mesh.rotation.z+=e*be.sparkles.rotationSpeedZ;const o=t.life*(be.sparkles.scaleMax/be.sparkles.life);t.mesh.scale.setScalar(Math.max(be.sparkles.scaleMin,o)),t.mesh.material.opacity=Math.min(1,3*t.life)}}dispose(){for(const e of this.damageNumbers)e.element.remove();this.damageNumbers=[];for(const[,e]of this.hpBars)e.container.remove();this.hpBars.clear();for(const e of this.sparkles)this.scene.remove(e.mesh),e.mesh.geometry.dispose(),e.mesh.material.dispose();this.sparkles=[],this.uiContainer.remove(),this.sparkleGeometry.dispose(),this.sparkleMaterial.dispose()}}const us=document.createElement("style");us.textContent="\n  @keyframes critPop {\n    0% { transform: translate(-50%, -50%) scale(0.5); }\n    50% { transform: translate(-50%, -50%) scale(1.3); }\n    100% { transform: translate(-50%, -50%) scale(1); }\n  }\n",document.head.appendChild(us);const ds={gold:{sprite:"./textures/gold_1.png",value:10,scale:1},stone:{sprite:"./textures/stone_1.png",value:2,scale:1},iron:{sprite:"./textures/stone_3.png",value:5,scale:1},diamond:{sprite:"./textures/stone_5.png",value:25,scale:1}},ps={[Pe.DIRT]:"stone",[Pe.STONE]:"stone",[Pe.IRON_ORE]:"iron",[Pe.GOLD_ORE]:"gold",[Pe.DIAMOND_ORE]:"diamond"};class ms{scene;camera;physicsWorld;voxelColumn;resources=[];textureLoader;loadedTextures=new Map;hitGeometry;debugHitMaterial;collectingResources=[];hoveredResource=null;HOVER_SCALE=1.3;debugVisuals=!1;constructor(e,t,s,o){this.scene=e,this.camera=t,this.physicsWorld=s,this.voxelColumn=o,this.textureLoader=new F,this.hitGeometry=new A(ke.resourceHitRadius,8,8),this.debugHitMaterial=new D({color:16711935,wireframe:!0,transparent:!0,opacity:.3,depthWrite:!1}),this.debugVisuals=ts.getState().debugVisuals,this.preloadTextures(),Oe(De,e=>{this.handleBlockDestruction(e)})}preloadTextures(){for(const[e,t]of Object.entries(ds))this.textureLoader.load(t.sprite,t=>{t.magFilter=M,t.minFilter=M,this.loadedTextures.set(e,t)})}handleBlockDestruction(e){if(e.droppedQuantity<=0)return;const t=ps[e.blockType];if(t)for(let s=0;s<e.droppedQuantity;s++)this.spawnResource(t,e.x,e.y,e.z)}tryDropResource(e,t,s,o){return!1}spawnResource(e,t,s,o){const i=ds[e];if(!i)return;const n=this.loadedTextures.get(e),r=new Y({map:n||void 0,color:n?16777215:this.getFallbackColor(e),transparent:!0,alphaTest:.5}),a=new V(r);a.position.set(t,s,o),a.scale.setScalar(i.scale),this.scene.add(a);const l=new D({color:0});l.colorWrite=!1,l.depthWrite=!1;const c=new A(.25*i.scale,16,16),h=new T(c,l);h.castShadow=!0,h.receiveShadow=!1,h.visible=!0,a.add(h);const u=new T(this.hitGeometry,this.debugHitMaterial);u.position.copy(a.position),u.visible=this.debugVisuals,this.scene.add(u);const d=this.physicsWorld.createResource(t,s,o);this.resources.push({sprite:a,hitMesh:u,shadowSphere:h,type:e,value:i.value,physicsBody:d,settled:!1,settledFrames:0,collected:!1,collectAnimProgress:0})}getFallbackColor(e){return{gold:16766720,stone:8947848,iron:13935988,diamond:65535}[e]||16777215}tryCollectAt(e,t){const s=new p,o=new m(e/window.innerWidth*2-1,-t/window.innerHeight*2+1);s.setFromCamera(o,this.camera);const i=this.resources.filter(e=>!e.collected&&(!!e.settled&&this.isResourceOnBlock(e))).map(e=>e.sprite),n=s.intersectObjects(i);if(n.length>0){const e=n[0].object,t=this.resources.find(t=>t.sprite===e);if(t&&!t.collected)return this.collectResource(t),t}return null}isResourceOnBlock(e){if(!e.physicsBody)return!1;const t=e.physicsBody.rigidBody.translation(),s=Math.round(t.x),o=Math.floor(t.y-.1),i=Math.round(t.z),n=this.voxelColumn.getBlock(s,o,i);return void 0!==n&&n.type!==Pe.AIR}checkHover(e,t){const s=new p,o=new m(e/window.innerWidth*2-1,-t/window.innerHeight*2+1);s.setFromCamera(o,this.camera);const i=this.resources.filter(e=>!e.collected).map(e=>e.sprite),n=s.intersectObjects(i);let r=null;if(n.length>0){const e=n[0].object;r=this.resources.find(t=>t.sprite===e)||null}this.hoveredResource&&this.hoveredResource!==r&&this.setResourceHover(this.hoveredResource,!1),r&&r!==this.hoveredResource&&this.setResourceHover(r,!0),this.hoveredResource=r}setResourceHover(e,t){const s=ds[e.type],o=t?s.scale*this.HOVER_SCALE:s.scale;e.sprite.scale.setScalar(o)}setHoveredResource(e){this.hoveredResource&&this.hoveredResource!==e&&this.setResourceHover(this.hoveredResource,!1),e&&this.hoveredResource!==e&&this.setResourceHover(e,!0),this.hoveredResource=e}setHoveredResourceTarget(e){const t=e&&this.resources.find(t=>t.hitMesh===e&&!t.collected)||null;this.setHoveredResource(t)}setHoveredResourceSprite(e){const t=e&&this.resources.find(t=>t.sprite===e&&!t.collected)||null;this.setHoveredResource(t)}clearHover(){this.setHoveredResource(null)}collectResource(e){if(e.collected)return;this.hoveredResource===e&&(this.setResourceHover(e,!1),this.hoveredResource=null),e.collected=!0,e.collectAnimProgress=0,this.collectingResources.push(e);ts.getState().addGold(e.value),this.playCollectSound()}playCollectSound(){this.pulseGoldIcon()}pulseGoldIcon(){const e=document.getElementById("gold-counter");e&&(e.style.transform="scale(1.3)",e.style.transition="transform 0.15s ease-out",setTimeout(()=>{e.style.transform="scale(1)"},150))}updateCamera(e){this.camera=e}getResourceTargets(){return this.resources.filter(e=>e.settled&&!e.collected).map(e=>e.hitMesh)}getHoveredResource(){return this.hoveredResource}update(e){const t=ts.getState().debugVisuals;if(this.debugVisuals!==t){this.debugVisuals=t;for(const e of this.resources)e.hitMesh.visible=this.debugVisuals}for(const s of this.resources)if(!s.collected&&s.physicsBody){const e=s.physicsBody.rigidBody.translation();s.sprite.position.set(e.x,e.y,e.z),s.hitMesh.position.copy(s.sprite.position);const t=s.physicsBody.rigidBody.linvel();Math.abs(t.y)<1?(s.settledFrames++,s.settledFrames>=5&&(s.settled||(s.settled=!0,He(Re,{x:e.x,y:e.y,z:e.z,resourceType:s.type})))):(s.settledFrames=0,s.settled=!1)}for(let s=this.collectingResources.length-1;s>=0;s--){const t=this.collectingResources[s];if(t.collectAnimProgress+=3*e,t.collectAnimProgress>=1){this.scene.remove(t.sprite),this.scene.remove(t.hitMesh),t.sprite.material.dispose(),t.physicsBody&&this.physicsWorld.scheduleRemoval(t.physicsBody);const e=this.resources.indexOf(t);-1!==e&&this.resources.splice(e,1),this.collectingResources.splice(s,1),this.pulseGoldIcon();continue}const o=(1-t.collectAnimProgress)*(ds[t.type]?.scale||.4);t.sprite.scale.setScalar(Math.max(.1,o)),t.sprite.position.y+=8*e,t.sprite.position.x+=2*e,t.sprite.material.opacity=1-t.collectAnimProgress}}applyFloatingOriginOffset(e){for(const t of this.resources)if(t.sprite.position.y-=e,t.hitMesh.position.y-=e,t.physicsBody){const s=t.physicsBody.rigidBody.translation();t.physicsBody.rigidBody.setTranslation({x:s.x,y:s.y-e,z:s.z},!0)}}createDebugGizmos(){for(const e of this.resources)e.hitMesh.visible=!0}removeDebugGizmos(){for(const e of this.resources)e.hitMesh.visible=!1}updateDebugGizmos(){}dispose(){for(const e of this.resources)this.scene.remove(e.sprite),this.scene.remove(e.hitMesh),e.sprite.material.dispose();this.resources=[],this.hitGeometry.dispose(),this.debugHitMaterial.dispose();for(const[,e]of this.loadedTextures)e.dispose();this.loadedTextures.clear()}}class gs{clusters=new Map;scene;voxelColumn;clusterMeshes=new Map;constructor(e,t){this.scene=e,this.voxelColumn=t}createCluster(e){const t=Math.random().toString(36).substr(2,9),o=new s;for(const s of e)o.x+=s.gridX,o.y+=s.gridY,o.z+=s.gridZ;o.divideScalar(e.length);for(const s of e)s.localX=s.gridX-o.x,s.localY=s.gridY-o.y,s.localZ=s.gridZ-o.z;const i={id:t,blocks:e,position:o,velocity:0,isLanding:!1};return this.clusters.set(t,i),this.createClusterMesh(i),this.playTransitionAnimation(i),t}playTransitionAnimation(e){const t=j,s=.5*t.bounceDuration;let o=0;const i=()=>{if(!this.clusters.has(e.id)||e.isLanding)return;const n=this.clusterMeshes.get(e.id);if(!n)return;o+=1/60;const r=Math.min(o/s,1),a=Math.sin(Math.PI*r)*(.5*t.bounceHeight);n.position.copy(e.position),n.position.y+=a,r<1?requestAnimationFrame(i):n.position.copy(e.position)};requestAnimationFrame(i)}createClusterMesh(e){const t=new S;t.position.copy(e.position);for(const s of e.blocks){const e=new C(.95,.95,.95),o=new g({color:ne[s.type].color,roughness:.7,metalness:.1}),i=new T(e,o);i.position.set(s.localX,s.localY,s.localZ),i.castShadow=!0,i.receiveShadow=!0,t.add(i)}this.scene.add(t),this.clusterMeshes.set(e.id,t)}update(e){const t=j;for(const[s,o]of this.clusters){if(o.isLanding)continue;const i=t.fallSpeed*e,n=o.position.y-i,r=this.calculateLandingY(o);if(n<=r){o.position.y=r;const e=this.clusterMeshes.get(s);e&&e.position.copy(o.position),this.handleLanding(o)}else{o.position.y=n;const e=this.clusterMeshes.get(s);e&&e.position.copy(o.position)}}}calculateLandingY(e){let t=-2e3;for(const s of e.blocks){const o=Math.floor(e.position.x+s.localX)+.5,i=Math.floor(e.position.z+s.localZ)+.5;let n=-1e3;for(let t=Math.round(e.position.y+s.localY)-1;t>-1e3;t--){const e=this.voxelColumn.getBlock(o,t,i);if(e&&e.type!==Pe.AIR){n=t+1;break}}const r=n-s.localY;t=Math.max(t,r)}return t}handleLanding(e){e.isLanding=!0;const t=this.clusterMeshes.get(e.id);t&&(t.position.copy(e.position),this.playBounceAnimation(e,()=>{this.finalizeLanding(e)}))}playBounceAnimation(e,t){const s=j,o=s.bounceDuration;let i=0;const n=()=>{if(!this.clusters.has(e.id))return;const r=this.clusterMeshes.get(e.id);if(!r)return;i+=1/60;const a=Math.min(i/o,1),l=Math.sin(Math.PI*a)*s.bounceHeight;r.position.copy(e.position),r.position.y+=l,a<1?requestAnimationFrame(n):(r.position.copy(e.position),t())};requestAnimationFrame(n)}finalizeLanding(e){const t=j.impactDamageMultiplier;for(const o of e.blocks){const s=Math.floor(e.position.x+o.localX)+.5,i=Math.round(e.position.y+o.localY),n=Math.floor(e.position.z+o.localZ)+.5;o.hp-=t,o.hp<=0?He(De,{x:s,y:i,z:n,blockType:o.type,droppedQuantity:o.resourceQuantity,hasLoot:o.hasLoot}):(this.voxelColumn.setBlockFromData({type:o.type,hp:o.hp,initialHp:o.initialHp,initialResourceQuantity:o.initialResourceQuantity,resourceQuantity:o.resourceQuantity,hasLoot:o.hasLoot,x:s,y:i,z:n,isStatic:!0}),He(Le,{x:s,y:i,z:n}))}const s=this.clusterMeshes.get(e.id);s&&(this.scene.remove(s),s.traverse(e=>{e instanceof T&&(e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),this.clusterMeshes.delete(e.id)),this.clusters.delete(e.id)}applyFloatingOriginOffset(e){if(0!==e)for(const t of this.clusters.values()){t.position.y-=e;const s=this.clusterMeshes.get(t.id);s&&s.position.copy(t.position)}}}class ys{loadingScreen;loadingBar;loadingText;uiOverlay;goldValue;depthValue;fuelBar;heroPortrait;toolSlots;turboBtn;shopBtn;shopModal;shopClose;shopItems;blockDebugPanel;attackAnimTimeout=null;constructor(){this.loadingScreen=document.getElementById("loading"),this.loadingBar=document.getElementById("loading-bar"),this.loadingText=document.getElementById("loading-text"),this.uiOverlay=document.getElementById("ui-overlay"),this.goldValue=document.getElementById("gold-value"),this.depthValue=document.getElementById("depth-value"),this.fuelBar=document.getElementById("fuel-bar"),this.heroPortrait=document.getElementById("hero-portrait"),this.toolSlots=document.querySelectorAll(".tool-slot"),this.turboBtn=document.getElementById("turbo-btn"),this.shopBtn=document.getElementById("shop-btn"),this.shopModal=document.getElementById("shop-modal"),this.shopClose=document.getElementById("shop-close"),this.shopItems=document.querySelectorAll(".shop-item-btn"),this.blockDebugPanel=document.getElementById("block-debug-panel"),this.setupEventListeners(),this.setupGameEventListeners()}setupEventListeners(){this.toolSlots.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tool;t&&this.selectTool(t)})}),this.turboBtn.addEventListener("click",()=>{const e=ts.getState();e.turboActive?(e.deactivateTurbo(),this.turboBtn.classList.remove("active")):e.turboFuel>0&&(e.activateTurbo(),this.turboBtn.classList.add("active"))}),this.shopBtn.addEventListener("click",()=>{this.openShop()}),this.shopClose.addEventListener("click",()=>{this.closeShop()}),this.shopModal.addEventListener("click",e=>{e.target===this.shopModal&&this.closeShop()}),this.shopItems.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.upgrade;this.handleUpgrade(t)})})}setupGameEventListeners(){Oe(Ee,()=>{this.updateGold(),this.flashGoldCounter()})}setLoadingProgress(e,t){this.loadingBar.style.width=`${e}%`,this.loadingText.textContent=t}hideLoading(){this.loadingScreen.classList.add("hidden"),this.uiOverlay.classList.remove("hidden")}update(){const e=ts.getState();this.goldValue.textContent=e.gold.toString(),this.depthValue.textContent=Math.floor(e.depth).toString();const t=e.fuel/e.maxFuel*100;this.fuelBar.style.width=`${t}%`,e.turboActive&&!this.turboBtn.classList.contains("active")?this.turboBtn.classList.add("active"):!e.turboActive&&this.turboBtn.classList.contains("active")&&this.turboBtn.classList.remove("active"),e.turboFuel<=0?this.turboBtn.style.opacity="0.5":this.turboBtn.style.opacity="1"}updateGold(){const e=ts.getState();this.goldValue.textContent=e.gold.toString()}flashGoldCounter(){const e=document.getElementById("gold-counter");e.style.transform="scale(1.2)",setTimeout(()=>{e.style.transform="scale(1)"},100)}selectTool(e){ts.getState().setCurrentTool(e),this.toolSlots.forEach(t=>{t.dataset.tool===e?t.classList.add("active"):t.classList.remove("active")});const t={[Ae.PICKAXE]:"",[Ae.SHOVEL]:"",[Ae.DRILL]:""};this.heroPortrait.textContent=t[e]}playAttackAnimation(){this.attackAnimTimeout&&clearTimeout(this.attackAnimTimeout),this.heroPortrait.style.transform="scale(1.2) rotate(10deg)",this.heroPortrait.style.borderColor="#ff6b35",this.attackAnimTimeout=window.setTimeout(()=>{this.heroPortrait.style.transform="scale(1) rotate(0deg)",this.heroPortrait.style.borderColor="#ffd700"},100)}openShop(){this.shopModal.classList.add("open"),this.updateShopPrices()}closeShop(){this.shopModal.classList.remove("open")}updateShopPrices(){const e=ts.getState();this.shopItems.forEach(t=>{let s=0,o=!1;switch(t.dataset.upgrade){case"damage":s=function(){const e=ts.getState();return Math.floor(ae.damage.baseCost*Math.pow(ae.damage.costMultiplier,e.damageLevel))}();break;case"turbo":s=os.TURBO_FUEL;break;case"drone":s=os.DRONE,o=e.hasDrone}t.textContent=o?"OWNED":` ${s}`,t.disabled=e.gold<s||o})}handleUpgrade(e){const t=ts.getState();let s=!1;switch(e){case"damage":s=t.upgradeDamage();break;case"turbo":s=t.buyTurboFuel();break;case"drone":s=t.buyDrone()}s&&(this.updateShopPrices(),this.updateGold(),window.dispatchEvent(new CustomEvent("upgrade:purchased",{detail:{upgrade:e}})))}getCurrentTool(){return ts.getState().currentTool}updateBlockDebugInfo(e){if(!this.blockDebugPanel)return;if(!ts.getState().debugMode||!e)return this.blockDebugPanel.classList.remove("open"),void this.blockDebugPanel.classList.add("hidden");this.blockDebugPanel.classList.remove("hidden"),this.blockDebugPanel.classList.add("open");const t=e.hasBottomNeighbor?"":(e.gripForce*(1-e.wobble)*e.sideNeighborCount*.25).toFixed(2),s=document.getElementById("debug-block-type"),o=document.getElementById("debug-block-pos"),i=document.getElementById("debug-block-hp"),n=document.getElementById("debug-block-stability"),r=document.getElementById("debug-block-wobble"),a=document.getElementById("debug-block-neighbors"),l=document.getElementById("debug-block-cluster"),c=document.getElementById("debug-block-grip");s.textContent=Pe[e.type],o.textContent=`(${e.x}, ${e.y}, ${e.z})`,i.textContent=`${e.hp.toFixed(0)}/${ne[e.type].hp}`,n.textContent=t,r.textContent=e.wobble.toFixed(2),a.textContent=`${e.sideNeighborCount} (side: ${e.hasSideNeighbors}, bottom: ${e.hasBottomNeighbor})`,l.textContent=e.clusterId.toString(),c.textContent=e.gripForce.toFixed(1)}dispose(){this.attackAnimTimeout&&clearTimeout(this.attackAnimTimeout)}}class fs{panel;perfPanel;closeBtn;hemiIntensitySlider;hemiIntensityValue;hemiColorPicker;sunIntensitySlider;sunIntensityValue;sunColorPicker;rimIntensitySlider;rimIntensityValue;rimColorPicker;exposureSlider;exposureValue;debugVisualsCheckbox;perfFps;perfMeshes;perfPolys;perfMemory;perfCanvas;perfCtx;frameTimes=[];physicsTimes=[];renderTimes=[];maxHistory=100;getLightParams;setLightParams;toggleDebugVisuals;constructor(e,t,s){this.getLightParams=e,this.setLightParams=t,this.toggleDebugVisuals=s,this.panel=document.getElementById("debug-panel"),this.perfPanel=document.getElementById("perf-panel"),this.closeBtn=document.getElementById("debug-close"),this.hemiIntensitySlider=document.getElementById("debug-hemi-intensity-slider"),this.hemiIntensityValue=document.getElementById("debug-hemi-intensity"),this.hemiColorPicker=document.getElementById("debug-hemi-color"),this.sunIntensitySlider=document.getElementById("debug-sun-intensity-slider"),this.sunIntensityValue=document.getElementById("debug-sun-intensity"),this.sunColorPicker=document.getElementById("debug-sun-color"),this.rimIntensitySlider=document.getElementById("debug-rim-intensity-slider"),this.rimIntensityValue=document.getElementById("debug-rim-intensity"),this.rimColorPicker=document.getElementById("debug-rim-color"),this.exposureSlider=document.getElementById("debug-exposure-slider"),this.exposureValue=document.getElementById("debug-exposure"),this.debugVisualsCheckbox=document.getElementById("perf-visuals-checkbox"),this.perfFps=document.getElementById("perf-fps"),this.perfMeshes=document.getElementById("perf-meshes"),this.perfPolys=document.getElementById("perf-polys"),this.perfMemory=document.getElementById("perf-memory"),this.perfCanvas=document.getElementById("perf-graph"),this.perfCtx=this.perfCanvas.getContext("2d"),this.perfCanvas.width=this.perfCanvas.clientWidth,this.perfCanvas.height=this.perfCanvas.clientHeight,this.setupEventListeners(),this.setupKeyboardListener()}setupEventListeners(){this.closeBtn.addEventListener("click",()=>this.toggle(!1)),this.hemiIntensitySlider.addEventListener("input",()=>{const e=parseFloat(this.hemiIntensitySlider.value);this.hemiIntensityValue.textContent=e.toFixed(1),this.setLightParams({hemiIntensity:e})}),this.hemiColorPicker.addEventListener("input",()=>{const e=parseInt(this.hemiColorPicker.value.replace("#",""),16);this.setLightParams({hemiSkyColor:e})}),this.sunIntensitySlider.addEventListener("input",()=>{const e=parseFloat(this.sunIntensitySlider.value);this.sunIntensityValue.textContent=e.toFixed(2),this.setLightParams({sunIntensity:e})}),this.sunColorPicker.addEventListener("input",()=>{const e=parseInt(this.sunColorPicker.value.replace("#",""),16);this.setLightParams({sunColor:e})}),this.rimIntensitySlider.addEventListener("input",()=>{const e=parseFloat(this.rimIntensitySlider.value);this.rimIntensityValue.textContent=e.toFixed(2),this.setLightParams({rimIntensity:e})}),this.rimColorPicker.addEventListener("input",()=>{const e=parseInt(this.rimColorPicker.value.replace("#",""),16);this.setLightParams({rimColor:e})}),this.exposureSlider.addEventListener("input",()=>{const e=parseFloat(this.exposureSlider.value);this.exposureValue.textContent=e.toFixed(1),this.setLightParams({exposure:e})}),this.debugVisualsCheckbox.addEventListener("change",()=>{this.toggleDebugVisuals()})}setupKeyboardListener(){window.addEventListener("keydown",e=>{"`"===e.key&&(e.preventDefault(),this.toggle())})}toggle(e){const t=this.panel.classList.contains("open");(void 0!==e?e:!t)?(this.panel.classList.add("open"),this.syncUI()):this.panel.classList.remove("open")}syncUI(){const e=this.getLightParams();this.hemiIntensitySlider.value=e.hemiIntensity.toString(),this.hemiIntensityValue.textContent=e.hemiIntensity.toFixed(1),this.hemiColorPicker.value="#"+e.hemiSkyColor.toString(16).padStart(6,"0"),this.sunIntensitySlider.value=e.sunIntensity.toString(),this.sunIntensityValue.textContent=e.sunIntensity.toFixed(2),this.sunColorPicker.value="#"+e.sunColor.toString(16).padStart(6,"0"),this.rimIntensitySlider.value=e.rimIntensity.toString(),this.rimIntensityValue.textContent=e.rimIntensity.toFixed(2),this.rimColorPicker.value="#"+e.rimColor.toString(16).padStart(6,"0"),this.exposureSlider.value=e.exposure.toString(),this.exposureValue.textContent=e.exposure.toFixed(1)}updatePerformance(e){this.perfFps.textContent=e.fps.toFixed(0),this.perfMeshes.textContent=e.meshes.toString(),e.triangles<1e3?this.perfPolys.textContent=e.triangles.toString():e.triangles<1e6?this.perfPolys.textContent=(e.triangles/1e3).toFixed(1)+"k":this.perfPolys.textContent=(e.triangles/1e6).toFixed(2)+"M",this.perfMemory.textContent=e.memory>0?e.memory.toFixed(1)+" MB":"N/A",this.frameTimes.push(e.frameTime),this.physicsTimes.push(e.physicsTime),this.renderTimes.push(e.renderTime),this.frameTimes.length>this.maxHistory&&(this.frameTimes.shift(),this.physicsTimes.shift(),this.renderTimes.shift()),this.perfPanel.classList.contains("open")&&this.drawGraphs()}showPerformance(e){e?(this.perfPanel.classList.add("open"),this.perfCanvas.width=this.perfPanel.clientWidth||140,this.perfCanvas.height=30):this.perfPanel.classList.remove("open")}setDebugVisuals(e){this.debugVisualsCheckbox&&(this.debugVisualsCheckbox.checked=e)}drawGraphs(){const e=this.perfCtx,t=this.perfCanvas.width,s=this.perfCanvas.height;e.clearRect(0,0,t,s);const o=Math.max(16.6,...this.frameTimes),i=s/(1.2*o),n=t/(this.maxHistory-1);e.strokeStyle="#333",e.lineWidth=1,e.beginPath(),e.moveTo(0,s-16.6*i),e.lineTo(t,s-16.6*i),e.stroke();const r=(t,o,r)=>{if(!(t.length<2)){e.strokeStyle=o,e.lineWidth=r,e.beginPath();for(let o=0;o<t.length;o++){const r=o*n,a=s-t[o]*i;0===o?e.moveTo(r,a):e.lineTo(r,a)}e.stroke()}};r(this.frameTimes,"#4ecdc4",2),r(this.physicsTimes,"#ff6b6b",1),r(this.renderTimes,"#f7c531",1)}show(){this.toggle(!0)}dispose(){this.closeBtn.removeEventListener("click",()=>this.toggle(!1))}}class vs{renderer;inputManager;voxelColumn;physicsWorld;stabilitySystem;toolSystem;particleSystem;lootSystem;feedbackSystem;resourceDropSystem;clusterSystem;uiManager;debugController;pointerInteractions=new Map;fallingBlocks=new Map;fallingBlockMaterial;hoveredBlock=null;lastPointerX=0;lastPointerY=0;isInitialized=!1;currentDepth=0;frameCount=0;isPaused=!1;constructor(){this.renderer=new Se,this.physicsWorld=new ns,this.voxelColumn=new is,this.stabilitySystem=new rs(this.voxelColumn),this.toolSystem=new as(this.voxelColumn),this.particleSystem=new ls(this.renderer.scene),this.lootSystem=new cs(this.renderer.scene,this.physicsWorld),this.feedbackSystem=new hs(this.renderer.scene,this.renderer.cameraController.camera),this.resourceDropSystem=new ms(this.renderer.scene,this.renderer.cameraController.camera,this.physicsWorld,this.voxelColumn),this.clusterSystem=new gs(this.renderer.scene,this.voxelColumn),this.uiManager=new ys,this.debugController=new fs(()=>this.renderer.getLightParams(),e=>this.renderer.setLightParams(e),()=>this.toggleDebugVisuals()),this.fallingBlockMaterial=new g({color:10066329,roughness:.7,metalness:.1});const e=document.getElementById("game-canvas");this.inputManager=new Ce(e,{onPointerDown:this.handlePointerDown.bind(this),onPointerMove:this.handlePointerMove.bind(this),onPointerUp:this.handlePointerUp.bind(this),onHoldStart:this.handleHoldStart.bind(this),onHoldEnd:this.handleHoldEnd.bind(this),onRotateStep:this.handleRotateStep.bind(this),onVerticalScroll:this.handleVerticalScroll.bind(this)}),this.toolSystem.onBlockDestroyed=this.handleBlockDestroyed.bind(this),this.toolSystem.onBlockDamaged=this.handleBlockDamaged.bind(this),Oe(Re,()=>{this.refreshAllHoverStates()}),Oe(De,e=>{this.refreshAllHoverStates();const t=ne[e.blockType].color;this.particleSystem.spawnDebris(e.x,e.y,e.z,t,10),this.feedbackSystem.removeHPBar(e.x,e.y,e.z),this.toolSystem.propagateShockwaveFromDestruction(e.x,e.y,e.z,10),this.stabilitySystem.queueCheck(e.x,e.y,e.z),this.processUnstableClusters()}),Oe(Be,()=>{this.refreshAllHoverStates()}),Oe(Ee,()=>{this.refreshAllHoverStates()}),window.addEventListener("upgrade:purchased",this.handleUpgrade.bind(this)),window.addEventListener("blur",()=>this.setPaused(!0)),window.addEventListener("focus",()=>this.setPaused(!1)),document.addEventListener("visibilitychange",()=>{this.setPaused(document.hidden)})}setPaused(e){if(!this.isInitialized)return;const t=e||document.hidden||!document.hasFocus();t&&!this.isPaused?(this.isPaused=!0,this.renderer.stop(),this.inputManager.reset(),this.pointerInteractions.clear(),this.toolSystem.stopDrill(),console.log("Game paused")):!t&&this.isPaused&&(this.isPaused=!1,this.renderer.start(),console.log("Game resumed"))}async init(){this.uiManager.setLoadingProgress(10,"Initializing physics..."),await this.physicsWorld.init(this.renderer.scene),this.uiManager.setLoadingProgress(30,"Generating world..."),this.voxelColumn.generateInitialColumn(),this.renderer.add(this.voxelColumn.group),this.uiManager.setLoadingProgress(60,"Setting up scene..."),this.createPhysicsForBlocks(),this.uiManager.setLoadingProgress(80,"Finalizing..."),this.renderer.setUpdateCallback(this.update.bind(this)),this.uiManager.update(),this.uiManager.setLoadingProgress(100,"Ready!"),await new Promise(e=>setTimeout(e,300)),this.uiManager.hideLoading(),this.isInitialized=!0;const e=ts.getState(),t=e.debugVisuals,s=e.debugMode;this.debugController.setDebugVisuals(t),s&&this.debugController.showPerformance(!0),t&&(this.physicsWorld.createWallVisualization(),this.resourceDropSystem.createDebugGizmos(),this.voxelColumn.updateAirMeshVisibility(!0)),this.renderer.start(),document.hidden&&this.setPaused(!0)}createPhysicsForBlocks(){const e=this.voxelColumn.getAllBlocks();for(const t of e)t.type!==Pe.AIR&&this.physicsWorld.createStaticBlock(t.x,t.y,t.z,t)}update(e){if(!this.isInitialized||this.isPaused)return;const t=performance.now(),s=performance.now();this.physicsWorld.step(e);const o=performance.now()-s;this.voxelColumn.updateChunkVisibility(this.renderer.cameraController.camera),this.particleSystem.update(e);const i=this.renderer.cameraController.getWorldPosition();this.lootSystem.update(e,i),this.feedbackSystem.update(e),this.resourceDropSystem.update(e),this.clusterSystem.update(e);ts.getState().debugVisuals&&this.resourceDropSystem.updateDebugGizmos();const n=this.voxelColumn.getAllBlocks();for(const c of n)!c.hasBottomNeighbor&&c.wobble>0&&(c.wobble=Math.max(0,c.wobble-he.wobbleDecayRate*e));this.updateDepth(),this.updateTurbo(e);const r=performance.now();this.voxelColumn.updateInstancedMeshes();const a=performance.now()-r;this.voxelColumn.updateShaking(e),this.uiManager.update(),this.checkFloatingOrigin();const l=performance.now()-t;this.frameCount++;if(ts.getState().debugMode&&this.frameCount%10==0){const e=this.renderer.getMetrics();this.debugController.updatePerformance({...e,frameTime:l,physicsTime:o,renderTime:a})}}updateDepth(){let e=0;for(let t=0;t>-2e3;t--){let s=!1;for(let e=ce.minX;e<=ce.maxX;e++){for(let o=ce.minZ;o<=ce.maxZ;o++){const i=this.voxelColumn.getBlock(e,t,o);if(!i||i.type===Pe.AIR){s=!0;break}}if(s)break}if(!s)break;e=-t}e!==this.currentDepth&&(this.currentDepth=e,ts.getState().setDepth(e),this.renderer.cameraController.setDepth(.5*e,e+5),e>ce.initialHeight-10&&this.voxelColumn.extendColumn(e+20))}updateTurbo(e){const t=ts.getState();t.turboActive&&(t.consumeTurboFuel(10*e),t.turboFuel<=0?this.renderer.disableBloom():this.renderer.enableBloom())}checkFloatingOrigin(){const e=this.renderer.cameraController.handleFloatingOrigin();e.needsReset&&(this.voxelColumn.applyFloatingOriginOffset(e.offset),this.physicsWorld.applyFloatingOriginOffset(e.offset),this.lootSystem.applyFloatingOriginOffset(e.offset),this.resourceDropSystem.applyFloatingOriginOffset(e.offset),this.clusterSystem.applyFloatingOriginOffset(e.offset),this.createPhysicsForBlocks())}handleRotateStep(e){this.renderer.cameraController.rotateStep(e)}handleVerticalScroll(e){this.renderer.cameraController.scrollDepth(e)}handlePointerDown(e,t,s){this.lastPointerX=t,this.lastPointerY=s;const o={id:e,screenX:t,screenY:s,hoveredBlock:null,isHolding:!1,drillTarget:null,initialScreenX:t,initialScreenY:s,initialBlock:null};this.pointerInteractions.set(e,o),this.updateHoverState(t,s),o.initialBlock=this.hoveredBlock;const i=this.resourceDropSystem.getHoveredResource();if(i)return this.resourceDropSystem.collectResource(i),void this.particleSystem.spawnCollectSparkle(i.sprite.position.x,i.sprite.position.y,i.sprite.position.z);const n=this.lootSystem.getHoveredLoot();return n?(this.lootSystem.collectLoot(n),void this.particleSystem.spawnCollectSparkle(n.mesh.position.x,n.mesh.position.y,n.mesh.position.z)):void 0}handlePointerMove(e,t,s){this.lastPointerX=t,this.lastPointerY=s;const o=this.pointerInteractions.get(e);if(o&&(o.screenX=t,o.screenY=s,o.isHolding&&o.drillTarget)){const e=this.raycastBlock(t,s);if(e){const t=e.block;t.x===o.drillTarget.x&&t.y===o.drillTarget.y&&t.z===o.drillTarget.z||(o.drillTarget={x:t.x,y:t.y,z:t.z},this.toolSystem.updateDrillTarget(t.x,t.y,t.z,e.point))}}this.updateHoverState(t,s)}handlePointerUp(e,t,s){const o=this.pointerInteractions.get(e);if(o){const e=90,i=Math.abs(t-o.initialScreenX),n=Math.abs(s-o.initialScreenY),r=Math.sqrt(i*i+n*n);if(this.hoveredBlock&&o.initialBlock&&this.hoveredBlock.x===o.initialBlock.x&&this.hoveredBlock.y===o.initialBlock.y&&this.hoveredBlock.z===o.initialBlock.z&&r<=e){const e=ts.getState().currentTool,o=re[e];if(!o.multiTouchAllowed&&this.pointerInteractions.size>1);else if("tap"===o.inputMode){const e=this.raycastBlock(t,s);e&&(this.toolSystem.useTapTool(e.block.x,e.block.y,e.block.z,e.point),this.uiManager.playAttackAnimation())}}o.hoveredBlock&&this.voxelColumn.setBlockColor(o.hoveredBlock.x,o.hoveredBlock.y,o.hoveredBlock.z,1,1,1)}if(this.pointerInteractions.delete(e),this.pointerInteractions.size>0){const e=this.pointerInteractions.values().next().value;this.updateHoverState(e.screenX,e.screenY)}else this.lootSystem.clearHover(),this.resourceDropSystem.clearHover(),this.hoveredBlock&&(this.voxelColumn.setBlockColor(this.hoveredBlock.x,this.hoveredBlock.y,this.hoveredBlock.z,1,1,1),this.hoveredBlock=null,this.uiManager.updateBlockDebugInfo(null))}handleHoldStart(e,t,s){const o=this.pointerInteractions.get(e);if(!o)return;o.isHolding=!0;const i=ts.getState().currentTool;if(!re[i].multiTouchAllowed)for(const[n,r]of this.pointerInteractions)if(n!==e&&r.isHolding&&r.drillTarget)return;if(i===Ae.DRILL){const e=this.raycastBlock(t,s);e&&(o.drillTarget={x:e.block.x,y:e.block.y,z:e.block.z},this.toolSystem.startDrill(e.block.x,e.block.y,e.block.z,e.point))}}handleHoldEnd(e){const t=this.pointerInteractions.get(e);t&&(t.isHolding&&t.drillTarget&&this.toolSystem.stopDrill(),t.isHolding=!1,t.drillTarget=null)}updateHoverState(e,t){const s=this.voxelColumn.getRaycastTargets(),o=this.lootSystem.getLootMeshes(),i=this.resourceDropSystem.getResourceTargets();for(const p of i)p.updateMatrixWorld();const n=this.renderer.raycast(e,t,i),r=this.renderer.raycast(e,t,o),a=this.renderer.raycast(e,t,s),l=n.length>0?n[0]:null,c=r.length>0?r[0]:null,h=a.length>0?a[0]:null;let u=null;l&&(!c||l.distance<=c.distance)&&(!h||l.distance<=h.distance)?u=l:c&&(!h||c.distance<=h.distance)?u=c:h&&(u=h);let d=null;if(u){const e=u.object;if(i.includes(e)){const t=e;this.resourceDropSystem.setHoveredResourceTarget(t),this.lootSystem.clearHover()}else if(o.includes(e)){const t=e;this.lootSystem.setHoveredLootMesh(t),this.resourceDropSystem.clearHover()}else if(s.includes(e)){const e=this.voxelColumn.getBlockFromIntersection(u);e&&this.voxelColumn.isBlockInteractable(e.x,e.y,e.z)&&(d=e),this.lootSystem.clearHover(),this.resourceDropSystem.clearHover()}}d?(this.hoveredBlock&&this.hoveredBlock!==d&&this.voxelColumn.setBlockColor(this.hoveredBlock.x,this.hoveredBlock.y,this.hoveredBlock.z,1,1,1),this.voxelColumn.setBlockColor(d.x,d.y,d.z,1.3,1.3,1.3),this.hoveredBlock=d,this.uiManager.updateBlockDebugInfo(d)):(this.hoveredBlock&&(this.voxelColumn.setBlockColor(this.hoveredBlock.x,this.hoveredBlock.y,this.hoveredBlock.z,1,1,1),this.hoveredBlock=null),this.uiManager.updateBlockDebugInfo(null)),u||(this.lootSystem.clearHover(),this.resourceDropSystem.clearHover())}refreshAllHoverStates(){const e=this.resourceDropSystem.getResourceTargets();for(const t of e)t.updateMatrixWorld();0===this.lastPointerX&&0===this.lastPointerY||this.updateHoverState(this.lastPointerX,this.lastPointerY)}raycastBlock(e,t){const s=this.voxelColumn.getRaycastTargets(),o=this.renderer.raycast(e,t,s);for(const i of o){const e=this.voxelColumn.getBlockFromIntersection(i);if(e&&this.voxelColumn.isBlockInteractable(e.x,e.y,e.z))return{block:e,point:i.point}}return null}handleBlockDestroyed(e){const t=this.physicsWorld.findBlockAt(e.x,e.y,e.z);t&&this.physicsWorld.removeBody(t)}processUnstableClusters(){const e=this.stabilitySystem.getUnstableClusters();for(const t of e){const e=this.voxelColumn.extractClusterBlocks(t);this.clusterSystem.createCluster(e)}}handleBlockDamaged(e,t,s){const o=ne[e.type].color,i=ne[e.type].hp;this.toolSystem.onBlockDamage(e,t),s?this.particleSystem.spawnHitParticlesAtPoint(s.x,s.y,s.z,o,4):this.particleSystem.spawnHitParticles(e.x,e.y,e.z,o,4),this.feedbackSystem.showDamageNumber(e.x,e.y,e.z,t,t>=10),this.feedbackSystem.showHPBar(e.x,e.y,e.z,e.hp,i),this.feedbackSystem.spawnSparkles(e.x,e.y,e.z,o),this.voxelColumn.shakeBlock(e.x,e.y,e.z,.08,.8),this.resourceDropSystem.tryDropResource(e.type,e.x,e.y,e.z)}handleUpgrade(e){if("drone"===e.detail.upgrade){const e=this.renderer.cameraController.getWorldPosition();this.lootSystem.enableDrone(e)}}dispose(){this.renderer.dispose(),this.inputManager.dispose(),this.voxelColumn.dispose(),this.physicsWorld.dispose(),this.toolSystem.dispose(),this.particleSystem.dispose(),this.lootSystem.dispose(),this.feedbackSystem.dispose(),this.resourceDropSystem.dispose(),this.uiManager.dispose(),this.debugController.dispose();for(const e of this.fallingBlocks.values())e.geometry.dispose(),e.material.dispose();this.fallingBlockMaterial.dispose(),window.removeEventListener("upgrade:purchased",this.handleUpgrade.bind(this))}toggleDebugVisuals(){ts.getState().toggleDebugVisuals();const e=ts.getState().debugVisuals;this.debugController.setDebugVisuals(e),this.voxelColumn.updateAirMeshVisibility(e),e?(this.physicsWorld.createWallVisualization(),this.resourceDropSystem.createDebugGizmos()):(this.physicsWorld.removeWallVisualization(),this.resourceDropSystem.removeDebugGizmos())}}const bs=$.blockProperties;const ks=new class{levels=new Map;async loadLevel(e){if(this.levels.has(e))return this.levels.get(e);try{const t=await fetch(`/test-levels/${e}.json`);if(!t.ok)return console.error(`Failed to load level: ${e}`),null;const s=await t.json();return this.levels.set(e,s),s}catch(t){return console.error(`Error loading level ${e}:`,t),null}}async loadAllLevels(){const e=["01-single-block-fall","02-vertical-column","03-large-cluster","04-bridge-collapse","05-cascade-destruction","06-mixed-blocks","07-perimeter-anchored","08-bedrock-anchored"];for(const t of e)await this.loadLevel(t);return this.levels}applyLevelToVoxelColumn(e,t){for(const s of e.blocks){const e=s.type.toUpperCase(),o=Pe[e];if(void 0===o){console.warn(`Unknown block type: ${s.type}`);continue}const i=bs[String(o)];t.setBlockFromData({type:o,hp:s.hp??i.hp,initialHp:s.hp??i.hp,initialResourceQuantity:i.lootMax,resourceQuantity:i.lootMax,hasLoot:s.hasLoot??Math.random()<i.lootChance,x:s.x,y:s.y,z:s.z,isStatic:!0})}}getAvailableLevels(){return Array.from(this.levels.keys())}getLevelDescription(e){return this.levels.get(e)?.description}};async function ws(){console.log(" Deep Core - Starting...");try{const e=new URLSearchParams(window.location.search);if(e.has("debug")&&"true"===e.get("debug")){const t=ts.getState();t.toggleDebugMode(),"true"!==e.get("visuals")&&"true"!==e.get("debugVisuals")||t.toggleDebugVisuals(),console.log(" Debug mode enabled via URL parameter")}const t=e.get("level");t&&console.log(` Loading test level: ${t}`);const s=new vs;if(await s.init(),t){const e=await ks.loadLevel(t);e?(ks.applyLevelToVoxelColumn(e,s.voxelColumn),console.log(` Level "${e.name}" loaded successfully`)):console.warn(` Level "${t}" not found`)}console.log(" Game initialized successfully!"),window.game=s,window.levelLoader=ks}catch(e){console.error(" Failed to initialize game:",e);const t=document.getElementById("loading"),s=document.getElementById("loading-text");t&&s&&(s.textContent="Failed to load game. Please refresh.",s.style.color="#ff6b6b")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",ws):ws();
