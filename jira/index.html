<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Jira Solitaire: –ö–∞–Ω–±–∞–Ω-–ø–∞—Å—å—è–Ω—Å">
    <meta property="og:description" content="–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø—Ä–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤–æ–≤—Ä–µ–º—è. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —Ç–∏–∫–µ—Ç—ã, –∏–º–∏—Ç–∏—Ä—É–π –±—É—Ä–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ù–∞—á–∞–ª—å—Å—Ç–≤–æ –æ—Ü–µ–Ω–∏—Ç.">
    <meta property="og:image" content="https://gritsenko.biz/jira/cover.jpg">
    <meta property="og:url" content="https://gritsenko.biz/jira/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Favicon -->
    <link rel="icon" href="fav-generic.png">

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
            m[i].l = 1 * new Date();
            for (var j = 0; j < document.scripts.length; j++) { if (document.scripts[j].src === r) { return; } }
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
        })
            (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(98653129, "init", {
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true
        });
    </script>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/98653129" style="position:absolute; left:-9999px;" alt="" /></div>
    </noscript>
    <!-- /Yandex.Metrika counter -->

    <title>Jira Board - Sprint 42</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff; /* White outer background like Jira app */
            color: #172B4D;
            overflow: hidden;
            user-select: none;
        }

        /* --- Layout Grid --- */
        #game-layout {
            display: flex;
            height: calc(100vh - 56px);
        }

        #game-container {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            background-color: #ffffff;
            /* Center the board content */
            display: flex;
            flex-direction: column;
            align-items: center; 
        }

        .board-wrapper {
            width: 100%;
            max-width: 1600px; /* Prevent it from getting too wide on ultrawide monitors */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Top Row (Stock & Foundations) */
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 10px; /* Align with columns padding */
        }

        .stock-group {
            display: flex;
            gap: 16px;
        }

        .foundation-group {
            display: flex;
            gap: 16px;
        }

        /* Tableau Grid */
        .tableau-area {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 Equal Columns */
            gap: 16px; /* Spacing between columns */
            width: 100%;
            flex-grow: 1;
        }

        /* Kanban Column Styling */
        .column {
            background-color: #F4F5F7; /* Jira Column Grey */
            border-radius: 6px;
            min-height: 500px;
            padding: 8px 8px 40px 8px; /* Extra bottom padding */
            position: relative;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .column:hover {
            background-color: #EBECF0;
        }

        .column-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #5E6C84;
            margin-bottom: 12px;
            padding-left: 4px;
            display: flex;
            justify-content: space-between;
        }

        /* --- Card Styling --- */
        .card {
            /* Fluid width! */
            width: 100%; 
            height: 140px; /* Slightly shorter for better density */
            background-color: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9, 30, 66, 0.25);
            position: absolute; /* Still absolute for stacking logic */
            transition: box-shadow 0.2s;
            cursor: grab;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            font-size: 12px;
            left: 0; /* Align inside relative parent */
        }

        /* Slots (Stock/Foundation) need fixed dimensions to look good, 
           OR we make them match the grid. Let's keep them fixed size 
           but slightly larger to match the feel. */
        .slot {
            width: 140px;
            height: 140px;
            border: 2px dashed #DFE1E6;
            border-radius: 3px;
            position: relative;
            background-color: rgba(244, 245, 247, 0.5);
            flex-shrink: 0;
        }
        
        .card.dragging {
            cursor: grabbing;
            z-index: 1000 !important;
            box-shadow: 0 10px 20px rgba(9, 30, 66, 0.3);
            transform: scale(1.02) rotate(2deg); /* Nice effect */
            position: fixed; /* Fixed relative to viewport when dragging */
        }
        
        /* Auto-move animation class */
        .card.flying {
            z-index: 2000 !important;
            box-shadow: 0 15px 30px rgba(9, 30, 66, 0.4);
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth easing */
        }

        .card:hover {
            background-color: #EBECF0;
        }

        /* Loading Skeleton */
        .card-back {
            background-color: #ffffff;
            border: 1px solid #DFE1E6;
        }
        
        .skeleton-line {
            height: 8px;
            background-color: #EBECF0;
            border-radius: 4px;
            margin-bottom: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .skeleton-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #EBECF0;
            align-self: flex-end;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Attention Animation (Wiggle) */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .attention-please {
            color: #DE350B !important;
            font-weight: bold !important;
            animation: wiggle 0.5s ease-in-out infinite;
            background-color: #FFEBE6 !important;
        }

        /* Soft Pulse Animation (Share) */
        @keyframes soft-pulse {
            0%, 100% { background-color: transparent; color: #42526E; }
            50% { background-color: #DEEBFF; color: #0052CC; } /* Jira Blue selection color */
        }
        
        .animate-soft-pulse {
            animation: soft-pulse 2s ease-in-out;
        }

        .priority-strip {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .foundation-slot::before {
            content: 'Done';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #A5ADBA;
            font-weight: bold;
        }

        /* Icons */
        .priority-icon { width: 18px; height: 18px; }
        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        /* Sidebar Simulation */
        .sidebar-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #42526E;
            cursor: pointer;
            border-radius: 3px;
            margin: 0 8px;
            transition: all 0.3s;
        }
        .sidebar-item:hover { background-color: #EBECF0; }
        .sidebar-item.active { background-color: #E6EFFC; color: #0052CC; }
        
        /* SLA Panel */
        .sla-panel {
            margin-top: auto;
            border-top: 1px solid #DFE1E6;
            padding: 16px;
        }
        .sla-meter {
            height: 6px;
            background: #EBECF0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .sla-fill {
            height: 100%;
            background: #36B37E;
            transition: width 0.3s ease;
        }

        /* Ticket Content */
        .ticket-id { font-size: 10px; color: #5E6C84; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        .ticket-summary { font-size: 12px; color: #172B4D; font-weight: 500; line-height: 1.4; flex-grow: 1; overflow: hidden; padding-right: 4px; margin-bottom: 4px; }
        .ticket-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .story-points { 
            background: #DFE1E6; 
            border-radius: 10px; 
            padding: 2px 8px; 
            font-size: 11px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #172B4D;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

    </style>
</head>
<body>

    <!-- Fake Navbar -->
    <nav class="h-[56px] bg-white border-b border-[#DFE1E6] flex items-center px-4 justify-between z-50 relative shadow-sm">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 font-bold text-[#0052CC] text-xl">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2H2v20h9V2zm2 0v20h9V2h-9z"/></svg>
                Jira Solitaire
            </div>
            <div class="hidden md:flex gap-4 text-sm font-medium text-[#42526E]">
                <span class="cursor-pointer hover:text-[#0052CC]">Your Work</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Projects</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Filters</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Dashboards</span>
                <button onclick="newGame()" class="bg-[#0052CC] text-white px-3 py-1 rounded hover:bg-blue-700 transition font-medium">Create Sprint</button>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <div class="relative hidden sm:block">
                <input type="text" placeholder="Search" class="border border-[#DFE1E6] rounded px-2 py-1 text-sm w-40 focus:outline-none focus:border-[#0052CC]">
             </div>
             <button onclick="shareGame()" class="flex items-center gap-2 text-[#42526E] hover:bg-[#EBECF0] px-2 py-1 rounded transition text-sm font-medium">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                 Share
             </button>
             <div class="w-8 h-8 rounded-full bg-[#0052CC] text-white flex items-center justify-center font-bold text-xs">ME</div>
        </div>
    </nav>

    <div id="game-layout">
        <!-- Fake Sidebar -->
        <div class="w-[240px] bg-[#F4F5F7] border-r border-[#DFE1E6] hidden lg:flex flex-col pt-6 flex-shrink-0">
            <div class="px-6 mb-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-[#FF5630] rounded flex items-center justify-center text-white font-bold shadow-sm">P1</div>
                <div>
                    <div class="font-bold text-sm text-[#172B4D]">Project X</div>
                    <div class="text-xs text-[#5E6C84]">Software Project</div>
                </div>
            </div>
            <div class="sidebar-item active">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Sprint Board
            </div>
            <div class="sidebar-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Backlog
            </div>
            
            <div class="mt-8 px-6 text-xs font-bold text-[#5E6C84] uppercase tracking-wide">Help & Tools</div>
            <div id="call-tl-btn" class="sidebar-item mt-2 text-[#DE350B]" onclick="callTeamLead()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                Call Team Lead
            </div>
            <div id="share-btn" class="sidebar-item mt-1" onclick="shareGame()">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                 Share Game
            </div>

            <div class="mt-8 px-6 text-xs font-bold text-[#5E6C84] uppercase tracking-wide">Quick Filters</div>
            <div class="sidebar-item mt-2">
                <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> Only My Issues
            </div>
             <div class="sidebar-item">
                <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Recently Updated
            </div>

            <!-- SLA Panel -->
            <div class="sla-panel">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-[#42526E]">SLA STATUS</span>
                    <span id="sla-timer" class="text-xs font-bold text-[#0052CC]">ON TRACK</span>
                </div>
                <div class="text-[10px] text-[#5E6C84] mb-2">Issues Resolved: <span id="resolved-count">0</span>/52</div>
                <div class="sla-meter">
                    <div id="sla-bar" class="sla-fill" style="width: 0%"></div>
                </div>
                <div class="mt-4 flex gap-2">
                    <div class="flex-1 bg-white p-2 rounded border border-[#DFE1E6] text-center shadow-sm">
                        <div class="text-[10px] text-[#5E6C84]">Velocity</div>
                        <div class="text-xs font-bold text-[#172B4D]">High</div>
                    </div>
                    <div class="flex-1 bg-white p-2 rounded border border-[#DFE1E6] text-center shadow-sm">
                        <div class="text-[10px] text-[#5E6C84]">Bugs</div>
                        <div class="text-xs font-bold text-[#FF5630]">Critical</div>
                    </div>
                </div>
            </div>

            <!-- Banner -->
            <a href="https://adsadvisor.io?from=gritsenko" target="_blank" class="block mx-4 mb-4 mt-4 transition hover:opacity-90">
                <img src="https://gritsenko.biz/jira/Banner.jpg" alt="AdsAdvisor" class="w-full rounded border border-[#DFE1E6] shadow-sm">
            </a>
        </div>

        <!-- Main Game Board -->
        <div id="game-container">
            <div class="board-wrapper">
                
                <div class="flex justify-between items-end px-2">
                    <div>
                        <div class="text-sm text-[#5E6C84] mb-1">Projects / Project X / Sprint 42</div>
                        <h1 class="text-2xl font-semibold text-[#172B4D]">Sprint 42 Active Board</h1>
                    </div>
                    <div class="text-sm text-[#5E6C84] bg-[#F4F5F7] px-3 py-1 rounded">
                        Double click to auto-complete
                    </div>
                </div>

                <!-- Top Area: Stock/Waste & Foundations -->
                <div class="top-row">
                    <!-- Stock (Backlog) -->
                    <div class="stock-group">
                        <div>
                            <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Backlog</div>
                            <div id="stock" class="slot cursor-pointer flex items-center justify-center text-[#5E6C84] text-xs font-bold bg-white border border-[#DFE1E6]">
                                <div class="text-center">
                                    <div>RELOAD</div>
                                    <svg class="w-6 h-6 mx-auto mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">In Review</div>
                            <div id="waste" class="slot"></div>
                        </div>
                    </div>

                    <!-- Foundations (Done) -->
                    <div class="foundation-group">
                        <div>
                             <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Blocker</div>
                             <div id="foundation-0" class="slot foundation-slot" data-suit="h"></div>
                        </div>
                        <div>
                             <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Critical</div>
                             <div id="foundation-1" class="slot foundation-slot" data-suit="d"></div>
                        </div>
                        <div>
                             <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Major</div>
                             <div id="foundation-2" class="slot foundation-slot" data-suit="s"></div>
                        </div>
                        <div>
                             <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Minor</div>
                             <div id="foundation-3" class="slot foundation-slot" data-suit="c"></div>
                        </div>
                    </div>
                </div>

                <!-- Tableau (Columns) -->
                <div class="tableau-area">
                    <div id="tableau-0" class="column">
                        <div class="column-header">
                            <span>To Do</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">2</span>
                        </div>
                    </div>
                    <div id="tableau-1" class="column">
                        <div class="column-header">
                            <span>Analysis</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">3</span>
                        </div>
                    </div>
                    <div id="tableau-2" class="column">
                        <div class="column-header">
                            <span>In Progress</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">5</span>
                        </div>
                    </div>
                    <div id="tableau-3" class="column">
                        <div class="column-header">
                            <span>Code Review</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">8</span>
                        </div>
                    </div>
                    <div id="tableau-4" class="column">
                        <div class="column-header">
                            <span>Testing</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">3</span>
                        </div>
                    </div>
                    <div id="tableau-5" class="column">
                        <div class="column-header">
                            <span>UAT</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">2</span>
                        </div>
                    </div>
                    <div id="tableau-6" class="column">
                        <div class="column-header">
                            <span>Ready to Prod</span>
                            <span class="bg-[#DFE1E6] rounded-full px-2 text-[10px] py-0.5">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[2000]">
        <div class="bg-white p-8 rounded-md shadow-lg text-center max-w-md w-full mx-4">
            <div class="text-6xl mb-4">üöÄ</div>
            <h2 class="text-2xl font-bold text-[#0052CC] mb-2">Sprint 42 Completed!</h2>
            <p class="text-[#172B4D] mb-6 font-medium text-lg">
                –§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞! <br>
                <span class="text-sm font-normal text-[#5E6C84]">–í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–∫—Ä—ã—Ç—ã, –±–∞–≥–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∏—Å—å –≤ —Ñ–∏—á–∏, –∞ –¥–µ–¥–ª–∞–π–Ω—ã —Å–æ–±–ª—é–¥–µ–Ω—ã (–ø–æ—á—Ç–∏). –í—ã –∑–∞—Å–ª—É–∂–∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø—Ä–µ–º–∏—é.</span>
            </p>
            
            <div class="flex flex-col gap-3">
                <button onclick="shareGame()" class="w-full bg-[#36B37E] text-white px-4 py-2 rounded font-bold hover:bg-green-700 transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —É—Å–ø–µ—Ö–æ–º
                </button>
                <button onclick="newGame()" class="w-full bg-[#0052CC] text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">
                    –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–ø—Ä–∏–Ω—Ç
                </button>
            </div>
        </div>
    </div>

    <!-- Google Meet Modal (Call Team Lead) -->
    <!-- Updated with semi-transparent background and new avatar -->
    <div id="meet-modal" class="fixed inset-0 bg-gray-900/85 backdrop-blur-sm hidden flex flex-col items-center justify-center z-[3000]">
        <!-- Main Video Area -->
        <div class="w-full max-w-3xl h-[60vh] bg-[#3c4043] rounded-lg overflow-hidden relative flex items-center justify-center p-4">
            <div class="text-center">
                <!-- New Avatar -->
                <img src="https://avatars.githubusercontent.com/u/2227312?v=4" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-[#8ab4f8] object-cover" alt="Team Lead">
                <h2 id="meet-status" class="text-white text-xl font-sans">Connecting to Team Lead...</h2>
            </div>
            
            <!-- Controls Overlay -->
            <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4">
                <div class="w-12 h-12 rounded-full bg-[#ea4335] flex items-center justify-center text-white cursor-pointer hover:bg-opacity-80 transition" onclick="closeMeet()">
                    <!-- Hang up icon -->
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.7-9.3l-1.4-1.4L12 11.6 9.7 9.3l-1.4 1.4 2.3 2.3-2.3 2.3 1.4 1.4 2.3-2.3 2.3 2.3 1.4-1.4-2.3-2.3z"/></svg>
                </div>
                 <div class="w-12 h-12 rounded-full bg-[#3c4043] border border-[#5f6368] flex items-center justify-center text-white opacity-50 cursor-not-allowed">
                    <!-- Mic off -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </div>
                 <div class="w-12 h-12 rounded-full bg-[#3c4043] border border-[#5f6368] flex items-center justify-center text-white opacity-50 cursor-not-allowed">
                    <!-- Camera off -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </div>
            </div>
        </div>
        <div class="mt-4 text-[#9aa0a6] text-sm">Google Meet (Simulated)</div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>

    <script>
        // --- Config & Data ---

        const suits = ['h', 'd', 's', 'c']; // Hearts, Diamonds, Spades, Clubs
        
        // Jira Icons (SVG Paths)
        const icons = {
            blocker: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#DE350B]"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`, // Actually Critical/Blocker mix style
            critical: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#FF7452]"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`, // High Voltage
            major: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#0052CC]"><path d="M7 14l5-5 5 5z"/></svg>`, // Arrow Up
            minor: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#00875A]"><path d="M7 10l5 5 5-5z"/></svg>`  // Arrow Down
        };

        const suitConfig = {
            'h': { color: 'red', label: 'Blocker', svg: icons.blocker, strip: '#FF5630' },   // Red
            'd': { color: 'red', label: 'Critical', svg: icons.critical, strip: '#FF5630' },  // Red (was Orange-ish)
            's': { color: 'black', label: 'Major', svg: icons.major, strip: '#0052CC' },      // Blue
            'c': { color: 'black', label: 'Minor', svg: icons.minor, strip: '#0052CC' }       // Blue (was Green-ish)
        };

        const ranks = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];
        const rankLabels = {
            1: 'A', 11: 'J', 12: 'Q', 13: 'K'
        };
        const avatarInitials = {
            11: 'JD', 12: 'QA', 13: 'PO', 1: 'IN'
        };

        const summaries = [
            "Fix alignment in footer", "Update React dependency", "Meeting about meetings", 
            "Refactor legacy spaghetti", "Change button color", "Investigate slow query",
            "Write unit tests (maybe)", "Deploy to Prod", "Fix coffee machine",
            "Update documentation", "Center the div", "Resolve merge conflict",
            "Optimize images", "Fix mobile layout", "Update API schema",
            "Customer reported bug", "Feature flag cleanup", "Remove console.log",
            "Upgrade database", "Fix typo in header", "Refactor Auth module",
            "Implement Dark Mode", "Update 3rd party libs", "Design new logo",
            "Setup CI/CD pipeline", "Fix memory leak", "Add infinite scroll"
        ];

        let deck = [];
        let stock = [];
        let waste = [];
        let foundations = [[], [], [], []];
        let tableau = [[], [], [], [], [], [], []];

        // Drag State
        let dragSource = null; 
        let draggedCards = [];
        let dragStartPos = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };
        
        // Idle Timer
        let idleTimer;

        // Sounds
        const sounds = {
            drop: new Audio('drop.mp3'),
            pop: new Audio('pop.mp3'),
            swipe: new Audio('swipe.mp3'),
            teamlead: new Audio('teamlead.mp3')
        };

        function playSound(name) {
            const sound = sounds[name];
            if(sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Audio play failed", e));
            }
        }

        // --- Helper: Stats Update ---
        function updateStats() {
            let totalDone = 0;
            foundations.forEach(f => totalDone += f.length);
            document.getElementById('resolved-count').innerText = totalDone;
            const percent = (totalDone / 52) * 100;
            document.getElementById('sla-bar').style.width = `${percent}%`;
            const slaText = document.getElementById('sla-timer');
            if(percent === 100) {
                slaText.innerText = "SPRINT DONE";
                slaText.style.color = "#36B37E";
            } else if (percent > 50) {
                 slaText.innerText = "ON TRACK";
                 slaText.style.color = "#0052CC";
            } else {
                 slaText.innerText = "AT RISK";
                 slaText.style.color = "#FF5630";
            }
        }

        // --- Idle Timer Logic ---
        function resetIdleTimer() {
            const btn = document.getElementById('call-tl-btn');
            if(btn) {
                btn.classList.remove('attention-please');
            }

            clearTimeout(idleTimer);
            // 30 seconds idle time
            idleTimer = setTimeout(() => {
                if(btn) {
                    btn.classList.add('attention-please');
                }
            }, 30000); 
        }

        // Attach idle listeners
        ['mousemove', 'mousedown', 'keydown', 'scroll', 'click'].forEach(evt => {
            document.addEventListener(evt, resetIdleTimer);
        });

        // --- Team Lead / Meet Logic ---

        function callTeamLead() {
            playSound('teamlead');
            const modal = document.getElementById('meet-modal');
            const status = document.getElementById('meet-status');
            modal.classList.remove('hidden');
            status.innerText = "Team Lead is joining...";
            resetIdleTimer(); // Clear attention if clicked

            // Simulate call sequence
            setTimeout(() => {
                status.innerText = "Team Lead is looking at your screen...";
                setTimeout(() => {
                    const move = findBestMove();
                    if (move) {
                        status.innerText = "TL: \"Ah, I found a blocker. Fixing it...\"";
                        setTimeout(() => {
                            // Close modal FIRST
                            closeMeet();
                            // Then delay slightly and animate
                            setTimeout(() => {
                                 animateAndExecute(move, () => {
                                    showToast("Team Lead moved a card for you!");
                                });
                            }, 300);
                        }, 1500);
                    } else {
                        status.innerText = "TL: \"Looks blocked. Try reloading the backlog.\"";
                        setTimeout(() => closeMeet(), 2500);
                    }
                }, 1500);
            }, 1000);
        }

        function closeMeet() {
            document.getElementById('meet-modal').classList.add('hidden');
        }

        // Animated Auto-Move
        function animateAndExecute(move, callback) {
            playSound('swipe');
            // 1. Identify Source Element
            let sourceEl = null;
            if (move.fromType === 'waste') {
                const wasteEl = document.getElementById('waste');
                sourceEl = wasteEl.lastElementChild;
            } else if (move.fromType === 'tableau') {
                const colEl = document.getElementById(`tableau-${move.fromIndex}`);
                const allCards = colEl.querySelectorAll('.card');
                sourceEl = allCards[move.cardIndex];
            }

            // 2. Identify Target Element (Destination Slot)
            let targetEl = null;
            if (move.toType === 'foundation') {
                targetEl = document.getElementById(`foundation-${move.toIndex}`);
            } else if (move.toType === 'tableau') {
                targetEl = document.getElementById(`tableau-${move.toIndex}`);
            }

            if (!sourceEl || !targetEl) {
                // Fallback if visual not found
                executeMove(move.fromType, move.fromIndex, move.toType, move.toIndex, move.cardIndex);
                if(callback) callback();
                return;
            }

            // 3. Create Flying Clone
            const rect = sourceEl.getBoundingClientRect();
            const clone = sourceEl.cloneNode(true);
            
            // Fix sizes and positions for the clone
            clone.style.width = rect.width + 'px';
            clone.style.height = rect.height + 'px';
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            clone.style.position = 'fixed';
            clone.style.margin = '0';
            clone.style.opacity = '1'; // Ensure visibility
            clone.classList.add('flying');
            
            document.body.appendChild(clone);
            
            // Hide original immediately
            sourceEl.style.opacity = '0';

            // 4. Calculate Destination Coordinates
            // For tableau, we need to append to the bottom list
            let destRect;
            if (move.toType === 'tableau') {
                const targetCards = targetEl.querySelectorAll('.card');
                if (targetCards.length > 0) {
                    const lastCard = targetCards[targetCards.length - 1];
                    const lastRect = lastCard.getBoundingClientRect();
                    // Calculate next overlap position (40px down)
                    destRect = {
                        left: lastRect.left,
                        top: lastRect.top + 40,
                        width: lastRect.width,
                        height: lastRect.height
                    };
                } else {
                    // Empty column
                    const colRect = targetEl.getBoundingClientRect();
                    // Account for header and padding (approx 38px down, 8px left padding)
                    destRect = {
                        left: colRect.left + 8,
                        top: colRect.top + 38,
                        width: rect.width, // keep original width
                        height: rect.height
                    };
                }
            } else {
                // Foundation
                destRect = targetEl.getBoundingClientRect();
            }

            // 5. Trigger Animation
            // Force reflow
            void clone.offsetWidth; 
            
            clone.style.left = destRect.left + 'px';
            clone.style.top = destRect.top + 'px';

            // 6. Cleanup and Execute Logic
            setTimeout(() => {
                clone.remove();
                executeMove(move.fromType, move.fromIndex, move.toType, move.toIndex, move.cardIndex);
                playSound('drop');
                if(callback) callback();
            }, 600); // Matches CSS transition time
        }

        // AI Logic to find a move
        function findBestMove() {
            // Priority 1: Move from Waste to Foundation
            if (waste.length > 0) {
                const card = waste[waste.length - 1];
                const fIndex = getFoundationTarget(card);
                if (fIndex !== -1) return { fromType: 'waste', fromIndex: waste.length - 1, toType: 'foundation', toIndex: fIndex, cardIndex: null };
            }
            // Priority 2: Move from Tableau to Foundation
            for (let i = 0; i < 7; i++) {
                if (tableau[i].length > 0) {
                    const card = tableau[i][tableau[i].length - 1];
                    const fIndex = getFoundationTarget(card);
                    if (fIndex !== -1) return { fromType: 'tableau', fromIndex: i, toType: 'foundation', toIndex: fIndex, cardIndex: tableau[i].length - 1 };
                }
            }

            // Priority 3: Move from Waste to Tableau
            if (waste.length > 0) {
                const card = waste[waste.length - 1];
                const tIndex = getTableauTarget(card);
                if (tIndex !== -1) return { fromType: 'waste', fromIndex: waste.length - 1, toType: 'tableau', toIndex: tIndex, cardIndex: null };
            }
            
            // Priority 4: Move from Tableau to Tableau (only if it reveals a card or moves King to empty)
            for (let i = 0; i < 7; i++) {
                const col = tableau[i];
                if (col.length === 0) continue;
                
                // Find deepest face-up card
                let startIndex = 0;
                for (let j = 0; j < col.length; j++) {
                    if (col[j].faceUp) { startIndex = j; break; }
                }

                // Optimization: Don't move a King from an empty spot to another empty spot
                // (Only move if there are face-down cards beneath it)
                if (startIndex === 0 && col[startIndex].rank === 13) continue;

                const card = col[startIndex];
                const tIndex = getTableauTarget(card, i); // pass current col index to ignore self
                if (tIndex !== -1) {
                     return { fromType: 'tableau', fromIndex: i, toType: 'tableau', toIndex: tIndex, cardIndex: startIndex };
                }
            }

            return null;
        }

        function getFoundationTarget(card) {
            for (let i = 0; i < 4; i++) {
                const pile = foundations[i];
                if (pile.length === 0) {
                    if (card.rank === 1) return i;
                } else {
                    const top = pile[pile.length - 1];
                    if (top.suit === card.suit && top.rank === card.rank - 1) return i;
                }
            }
            return -1;
        }

        function getTableauTarget(card, ignoreColIndex = -1) {
            for (let i = 0; i < 7; i++) {
                if (i === ignoreColIndex) continue;
                const col = tableau[i];
                if (col.length === 0) {
                    if (card.rank === 13) return i;
                } else {
                    const top = col[col.length - 1];
                    const movingConfig = suitConfig[card.suit];
                    const topConfig = suitConfig[top.suit];
                    // Solitaire Rule: Alt color + rank-1
                    if (movingConfig.color !== topConfig.color && top.rank === card.rank + 1) return i;
                }
            }
            return -1;
        }

        function executeMove(fromType, fromIndex, toType, toIndex, cardIndexInList) {
             moveCard(fromType, fromIndex, toType, toIndex, cardIndexInList);
        }

        // --- Sharing Logic ---
        
        function shareGame() {
            const url = "https://gritsenko.biz/jira/";
            const text = "–Ø –∑–∞–∫—Ä—ã–ª —Å–ø—Ä–∏–Ω—Ç –≤ Jira Solitaire! –ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã: ";
            
            const textArea = document.createElement("textarea");
            textArea.value = url;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast("–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- Game Logic ---

        function initDeck() {
            deck = [];
            suits.forEach(suit => {
                ranks.forEach(rank => {
                    deck.push({
                        suit: suit,
                        rank: rank,
                        id: `PROJ-${Math.floor(Math.random() * 9000) + 1000}`,
                        summary: summaries[Math.floor(Math.random() * summaries.length)],
                        faceUp: false
                    });
                });
            });
            shuffle(deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function deal() {
            stock = [...deck];
            waste = [];
            foundations = [[], [], [], []];
            tableau = [[], [], [], [], [], [], []];

            for (let i = 0; i < 7; i++) {
                for (let j = i; j < 7; j++) {
                    let card = stock.pop();
                    if (i === j) card.faceUp = true;
                    tableau[j].push(card);
                }
            }
        }

        // --- DOM Creation ---

        function createCardElement(card) {
            const el = document.createElement('div');
            
            if (!card.faceUp) {
                el.className = 'card card-back';
                el.innerHTML = `
                    <div style="padding: 10px;">
                        <div class="skeleton-line" style="width: 30%;"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                        <div class="skeleton-line" style="width: 60%;"></div>
                    </div>
                    <div style="padding: 10px; display:flex; justify-content: flex-end;">
                        <div class="skeleton-avatar"></div>
                    </div>
                `;
                return el;
            }

            const config = suitConfig[card.suit];
            const rankLabel = rankLabels[card.rank] || card.rank;
            const isFace = card.rank > 10 || card.rank === 1;
            
            const avatarColor = config.strip; 
            const avatarTextColor = 'white';
            const initials = isFace ? avatarInitials[card.rank] : 'PM';
            const rankColor = config.strip;
            
            el.className = 'card';
            el.setAttribute('data-suit', card.suit);
            el.setAttribute('data-rank', card.rank);
            el.setAttribute('data-color', config.color);

            el.innerHTML = `
                <div class="priority-strip" style="background-color: ${config.strip}"></div>
                <div class="pl-2 h-full flex flex-col">
                    <div class="ticket-id">
                        <span>${card.id}</span>
                        <div class="story-points" title="Story Points" style="color: ${rankColor}">${rankLabel}</div>
                    </div>
                    <div class="ticket-summary">
                        ${card.summary}
                    </div>
                    <div class="ticket-footer">
                        <span title="${config.label}">${config.svg}</span>
                        <div class="avatar" style="background-color: ${avatarColor}; color: ${avatarTextColor}">${initials}</div>
                    </div>
                </div>
            `;
            return el;
        }

        // --- Rendering ---

        function renderBoard() {
            updateStats();
            resetIdleTimer(); // Reset timer on render (interaction)

            // Render Stock
            const stockEl = document.getElementById('stock');
            stockEl.innerHTML = '';
            if (stock.length > 0) {
                const cardBack = document.createElement('div');
                cardBack.className = 'card card-back';
                cardBack.style.position = 'relative';
                // Reset card styles for slot
                cardBack.style.width = '100%';
                cardBack.style.height = '100%';
                cardBack.style.top = '0';
                cardBack.style.left = '0';
                
                cardBack.innerHTML = `<div style="padding: 10px;"><div class="skeleton-line" style="width:50%"></div></div>`;
                stockEl.appendChild(cardBack);
                stockEl.onclick = drawCard;
            } else {
                stockEl.innerHTML = `
                    <div class="text-center">
                        <div>RELOAD</div>
                        <svg class="w-6 h-6 mx-auto mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </div>`;
                stockEl.onclick = resetStock;
            }

            // Render Waste
            const wasteEl = document.getElementById('waste');
            wasteEl.innerHTML = '';
            if (waste.length > 0) {
                const card = waste[waste.length - 1];
                const cardEl = createCardElement(card);
                // Adjust style for slot
                cardEl.style.position = 'relative';
                cardEl.style.width = '100%';
                cardEl.style.height = '100%';
                cardEl.style.top = '0';
                
                makeDraggable(cardEl, 'waste', waste.length - 1);
                wasteEl.appendChild(cardEl);
            }

            // Render Foundations
            foundations.forEach((pile, index) => {
                const container = document.getElementById(`foundation-${index}`);
                container.innerHTML = '';
                if (pile.length > 0) {
                    const card = pile[pile.length - 1];
                    const cardEl = createCardElement(card);
                    // Adjust style for slot
                    cardEl.style.position = 'relative';
                    cardEl.style.width = '100%';
                    cardEl.style.height = '100%';
                    cardEl.style.top = '0';
                    
                    container.appendChild(cardEl);
                }
            });

            // Render Tableau
            tableau.forEach((col, colIndex) => {
                // Keep header!
                const container = document.getElementById(`tableau-${colIndex}`);
                // Save header
                const header = container.querySelector('.column-header');
                container.innerHTML = '';
                if(header) container.appendChild(header);

                // Update badge count
                if(header) {
                     const badge = header.querySelector('span:last-child');
                     if(badge) badge.innerText = col.length;
                }
                
                // Add cards container area below header
                // We'll just append absolute cards relative to column
                
                col.forEach((card, cardIndex) => {
                    const cardEl = createCardElement(card);
                    // Position relative to the column padding
                    // Top offset needs to account for header (~30px) + 8px padding
                    const startTop = 38; 
                    const overlap = 40; 
                    cardEl.style.top = `${startTop + (cardIndex * overlap)}px`;
                    // Left/Width is handled by CSS (width: 100%, left: 0) but we need to respect padding
                    // Actually .card is absolute, so width: 100% takes full column width.
                    // We want it to respect column padding.
                    // Best way: set left: 8px, right: 8px (or width: calc(100% - 16px))
                    cardEl.style.left = '8px';
                    cardEl.style.width = 'calc(100% - 16px)';
                    
                    if (card.faceUp) {
                        makeDraggable(cardEl, 'tableau', colIndex, cardIndex);
                    }
                    
                    container.appendChild(cardEl);
                });
            });

            checkWin();
        }

        // --- Interaction ---

        function drawCard() {
            playSound('pop');
            if (stock.length > 0) {
                const card = stock.pop();
                card.faceUp = true;
                waste.push(card);
                renderBoard();
            }
        }

        function resetStock() {
            playSound('pop');
            if (stock.length === 0 && waste.length > 0) {
                stock = waste.reverse().map(c => { c.faceUp = false; return c; });
                waste = [];
                renderBoard();
            }
        }

        function makeDraggable(el, type, listIndex, cardIndexInList = null) {
            el.onmousedown = function(e) {
                if(e.button !== 0) return; // Left click only
                e.preventDefault();

                dragSource = { type, listIndex, cardIndex: cardIndexInList };
                
                const hiddenElements = [];
                hiddenElements.push(el);
                
                if (type === 'tableau') {
                    // In tableau, cards are siblings. Find next siblings.
                    // But wait, our column structure might have header.
                    // 'el' is the card div.
                    let sibling = el.nextElementSibling;
                    while(sibling) {
                        hiddenElements.push(sibling);
                        sibling = sibling.nextElementSibling;
                    }
                }
                
                hiddenElements.forEach(elem => elem.style.opacity = '0');

                draggedCards = [];
                let cardsData = [];

                if (type === 'tableau') {
                    const col = tableau[listIndex];
                    for(let i = cardIndexInList; i < col.length; i++) {
                        cardsData.push(col[i]);
                    }
                } else if (type === 'waste') {
                    cardsData.push(waste[listIndex]);
                }

                // Important: Calculate exact width for the clone
                // Because 'width: 100%' in the clone (attached to body) means screen width
                const rect = el.getBoundingClientRect();
                
                dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };

                draggedCards = cardsData.map((c, i) => {
                    const clone = createCardElement(c);
                    clone.classList.add('dragging');
                    // Force exact dimensions
                    clone.style.width = rect.width + 'px';
                    clone.style.height = rect.height + 'px';
                    
                    clone.style.left = (rect.left) + 'px';
                    clone.style.top = (rect.top + (i * 40)) + 'px';
                    
                    clone.style.pointerEvents = 'none';
                    document.body.appendChild(clone);
                    return clone;
                });

                function moveAt(pageX, pageY) {
                    const x = pageX - dragOffset.x;
                    const y = pageY - dragOffset.y;
                    
                    draggedCards.forEach((cardEl, i) => {
                        cardEl.style.left = x + 'px';
                        cardEl.style.top = (y + (i * 40)) + 'px';
                    });
                }

                function onMouseMove(e) {
                    moveAt(e.clientX, e.clientY);
                }

                function onMouseUp(e) {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    handleDrop(e.clientX, e.clientY);

                    draggedCards.forEach(c => c.remove());
                    draggedCards = [];
                    dragSource = null;
                    
                    hiddenElements.forEach(elem => elem.style.opacity = '1');
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };
            
            el.ondblclick = function(e) {
                e.stopPropagation();
                let card;
                if(type === 'waste') card = waste[waste.length-1];
                if(type === 'tableau') card = tableau[listIndex][tableau[listIndex].length-1];
                if(type === 'tableau' && cardIndexInList !== tableau[listIndex].length-1) return; 

                if(card) {
                    for(let i=0; i<4; i++) {
                        const pile = foundations[i];
                        let valid = false;
                        if (pile.length === 0) {
                            if (card.rank === 1) valid = true;
                        } else {
                            const top = pile[pile.length - 1];
                            if (top.suit === card.suit && top.rank === card.rank - 1) valid = true;
                        }

                        if (valid) {
                            // Create move object for animation
                            const move = {
                                fromType: type,
                                fromIndex: listIndex,
                                toType: 'foundation',
                                toIndex: i,
                                cardIndex: cardIndexInList
                            };
                            animateAndExecute(move);
                            return; // Stop after finding first valid move
                        }
                    }
                }
            }
        }

        function handleDrop(x, y) {
            draggedCards.forEach(c => c.style.display = 'none');
            let elemBelow = document.elementFromPoint(x, y);
            draggedCards.forEach(c => c.style.display = 'block');

            if (!elemBelow) return;

            // Find closest slot or column
            const slot = elemBelow.closest('.column') || elemBelow.closest('.foundation-slot');
            if (!slot) return;

            let targetType = null;
            let targetIndex = null;

            if (slot.classList.contains('column')) {
                targetType = 'tableau';
                targetIndex = parseInt(slot.id.split('-')[1]);
            } else if (slot.classList.contains('foundation-slot')) {
                targetType = 'foundation';
                targetIndex = parseInt(slot.id.split('-')[1]);
            }

            if (targetType) {
                if(isValidMove(targetType, targetIndex)) {
                    moveCard(dragSource.type, dragSource.listIndex, targetType, targetIndex, dragSource.cardIndex);
                    playSound('drop');
                }
            }
        }

        function isValidMove(toType, toIndex) {
            const movingCard = (dragSource.type === 'waste') 
                ? waste[waste.length - 1] 
                : tableau[dragSource.listIndex][dragSource.cardIndex];

            if (toType === 'foundation' && dragSource.type === 'tableau') {
                if (dragSource.cardIndex !== tableau[dragSource.listIndex].length - 1) return false;
            }

            if (toType === 'foundation') {
                const pile = foundations[toIndex];
                if (pile.length === 0) {
                    return movingCard.rank === 1; 
                } else {
                    const top = pile[pile.length - 1];
                    return top.suit === movingCard.suit && top.rank === movingCard.rank - 1;
                }
            } else if (toType === 'tableau') {
                const col = tableau[toIndex];
                if (col.length === 0) {
                    return movingCard.rank === 13; 
                } else {
                    const top = col[col.length - 1];
                    const movingConfig = suitConfig[movingCard.suit];
                    const topConfig = suitConfig[top.suit];
                    return (movingConfig.color !== topConfig.color) && (top.rank === movingCard.rank + 1);
                }
            }
            return false;
        }

        function moveCard(fromType, fromIndex, toType, toIndex, cardIndexInList = null) {
            let cardsToMove = [];
            
            if (fromType === 'waste') {
                cardsToMove.push(waste.pop());
            } else if (fromType === 'tableau') {
                const col = tableau[fromIndex];
                cardsToMove = col.splice(cardIndexInList); 
                if (col.length > 0) {
                    col[col.length - 1].faceUp = true;
                }
            }

            if (toType === 'foundation') {
                foundations[toIndex].push(cardsToMove[0]);
            } else if (toType === 'tableau') {
                tableau[toIndex] = tableau[toIndex].concat(cardsToMove);
            }

            renderBoard();
        }

        function checkWin() {
            let total = 0;
            foundations.forEach(f => total += f.length);
            if(total === 52) {
                document.getElementById('win-modal').classList.remove('hidden');
            }
        }

        function newGame() {
            document.getElementById('win-modal').classList.add('hidden');
            initDeck();
            deal();
            renderBoard();
        }
        
        // Start Idle Timer on load
        resetIdleTimer();

        // Periodic Share Reminder
        setInterval(() => {
            const btn = document.getElementById('share-btn');
            if (btn) {
                btn.classList.add('animate-soft-pulse');
                setTimeout(() => btn.classList.remove('animate-soft-pulse'), 2000);
            }
        }, 45000); // Every 45 seconds

        newGame();

    </script>
</body>
</html>