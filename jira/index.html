<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="fav-generic.png">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Jira Solitaire: –ö–∞–Ω–±–∞–Ω-–ø–∞—Å—å—è–Ω—Å">
    <meta property="og:description" content="–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø—Ä–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤–æ–≤—Ä–µ–º—è. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —Ç–∏–∫–µ—Ç—ã, –∏–º–∏—Ç–∏—Ä—É–π –±—É—Ä–Ω—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ù–∞—á–∞–ª—å—Å—Ç–≤–æ –æ—Ü–µ–Ω–∏—Ç.">
    <meta property="og:image" content="https://gritsenko.biz/jira/cover.jpg">
    <meta property="og:url" content="https://gritsenko.biz/jira/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <title>Jira Board - Sprint 42</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F4F5F7; /* Jira background color */
            color: #172B4D;
            overflow: hidden;
            user-select: none;
        }

        /* Card (Ticket) Styling */
        .card {
            width: 130px;
            height: 170px;
            background-color: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9, 30, 66, 0.25);
            position: absolute;
            transition: box-shadow 0.2s;
            cursor: grab;
            display: flex;
            flex-direction: column;
            padding: 8px;
            box-sizing: border-box;
            font-size: 12px;
        }

        .card:hover {
            background-color: #EBECF0;
        }

        .card.dragging {
            cursor: grabbing;
            z-index: 1000 !important;
            box-shadow: 0 5px 10px rgba(9, 30, 66, 0.3);
            transform: scale(1.02);
        }

        /* Loading Skeleton (Card Back) */
        .card-back {
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #DFE1E6;
        }
        
        .skeleton-line {
            height: 8px;
            background-color: #EBECF0;
            border-radius: 4px;
            margin-bottom: 6px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .skeleton-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #EBECF0;
            align-self: flex-end;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Side border for priority */
        .priority-strip {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        /* Drop Zones */
        .slot {
            width: 130px;
            height: 170px;
            border: 2px dashed #DFE1E6;
            border-radius: 3px;
            position: relative;
            background-color: rgba(235, 236, 240, 0.3);
        }

        .foundation-slot::before {
            content: 'Done';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #A5ADBA;
            font-weight: bold;
        }
        
        .tableau-slot::before {
            content: 'Drop';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #A5ADBA;
            font-size: 10px;
        }

        /* Game Area Layout */
        #game-board {
            display: flex;
            padding: 20px;
            gap: 20px;
            height: calc(100vh - 60px);
        }

        .top-row {
            display: flex;
            gap: 24px; /* Increased gap */
            margin-bottom: 20px;
        }

        .stock-waste-area {
            display: flex;
            gap: 24px; /* Increased gap */
            min-width: 280px;
        }

        .foundations-area {
            display: flex;
            gap: 24px; /* Increased gap from 14px to 24px */
        }

        .tableau-area {
            display: flex;
            gap: 24px; /* Increased gap from 14px to 24px */
            position: relative;
            flex-grow: 1;
        }

        .column {
            width: 130px;
            position: relative;
            min-height: 400px;
        }
        
        /* Icons */
        .icon-sm { width: 14px; height: 14px; }
        .priority-icon {
            width: 20px;
            height: 20px;
        }
        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }

        /* Specific Colors */
        .bg-jira-blue { background-color: #0052CC; }
        .bg-jira-red { background-color: #FF5630; }
        .bg-jira-orange { background-color: #FFAB00; }
        .bg-jira-green { background-color: #36B37E; }
        .text-jira-gray { color: #5E6C84; }
        
        /* Sidebar Simulation */
        .sidebar-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #42526E;
            cursor: pointer;
        }
        .sidebar-item:hover { background-color: #EBECF0; }
        .sidebar-item.active { background-color: #DEEBFF; color: #0052CC; }
        
        /* SLA Panel */
        .sla-panel {
            margin-top: auto;
            border-top: 1px solid #DFE1E6;
            padding: 16px;
        }
        .sla-meter {
            height: 6px;
            background: #EBECF0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        .sla-fill {
            height: 100%;
            background: #36B37E;
            transition: width 0.3s ease;
        }

        /* Ticket Content */
        .ticket-id { font-size: 10px; color: #5E6C84; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;} /* Changed align-items to center */
        .ticket-summary { font-size: 11px; color: #172B4D; font-weight: 500; line-height: 1.4; flex-grow: 1; overflow: hidden; padding-right: 2px; }
        .ticket-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .story-points { 
            background: #DFE1E6; 
            /* Color removed here, setting dynamically */ 
            border-radius: 6px; 
            padding: 2px 8px; 
            font-size: 14px; /* Increased size */
            font-weight: 800; /* Extra Bold */
            min-width: 24px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #172B4D;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

    </style>
</head>
<body>

    <!-- Fake Navbar -->
    <nav class="h-[56px] bg-white border-b border-[#DFE1E6] flex items-center px-4 justify-between z-50 relative">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 font-bold text-[#0052CC] text-xl">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2H2v20h9V2zm2 0v20h9V2h-9z"/></svg>
                Jira Solitaire
            </div>
            <div class="hidden md:flex gap-4 text-sm font-medium text-[#42526E]">
                <span class="cursor-pointer hover:text-[#0052CC]">Your Work</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Projects</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Filters</span>
                <span class="cursor-pointer hover:text-[#0052CC]">Dashboards</span>
                <button onclick="newGame()" class="bg-[#0052CC] text-white px-3 py-1 rounded hover:bg-blue-700 transition">Create Sprint</button>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <div class="relative hidden sm:block">
                <input type="text" placeholder="Search" class="border border-[#DFE1E6] rounded px-2 py-1 text-sm w-40 focus:outline-none focus:border-[#0052CC]">
             </div>
             <!-- Share Button (Jira Style) -->
             <button onclick="shareGame()" class="flex items-center gap-2 text-[#42526E] hover:bg-[#EBECF0] px-2 py-1 rounded transition text-sm font-medium">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                 Share
             </button>
             <div class="w-8 h-8 rounded-full bg-[#0052CC] text-white flex items-center justify-center font-bold text-xs">ME</div>
        </div>
    </nav>

    <div class="flex h-full">
        <!-- Fake Sidebar -->
        <div class="w-[240px] bg-[#F4F5F7] border-r border-[#DFE1E6] hidden lg:flex flex-col h-[calc(100vh-56px)] pt-6">
            <div class="px-4 mb-4 flex items-center gap-3">
                <div class="w-8 h-8 bg-[#FF5630] rounded flex items-center justify-center text-white font-bold">P1</div>
                <div>
                    <div class="font-bold text-sm text-[#172B4D]">Project X</div>
                    <div class="text-xs text-[#5E6C84]">Software Project</div>
                </div>
            </div>
            <div class="sidebar-item active">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Board
            </div>
            <div class="sidebar-item">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                Backlog
            </div>
            <div class="mt-6 px-4 text-xs font-bold text-[#5E6C84] uppercase">Filters</div>
            <div class="sidebar-item">
                <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> My Issues
            </div>
             <div class="sidebar-item">
                <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Recently Updated
            </div>

            <!-- SLA Panel (New) -->
            <div class="sla-panel">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-[#42526E]">SLA STATUS</span>
                    <span id="sla-timer" class="text-xs font-bold text-[#0052CC]">ON TRACK</span>
                </div>
                <div class="text-[10px] text-[#5E6C84] mb-2">Issues Resolved: <span id="resolved-count">0</span>/52</div>
                <div class="sla-meter">
                    <div id="sla-bar" class="sla-fill" style="width: 0%"></div>
                </div>
                <div class="mt-4 flex gap-2">
                    <div class="flex-1 bg-white p-2 rounded border border-[#DFE1E6] text-center">
                        <div class="text-[10px] text-[#5E6C84]">Velocity</div>
                        <div class="text-xs font-bold text-[#172B4D]">High</div>
                    </div>
                    <div class="flex-1 bg-white p-2 rounded border border-[#DFE1E6] text-center">
                        <div class="text-[10px] text-[#5E6C84]">Bugs</div>
                        <div class="text-xs font-bold text-[#FF5630]">Critical</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Board -->
        <div class="flex-grow p-6 overflow-hidden relative" id="game-container">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-medium text-[#172B4D]">Sprint 42 Board</h1>
                <div class="text-sm text-[#5E6C84]">Double click foundation to auto-complete</div>
            </div>

            <!-- Top Area: Stock/Waste & Foundations -->
            <div class="top-row">
                <!-- Stock (Backlog) -->
                <div class="stock-waste-area">
                    <div>
                        <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase">Backlog</div>
                        <div id="stock" class="slot cursor-pointer flex items-center justify-center text-[#5E6C84] text-xs font-bold bg-white border border-[#DFE1E6]">
                            <div class="text-center">
                                <div>RELOAD</div>
                                <svg class="w-6 h-6 mx-auto mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase">Selected for Dev</div>
                        <div id="waste" class="slot"></div>
                    </div>
                </div>

                <!-- Spacer -->
                <div class="flex-grow"></div>

                <!-- Foundations (Done) -->
                <div class="foundations-area">
                    <div>
                         <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Blocker</div>
                         <div id="foundation-0" class="slot foundation-slot" data-suit="h"></div>
                    </div>
                    <div>
                         <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Critical</div>
                         <div id="foundation-1" class="slot foundation-slot" data-suit="d"></div>
                    </div>
                    <div>
                         <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Major</div>
                         <div id="foundation-2" class="slot foundation-slot" data-suit="s"></div>
                    </div>
                    <div>
                         <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase text-center">Minor</div>
                         <div id="foundation-3" class="slot foundation-slot" data-suit="c"></div>
                    </div>
                </div>
            </div>

            <!-- Tableau (Columns) -->
            <div>
                <div class="text-xs font-bold text-[#5E6C84] mb-2 uppercase">In Progress</div>
                <div class="tableau-area">
                    <div id="tableau-0" class="column"></div>
                    <div id="tableau-1" class="column"></div>
                    <div id="tableau-2" class="column"></div>
                    <div id="tableau-3" class="column"></div>
                    <div id="tableau-4" class="column"></div>
                    <div id="tableau-5" class="column"></div>
                    <div id="tableau-6" class="column"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[2000]">
        <div class="bg-white p-8 rounded-md shadow-lg text-center max-w-md w-full mx-4">
            <div class="text-6xl mb-4">üöÄ</div>
            <h2 class="text-2xl font-bold text-[#0052CC] mb-2">Sprint 42 Completed!</h2>
            <p class="text-[#172B4D] mb-6 font-medium text-lg">
                –§–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞! <br>
                <span class="text-sm font-normal text-[#5E6C84]">–í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–∫—Ä—ã—Ç—ã, –±–∞–≥–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–∏—Å—å –≤ —Ñ–∏—á–∏, –∞ –¥–µ–¥–ª–∞–π–Ω—ã —Å–æ–±–ª—é–¥–µ–Ω—ã (–ø–æ—á—Ç–∏). –í—ã –∑–∞—Å–ª—É–∂–∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø—Ä–µ–º–∏—é.</span>
            </p>
            
            <div class="flex flex-col gap-3">
                <button onclick="shareGame()" class="w-full bg-[#36B37E] text-white px-4 py-2 rounded font-bold hover:bg-green-700 transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —É—Å–ø–µ—Ö–æ–º
                </button>
                <button onclick="newGame()" class="w-full bg-[#0052CC] text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">
                    –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Å–ø—Ä–∏–Ω—Ç
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>

    <script>
        // --- Config & Data ---

        const suits = ['h', 'd', 's', 'c']; // Hearts, Diamonds, Spades, Clubs
        
        // Jira Icons (SVG Paths)
        const icons = {
            blocker: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#DE350B]"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`, // Actually Critical/Blocker mix style
            critical: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#FF7452]"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`, // High Voltage
            major: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#0052CC]"><path d="M7 14l5-5 5 5z"/></svg>`, // Arrow Up
            minor: `<svg viewBox="0 0 24 24" fill="currentColor" class="priority-icon text-[#00875A]"><path d="M7 10l5 5 5-5z"/></svg>`  // Arrow Down
        };

        // Unified colors for Solitaire gameplay (Red vs Blue)
        // Icons remain distinct colors, but strips and avatars follow the 2-color rule
        const suitConfig = {
            'h': { color: 'red', label: 'Blocker', svg: icons.blocker, strip: '#FF5630' },   // Red
            'd': { color: 'red', label: 'Critical', svg: icons.critical, strip: '#FF5630' },  // Red (was Orange-ish)
            's': { color: 'black', label: 'Major', svg: icons.major, strip: '#0052CC' },      // Blue
            'c': { color: 'black', label: 'Minor', svg: icons.minor, strip: '#0052CC' }       // Blue (was Green-ish)
        };

        const ranks = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];
        const rankLabels = {
            1: 'A', 11: 'J', 12: 'Q', 13: 'K'
        };
        const rankTitles = {
            1: 'Intern Task',
            11: 'Dev Task',
            12: 'QA Task',
            13: 'PO Task'
        };
        const avatarInitials = {
            11: 'JD', 12: 'QA', 13: 'PO', 1: 'IN'
        };
        // Removed static avatarColors, we will use suit colors now

        // Funny Jira-like summaries
        const summaries = [
            "Fix alignment in footer", "Update React dependency", "Meeting about meetings", 
            "Refactor legacy spaghetti", "Change button color", "Investigate slow query",
            "Write unit tests (maybe)", "Deploy to Prod", "Fix coffee machine",
            "Update documentation", "Center the div", "Resolve merge conflict",
            "Optimize images", "Fix mobile layout", "Update API schema",
            "Customer reported bug", "Feature flag cleanup", "Remove console.log",
            "Upgrade database", "Fix typo in header"
        ];

        let deck = [];
        let stock = [];
        let waste = [];
        let foundations = [[], [], [], []];
        let tableau = [[], [], [], [], [], [], []];

        // Drag State
        let dragSource = null; // { type: 'waste' | 'tableau' | 'foundation', index: int, cardIndex: int }
        let draggedCards = []; // Array of DOM elements
        let dragStartPos = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };

        // --- Sharing Logic ---
        
        function shareGame() {
            const url = "https://gritsenko.biz/jira/";
            const text = "–Ø –∑–∞–∫—Ä—ã–ª —Å–ø—Ä–∏–Ω—Ç –≤ Jira Solitaire! –ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã: ";
            
            // Try to copy to clipboard
            // Fallback for older browsers or if navigator.clipboard is blocked
            const textArea = document.createElement("textarea");
            textArea.value = url;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast("–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- Game Logic ---

        function initDeck() {
            deck = [];
            suits.forEach(suit => {
                ranks.forEach(rank => {
                    deck.push({
                        suit: suit,
                        rank: rank,
                        id: `PROJ-${Math.floor(Math.random() * 9000) + 1000}`,
                        summary: summaries[Math.floor(Math.random() * summaries.length)],
                        faceUp: false
                    });
                });
            });
            shuffle(deck);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function deal() {
            stock = [...deck];
            waste = [];
            foundations = [[], [], [], []];
            tableau = [[], [], [], [], [], [], []];

            for (let i = 0; i < 7; i++) {
                for (let j = i; j < 7; j++) {
                    let card = stock.pop();
                    if (i === j) card.faceUp = true;
                    tableau[j].push(card);
                }
            }
        }

        // --- DOM Creation ---

        function createCardElement(card) {
            const el = document.createElement('div');
            
            if (!card.faceUp) {
                el.className = 'card card-back';
                el.innerHTML = `
                    <div style="padding: 10px;">
                        <div class="skeleton-line" style="width: 30%;"></div>
                        <div class="skeleton-line" style="width: 80%;"></div>
                        <div class="skeleton-line" style="width: 60%;"></div>
                    </div>
                    <div style="padding: 10px; display:flex; justify-content: flex-end;">
                        <div class="skeleton-avatar"></div>
                    </div>
                `;
                return el;
            }

            const config = suitConfig[card.suit];
            const rankLabel = rankLabels[card.rank] || card.rank;
            const isFace = card.rank > 10 || card.rank === 1;
            
            // Updated Avatar Logic: 
            // 1. Always use suit color for background to make Priority visible
            // 2. Use 'PM' for non-face cards
            const avatarColor = config.strip; 
            const avatarTextColor = 'white';
            const initials = isFace ? avatarInitials[card.rank] : 'PM';
            
            // Use the strip color (Red/Blue) for the rank text as well
            const rankColor = config.strip;
            
            el.className = 'card';
            el.setAttribute('data-suit', card.suit);
            el.setAttribute('data-rank', card.rank);
            el.setAttribute('data-color', config.color);

            el.innerHTML = `
                <div class="priority-strip" style="background-color: ${config.strip}"></div>
                <div class="pl-2 h-full flex flex-col">
                    <div class="ticket-id">
                        <span>${card.id}</span>
                        <!-- Rank (Story Points) moved to header for visibility in stacks -->
                        <div class="story-points" title="Story Points" style="color: ${rankColor}">${rankLabel}</div>
                    </div>
                    <div class="ticket-summary">
                        ${card.summary}
                    </div>
                    <div class="ticket-footer">
                        <!-- Priority Icon moved to footer -->
                        <span title="${config.label}">${config.svg}</span>
                        <div class="avatar" style="background-color: ${avatarColor}; color: ${avatarTextColor}">${initials}</div>
                    </div>
                </div>
            `;
            return el;
        }

        // --- Rendering ---

        function renderBoard() {
            // Update SLA Panel
            updateStats();

            // Render Stock
            const stockEl = document.getElementById('stock');
            stockEl.innerHTML = '';
            if (stock.length > 0) {
                // Show a card back
                const cardBack = document.createElement('div');
                cardBack.className = 'card card-back';
                cardBack.style.position = 'relative';
                cardBack.style.top = '0';
                cardBack.style.left = '0';
                cardBack.innerHTML = `<div style="padding: 10px;"><div class="skeleton-line" style="width:50%"></div></div>`;
                stockEl.appendChild(cardBack);
                stockEl.onclick = drawCard;
            } else {
                // Empty stock symbol
                stockEl.innerHTML = `
                    <div class="text-center">
                        <div>RELOAD</div>
                        <svg class="w-6 h-6 mx-auto mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </div>`;
                stockEl.onclick = resetStock;
            }

            // Render Waste
            const wasteEl = document.getElementById('waste');
            wasteEl.innerHTML = '';
            if (waste.length > 0) {
                const card = waste[waste.length - 1];
                const cardEl = createCardElement(card);
                makeDraggable(cardEl, 'waste', waste.length - 1);
                wasteEl.appendChild(cardEl);
            }

            // Render Foundations
            foundations.forEach((pile, index) => {
                const container = document.getElementById(`foundation-${index}`);
                container.innerHTML = '';
                if (pile.length > 0) {
                    const card = pile[pile.length - 1];
                    const cardEl = createCardElement(card);
                    // Disable dragging from foundation for simplicity in this version, or enable if desired
                    // makeDraggable(cardEl, 'foundation', index); 
                    container.appendChild(cardEl);
                }
            });

            // Render Tableau
            tableau.forEach((col, colIndex) => {
                const container = document.getElementById(`tableau-${colIndex}`);
                container.innerHTML = '';
                
                col.forEach((card, cardIndex) => {
                    const cardEl = createCardElement(card);
                    // Increased spacing from 30px to 40px for better visibility
                    cardEl.style.top = `${cardIndex * 40}px`; 
                    
                    if (card.faceUp) {
                        makeDraggable(cardEl, 'tableau', colIndex, cardIndex);
                    }
                    
                    container.appendChild(cardEl);
                });
            });

            checkWin();
        }

        // --- Stats & SLA ---
        
        function updateStats() {
            let totalDone = 0;
            foundations.forEach(f => totalDone += f.length);
            
            document.getElementById('resolved-count').innerText = totalDone;
            
            const percent = (totalDone / 52) * 100;
            document.getElementById('sla-bar').style.width = `${percent}%`;
            
            // Change SLA status text based on progress
            const slaText = document.getElementById('sla-timer');
            if(percent === 100) {
                slaText.innerText = "SPRINT DONE";
                slaText.style.color = "#36B37E";
            } else if (percent > 50) {
                 slaText.innerText = "ON TRACK";
                 slaText.style.color = "#0052CC";
            } else {
                 slaText.innerText = "AT RISK";
                 slaText.style.color = "#FF5630";
            }
        }

        // --- Interaction ---

        function drawCard() {
            if (stock.length > 0) {
                const card = stock.pop();
                card.faceUp = true;
                waste.push(card);
                renderBoard();
            }
        }

        function resetStock() {
            if (stock.length === 0 && waste.length > 0) {
                stock = waste.reverse().map(c => { c.faceUp = false; return c; });
                waste = [];
                renderBoard();
            }
        }

        function makeDraggable(el, type, listIndex, cardIndexInList = null) {
            el.onmousedown = function(e) {
                if(e.button !== 0) return; // Left click only
                e.preventDefault();

                dragSource = { type, listIndex, cardIndex: cardIndexInList };
                
                // Identify elements to hide (original cards being dragged)
                const hiddenElements = [];
                hiddenElements.push(el);
                
                // If Tableau, we might be dragging a stack, so hide siblings underneath (visually on top)
                if (type === 'tableau') {
                    let sibling = el.nextElementSibling;
                    while(sibling) {
                        hiddenElements.push(sibling);
                        sibling = sibling.nextElementSibling;
                    }
                }
                
                // Hide originals immediately
                hiddenElements.forEach(elem => elem.style.opacity = '0');

                // If Tableau, we might be dragging a stack
                draggedCards = [];
                let cardsData = [];

                if (type === 'tableau') {
                    const col = tableau[listIndex];
                    // Get all cards from cardIndex to end
                    for(let i = cardIndexInList; i < col.length; i++) {
                        cardsData.push(col[i]);
                    }
                } else if (type === 'waste') {
                    cardsData.push(waste[listIndex]);
                }

                // Create visual clones
                const container = document.getElementById('game-container');
                const rect = el.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };

                dragStartPos = {
                    x: rect.left - containerRect.left,
                    y: rect.top - containerRect.top
                };

                cardsData.forEach((c, i) => {
                    const clone = createCardElement(c);
                    clone.classList.add('dragging');
                    clone.style.left = (dragStartPos.x) + 'px';
                    // Match spacing in drag preview
                    clone.style.top = (dragStartPos.y + (i * 40)) + 'px'; 
                    clone.style.pointerEvents = 'none'; // Pass through events to underlay
                    container.appendChild(clone);
                    draggedCards.push(clone);
                });

                // Helper for moving
                function moveAt(pageX, pageY) {
                    const containerRect = container.getBoundingClientRect();
                    const x = pageX - containerRect.left - dragOffset.x;
                    const y = pageY - containerRect.top - dragOffset.y;
                    
                    draggedCards.forEach((cardEl, i) => {
                        cardEl.style.left = x + 'px';
                        // Match spacing in drag movement
                        cardEl.style.top = (y + (i * 40)) + 'px';
                    });
                }

                function onMouseMove(e) {
                    moveAt(e.clientX, e.clientY);
                }

                function onMouseUp(e) {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    // Check drop
                    handleDrop(e.clientX, e.clientY);

                    // Remove visual clones
                    draggedCards.forEach(c => c.remove());
                    draggedCards = [];
                    dragSource = null;
                    
                    // Show originals again.
                    // If the move was successful, renderBoard() has already replaced these elements, 
                    // so this affects detached nodes (harmless).
                    // If the move was invalid, this restores the card visibility at the source.
                    hiddenElements.forEach(elem => elem.style.opacity = '1');
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };
            
            // Auto-move on double click
            el.ondblclick = function(e) {
                e.stopPropagation();
                // Simple auto move to foundation logic
                let card;
                if(type === 'waste') card = waste[waste.length-1];
                if(type === 'tableau') card = tableau[listIndex][tableau[listIndex].length-1];
                if(type === 'tableau' && cardIndexInList !== tableau[listIndex].length-1) return; // Can only double click top card

                if(card) {
                    // Find suitable foundation
                    for(let i=0; i<4; i++) {
                        const pile = foundations[i];
                        if(pile.length === 0) {
                            if(card.rank === 1) { // Ace
                                moveCard(type, listIndex, 'foundation', i);
                                return;
                            }
                        } else {
                            const top = pile[pile.length-1];
                            if(top.suit === card.suit && top.rank === card.rank - 1) {
                                moveCard(type, listIndex, 'foundation', i);
                                return;
                            }
                        }
                    }
                }
            }
        }

        function handleDrop(x, y) {
            // Hide clones momentarily to find element below
            draggedCards.forEach(c => c.style.display = 'none');
            let elemBelow = document.elementFromPoint(x, y);
            draggedCards.forEach(c => c.style.display = 'block');

            if (!elemBelow) return;

            // Find closest slot
            const slot = elemBelow.closest('.column') || elemBelow.closest('.foundation-slot');
            if (!slot) return;

            // Identify Target
            let targetType = null;
            let targetIndex = null;

            if (slot.id.startsWith('tableau')) {
                targetType = 'tableau';
                targetIndex = parseInt(slot.id.split('-')[1]);
            } else if (slot.id.startsWith('foundation')) {
                targetType = 'foundation';
                targetIndex = parseInt(slot.id.split('-')[1]);
            }

            if (targetType) {
                if(isValidMove(targetType, targetIndex)) {
                    moveCard(dragSource.type, dragSource.listIndex, targetType, targetIndex, dragSource.cardIndex);
                }
            }
        }

        function isValidMove(toType, toIndex) {
            const movingCard = (dragSource.type === 'waste') 
                ? waste[waste.length - 1] 
                : tableau[dragSource.listIndex][dragSource.cardIndex];

            // Can't move stack to foundation
            if (toType === 'foundation' && dragSource.type === 'tableau') {
                if (dragSource.cardIndex !== tableau[dragSource.listIndex].length - 1) return false;
            }

            if (toType === 'foundation') {
                const pile = foundations[toIndex];
                if (pile.length === 0) {
                    return movingCard.rank === 1; // Must be Ace
                } else {
                    const top = pile[pile.length - 1];
                    return top.suit === movingCard.suit && top.rank === movingCard.rank - 1;
                }
            } else if (toType === 'tableau') {
                const col = tableau[toIndex];
                if (col.length === 0) {
                    return movingCard.rank === 13; // King (PO) for empty column
                } else {
                    const top = col[col.length - 1];
                    const movingConfig = suitConfig[movingCard.suit];
                    const topConfig = suitConfig[top.suit];
                    
                    // Solitaire Rule: Alternating colors, Descending rank
                    return (movingConfig.color !== topConfig.color) && (top.rank === movingCard.rank + 1);
                }
            }
            return false;
        }

        function moveCard(fromType, fromIndex, toType, toIndex, cardIndexInList = null) {
            let cardsToMove = [];
            
            // Extract Cards
            if (fromType === 'waste') {
                cardsToMove.push(waste.pop());
            } else if (fromType === 'tableau') {
                const col = tableau[fromIndex];
                cardsToMove = col.splice(cardIndexInList); // remove from here to end
                
                // Reveal new top card if exists
                if (col.length > 0) {
                    col[col.length - 1].faceUp = true;
                }
            }

            // Insert Cards
            if (toType === 'foundation') {
                foundations[toIndex].push(cardsToMove[0]);
            } else if (toType === 'tableau') {
                tableau[toIndex] = tableau[toIndex].concat(cardsToMove);
            }

            renderBoard();
        }

        function checkWin() {
            let total = 0;
            foundations.forEach(f => total += f.length);
            if(total === 52) {
                document.getElementById('win-modal').classList.remove('hidden');
            }
        }

        function newGame() {
            document.getElementById('win-modal').classList.add('hidden');
            initDeck();
            deal();
            renderBoard();
        }

        // Start
        newGame();

    </script>
</body>
</html>